<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> watermint.org &middot; Takayuki Okazaki's note </title> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/watermint-logo.png"> <link rel="shortcut icon" href="/public/watermint-logo.png"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <style>*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:serif;font-size:14px;line-height:1.8}@media(min-width:38em){html{font-size:20px}}body{color:#515151;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a strong{color:inherit}a:hover,a:focus{text-decoration:underline}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:bold;line-height:1.25;color:#313131;text-rendering:optimizeLegibility}h1{font-size:1.5rem;margin-top:1.6rem;margin-bottom:1.6rem}h2{margin-top:1.6rem;font-size:1.3rem}h3{margin-top:1.6rem;font-size:1.2rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}strong{color:#303030}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:bold}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:bold;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}code,pre{font-family:Menlo,Monaco,"Courier New",monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}.gist .gist-file{font-family:Menlo,Monaco,"Courier New",monospace!important}.gist .markdown-body{padding:15px}.gist pre{padding:0;background-color:transparent}.gist .gist-file .gist-data{font-size:.8rem!important;line-height:1.4}.gist code{padding:0;color:inherit;background-color:transparent;border-radius:0}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media(min-width:30em){blockquote{padding-right:5rem;padding-left:1.25rem}}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;border:1px solid #e5e5e5;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #e5e5e5}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#f9f9f9}.lead{font-size:1.25rem;font-weight:300}.message{margin-bottom:1rem;padding:1rem;color:#717171;background-color:#f9f9f9}.container{max-width:38rem;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.post-tags{display:block;margin-top:-.5rem;margin-bottom:1rem;text-align:right}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:"PT Sans",Helvetica,Arial,sans-serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}html,body{overflow-x:hidden;line-height:1.9em}html{font-family:serif}h1,h2,h3,h4,h5,h6{font-weight:400;color:#313131}.wrap{position:relative;width:100%}.container{max-width:28rem}@media(min-width:38em){.container{max-width:32rem}}@media(min-width:56em){.container{max-width:38rem}}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem;border-bottom:1px solid #eee}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}@media(max-width:48em){.masthead-title{text-align:center}.masthead-title small{display:none}}.sidebar{position:fixed;top:0;bottom:0;left:-14rem;width:14rem;visibility:hidden;overflow-y:auto;font-family:serif;font-size:.875rem;line-height:1.4em;color:rgba(255,255,255,.6);background-color:#202020;-webkit-transition:all .3s ease-in-out;transition:all .3s ease-in-out}
@media(min-width:30em){.sidebar{font-size:.75rem}}.sidebar a{font-weight:normal;color:#fff}.sidebar-item{padding:1rem}.sidebar-item p:last-child{margin-bottom:0}.sidebar-nav{border-bottom:1px solid rgba(255,255,255,.1)}.sidebar-nav-item{display:block;padding:.5rem 1rem;border-top:1px solid rgba(255,255,255,.1)}.sidebar-nav-item.active,a.sidebar-nav-item:hover,a.sidebar-nav-item:focus{text-decoration:none;background-color:rgba(255,255,255,.1);border-color:transparent}@media(min-width:48em){.sidebar-item{padding:1.5rem}.sidebar-nav-item{padding-left:1.5rem;padding-right:1.5rem}}.sidebar-checkbox{position:absolute;opacity:0;-webkit-user-select:none;-moz-user-select:none;user-select:none}.sidebar-toggle{position:absolute;top:.8rem;left:1rem;display:block;padding:.25rem .75rem;color:#555;border-radius:.25rem;cursor:pointer}.sidebar-toggle:before{display:inline-block;width:1rem;height:.75rem;content:"";background-image:-webkit-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-moz-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-ms-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%)}.sidebar-toggle:active,#sidebar-checkbox:focus ~ .sidebar-toggle,#sidebar-checkbox:checked ~ .sidebar-toggle{color:#fff}.sidebar-toggle:active:before,#sidebar-checkbox:focus ~ .sidebar-toggle:before,#sidebar-checkbox:checked ~ .sidebar-toggle:before{background-image:-webkit-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-moz-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-ms-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%)}@media(min-width:30.1em){.sidebar-toggle{position:fixed}}@media print{.sidebar-toggle{display:none}}.wrap,.sidebar,.sidebar-toggle{-webkit-backface-visibility:hidden;-ms-backface-visibility:hidden;backface-visibility:hidden}.wrap,.sidebar-toggle{-webkit-transition:-webkit-transform .3s ease-in-out;transition:transform .3s ease-in-out}#sidebar-checkbox:checked+.sidebar{z-index:10;visibility:visible}#sidebar-checkbox:checked ~ .sidebar,#sidebar-checkbox:checked ~ .wrap,#sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(14rem);-ms-transform:translateX(14rem);transform:translateX(14rem)}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}.layout-reverse .sidebar{left:auto;right:-14rem}.layout-reverse .sidebar-toggle{left:auto;right:1rem}.layout-reverse #sidebar-checkbox:checked ~ .sidebar,.layout-reverse #sidebar-checkbox:checked ~ .wrap,.layout-reverse #sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(-14rem);-ms-transform:translateX(-14rem);transform:translateX(-14rem)}.theme-base-08 .sidebar,.theme-base-08 .sidebar-toggle:active,.theme-base-08 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#ac4142}.theme-base-08 .container a,.theme-base-08 .sidebar-toggle,.theme-base-08 .related-posts li a:hover{color:#ac4142}.theme-base-09 .sidebar,.theme-base-09 .sidebar-toggle:active,.theme-base-09 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#d28445}.theme-base-09 .container a,.theme-base-09 .sidebar-toggle,.theme-base-09 .related-posts li a:hover{color:#d28445}.theme-base-0a .sidebar,.theme-base-0a .sidebar-toggle:active,.theme-base-0a #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#f4bf75}
.theme-base-0a .container a,.theme-base-0a .sidebar-toggle,.theme-base-0a .related-posts li a:hover{color:#f4bf75}.theme-base-0b .sidebar,.theme-base-0b .sidebar-toggle:active,.theme-base-0b #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#90a959}.theme-base-0b .container a,.theme-base-0b .sidebar-toggle,.theme-base-0b .related-posts li a:hover{color:#90a959}.theme-base-0c .sidebar,.theme-base-0c .sidebar-toggle:active,.theme-base-0c #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#75b5aa}.theme-base-0c .container a,.theme-base-0c .sidebar-toggle,.theme-base-0c .related-posts li a:hover{color:#75b5aa}.theme-base-0d .sidebar,.theme-base-0d .sidebar-toggle:active,.theme-base-0d #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#6a9fb5}.theme-base-0d .container a,.theme-base-0d .sidebar-toggle,.theme-base-0d .related-posts li a:hover{color:#6a9fb5}.theme-base-0e .sidebar,.theme-base-0e .sidebar-toggle:active,.theme-base-0e #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#aa759f}.theme-base-0e .container a,.theme-base-0e .sidebar-toggle,.theme-base-0e .related-posts li a:hover{color:#aa759f}.theme-base-0f .sidebar,.theme-base-0f .sidebar-toggle:active,.theme-base-0f #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#8f5536}.theme-base-0f .container a,.theme-base-0f .sidebar-toggle,.theme-base-0f .related-posts li a:hover{color:#8f5536}.sidebar-overlay #sidebar-checkbox:checked ~ .wrap{-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0)}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar-toggle{box-shadow:0 0 0 .25rem #fff}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:.25rem 0 .5rem rgba(0,0,0,.1)}.layout-reverse.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:-.25rem 0 .5rem rgba(0,0,0,.1)}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight,.highlight .w{color:#586e75}.highlight .err{color:#002b36;background-color:#dc322f}.highlight .c,.highlight .cd,.highlight .cm,.highlight .c1,.highlight .cs{color:#657b83}.highlight .cp{color:#b58900}.highlight .nt{color:#b58900}.highlight .o,.highlight .ow{color:#93a1a1}.highlight .p,.highlight .pi{color:#93a1a1}.highlight .gi{color:#859900}.highlight .gd{color:#dc322f}.highlight .gh{color:#268bd2;background-color:#002b36;font-weight:bold}.highlight .k,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .kv{color:#6c71c4}.highlight .kc{color:#cb4b16}.highlight .kt{color:#cb4b16}.highlight .kd{color:#cb4b16}.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .sh,.highlight .sx,.highlight .s1{color:#859900}.highlight .sr{color:#2aa198}.highlight .si{color:#d33682}.highlight .se{color:#d33682}.highlight .nn{color:#b58900}.highlight .nc{color:#b58900}.highlight .no{color:#b58900}.highlight .na{color:#268bd2}.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .il,.highlight .mo,.highlight .mb,.highlight .mx{color:#859900}.highlight .ss{color:#859900}.copyright{font-size:.8em;font-style:italic;color:#555}</style> </head> <body class="theme-base-09"> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"> <div class="sidebar" id="sidebar"> <div class="sidebar-item"> <p>Travel, camera, photo, and technical things. I work at Dropbox. Thoughts are my own.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Archive</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> <a class="sidebar-nav-item" href="/atom.xml">Feed</a> <a class="sidebar-nav-item" href="https://github.com/watermint">Github</a> </nav> <div class="sidebar-item"> <p> &copy; 2005-2022 Takayuki Okazaki </p> </div> </div> <div class="wrap"> <div class="masthead"> <div class="container"> <h3 class="masthead-title"> <a href="/" title="Home">watermint.org</a> <small>- Takayuki Okazaki's note</small> </h3> </div> </div> <div class="container content"> <div class="posts"> <div class="post"> <h1 class="post-title"> <a href="/2016/12/15/go-bandwidth-limit-for-multilpe-io/"> Go: 複数のReader/Writerに対する帯域幅制御 </a> </h1> <span class="post-date"> 15th December 2016</span> <span class="post-tags"> #<a href="/tags/bandwidth">bandwidth</a> #<a href="/tags/concurrency">concurrency</a> #<a href="/tags/go">go</a> </span> <p>ネットワークやディスクへの読み書き処理の際、帯域幅制御をしたい場合があります。低優先度の処理などによって主となるビジネスロジックが阻害されないよう制御するといった目的や、一つのサーバ資源で複数のサービスを提供するときに一つのサービスが資源を消費しすぎないようにしたいといった目的があります。</p> <p>Goでこのような処理を書きたいとき、ざっと調べてみたところ<a href="https://github.com/mxk/go-flowrate">go-flowrate</a>という実装が見つかりました。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data.dat"</span><span class="p">)</span>

    <span class="c">// 100バイト/秒の帯域幅制御付きのラッパーをつくる</span>
    <span class="n">f2</span> <span class="o">:=</span> <span class="n">flowrate</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>

    <span class="c">// 実際の処理</span>
    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre></div></div> <p>使い方もシンプルできっちり制御できるのでこれでいいのですが、制御できるのが一つの<code class="language-plaintext highlighter-rouge">io.Reader</code>または<code class="language-plaintext highlighter-rouge">io.Writer</code>のみに対してのみ可能で、複数の<code class="language-plaintext highlighter-rouge">io.Reader</code>や<code class="language-plaintext highlighter-rouge">io.Writer</code>に対しては制御することができません。</p> <p>並列処理が必要なプログラムを書いているとちょっとこれではそのまま使えそうにありません。もう少しほかの選択肢を探してもよいのですが、ちょうどいいGoのプログラミング課題ということで新しく実装してみることにしました。</p> <h1 id="出来上がり">出来上がり</h1> <p>まずはでき上がったライブラリを紹介します。<a href="https://github.com/watermint/bwlimit">bwlimit</a>としてGithub上に公開してあります。利用例は次のようなイメージです。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// 100バイト/秒に制限</span>
    <span class="n">bwlimit</span> <span class="o">:=</span> <span class="n">NewBwlimit</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="no">false</span><span class="p">)</span>

    <span class="c">// 複数のReader</span>
    <span class="n">f1</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data1.dat"</span><span class="p">)</span>
    <span class="n">f2</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data2.dat"</span><span class="p">)</span>

    <span class="c">// ラッパーを作成</span>
    <span class="n">fr1</span> <span class="o">:=</span> <span class="n">bwlimit</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
    <span class="n">fr2</span> <span class="o">:=</span> <span class="n">bwlimit</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>

    <span class="c">// 実際の処理</span>
    <span class="c">// ...</span>

    <span class="c">// すべてのReaderがClose()されるかEOFになるまで待機</span>
    <span class="n">bwlimit</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div> <p>まずは帯域幅制御を制御するオブジェクト(上図では<code class="language-plaintext highlighter-rouge">bwlimit</code>)を作り、さらにそれぞれラッパーを作成します。<code class="language-plaintext highlighter-rouge">NewBwlimit</code>の第二引数は帯域幅制限しているときRead/Write処理を待たせるかどうかです。</p> <p>あとはラッパーを普通の<code class="language-plaintext highlighter-rouge">io.Reader</code>として扱うだけです。並列処理をしていて、すべてのReaderまたはWriterについて処理が完了したかどうか知りたくなったので待機する<code class="language-plaintext highlighter-rouge">Wait()</code>もつくりました。</p> <h1 id="仕組み">仕組み</h1> <p>キューを作る方法などいくつか実装方法を検討しましたが最終的にはかなりシンプルな構造になりました。トヨタ生産方式の本を思い出してヒントを得ました。</p> <p><a href="https://ja.wikipedia.org/wiki/%E3%82%BF%E3%82%AF%E3%83%88%E3%82%BF%E3%82%A4%E3%83%A0">タクトタイム</a>という一定時間のリズムを刻んで、各拍子のタイミングで利用可能な帯域を現在有効なReader/Writerで分割して利用するアイデアです。</p> <p>たとえばタクトタイムを1秒間に10回に設定したとします。帯域幅設定を1000バイト/秒にした場合、タクトタイム1回あたりに利用可能な帯域幅は100バイトです。有効なReaderが2つであればこの100バイトをわけあって、50バイトずつの読み取りを許可する枠を設定します。実際に、Reader側が読み取るかどうかはわかりませんが、読み取り可能な上限を制御することでこのような流量制御を行っています。</p> <h1 id="流量制御と障害防止">流量制御と障害防止</h1> <p>あるタクトタイムのときに、読み取りが実際に発生せず50バイト分の枠がまるまるある状態で、次のタクトタイムになったとき読み取り可能枠を50 + 50バイト分にはしないようにしました。流量はこれによってすこし減ってしまいますが、意図しない障害を防ぐためです。</p> <p>読み取り可能枠が溜まりにたまって一気に転送が行われてしまうと、他のサービスへ影響がでることはもちろん、場合によってはルーターなどのバッファサイズを超えるなどして障害が発生することも考えられます。</p> <h1 id="利用例">利用例</h1> <p>また別の記事として各予定ですが、Dropboxへのファイルアップローダーをいま作っています。このファイルアップローダーで並列してファイルのアップロードをする際に、帯域幅制御をつけたかったのがこのライブラリ作成のモチベーションです。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2016/12/14/dmg-and-cli-en/"> Disk image file (.dmg) from command line </a> </h1> <span class="post-date"> 14th December 2016</span> <span class="post-tags"> #<a href="/tags/cli">cli</a> #<a href="/tags/dmg">dmg</a> #<a href="/tags/hdiutil">hdiutil</a> #<a href="/tags/keychain">keychain</a> #<a href="/tags/mac">mac</a> #<a href="/tags/security">security</a> </span> <p>I prefer .dmg instaed of zip for archiving project data, etc. <code class="language-plaintext highlighter-rouge">.dmg</code> is handy for refering files, modify contents without extract files to somewhere.</p> <p><code class="language-plaintext highlighter-rouge">.dmg</code> can usable as like USB drive. Disk Utility tool can create/update <code class="language-plaintext highlighter-rouge">.dmg</code> from folder with various options. Options are like encryption, readonly, compression, etc.</p> <p>But if you have tens of folders to archive, it’s better to use command line tools.</p> <h2 id="create-encrypted-dmg-file">Create encrypted <code class="language-plaintext highlighter-rouge">.dmg</code> file</h2> <p><code class="language-plaintext highlighter-rouge">hdiutil</code> is command line version of Disk Utility app. This command can mount/unmount/create/update disk image files. Please see <code class="language-plaintext highlighter-rouge">man hdiutil</code> for more detail.</p> <p>Below script is part of my workflow of archiving project files. I’m using encrypted <code class="language-plaintext highlighter-rouge">.dmg</code> for archive. The script require prepare password file under <code class="language-plaintext highlighter-rouge">$HOME/.dmg-password</code>. Please create and store password for <code class="language-plaintext highlighter-rouge">.dmg</code> without LF.</p> <p>And update permission like <code class="language-plaintext highlighter-rouge">chmod 600 $HOME/.dmg-password</code> to prevent read from other users. This sequence using password and encryption. But it’s not strong enough, reason described below.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span><span class="nt">-lt</span> 2 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="nv">$0</span> SRC_DIR DEST_DIR
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">SRC</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">DST</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">PWD</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/.dmg-password"</span>

<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-e</span> <span class="nv">$PWD</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo </span>Disk Image password not found
  <span class="nb">exit </span>2
<span class="k">fi

for </span>t <span class="k">in</span> <span class="s2">"</span><span class="nv">$SRC</span><span class="s2">"</span>/<span class="k">*</span><span class="p">;</span> <span class="k">do
  if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$t</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo </span>Creating: <span class="nv">$t</span>
    <span class="nv">n</span><span class="o">=</span><span class="si">$(</span><span class="nb">basename</span> <span class="nv">$t</span><span class="si">)</span>
    <span class="nb">cat</span> <span class="nv">$PWD</span> |                <span class="se">\</span>
      hdiutil create          <span class="se">\</span>
        <span class="nt">-srcfolder</span> <span class="s2">"</span><span class="nv">$t</span><span class="s2">"</span>       <span class="se">\</span>
        <span class="nt">-fs</span> HFS+              <span class="se">\</span>
        <span class="nt">-encryption</span> AES-128   <span class="se">\</span>
        <span class="nt">-format</span> UDBZ          <span class="se">\</span>
        <span class="nt">-stdinpass</span>            <span class="se">\</span>
        <span class="s2">"</span><span class="nv">$DST</span><span class="s2">/</span><span class="nv">$n</span><span class="s2">.dmg"</span>
  <span class="k">fi
done</span>
</code></pre></div></div> <h2 id="preset-password-for-dmg-in-key-chain">Preset password for <code class="language-plaintext highlighter-rouge">.dmg</code> in Key Chain</h2> <p>It’s kind of pain in neck entering password for opening <code class="language-plaintext highlighter-rouge">.dmg</code> everytime. If you open <code class="language-plaintext highlighter-rouge">.dmg</code> from Finder.app, the password dialog refuse copy &amp; paste operation.</p> <p><img src="/images/2016-12-13-dmg1.png" alt="Password dialog"/></p> <p>There is option “remember password in my keychain”. Concept is similar to this.</p> <p>The password for disk image is stored in keychain which identified by UUID of <code class="language-plaintext highlighter-rouge">.dmg</code>. The UUID is referable by command like below.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>hdiutil isencrypted YOURDISKIMAGE.dmg
</code></pre></div></div> <p>Now you can store password through <code class="language-plaintext highlighter-rouge">security</code> command.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>security add-generic-password <span class="nt">-a</span> <span class="o">(</span>UUID above<span class="o">)</span> <span class="nt">-D</span> <span class="s2">"disk image password"</span> <span class="nt">-s</span> <span class="o">(</span>YOUR DISK IMAGE<span class="o">)</span>.dmg <span class="nt">-w</span> <span class="o">(</span>PASSWORD OF DISK IMAGE<span class="o">)</span>
</code></pre></div></div> <p>Unfortunatelly, there are no option like <code class="language-plaintext highlighter-rouge">-stdinpass</code>. So the password must be passed through command line argument. This mean optential leak through <code class="language-plaintext highlighter-rouge">ps</code> command or shell history.</p> <p>By the way, I’m using below script for preset password to disk images.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/sh

if [ $# -lt 1 ]; then
  echo $0 [dmg file]...
  exit 1
fi

PWD=$HOME/.dmg-password

for FILE in "$@"; do
  UUID=$(hdiutil isencrypted "$FILE" 2&gt;&amp;1 | grep uuid | awk '{print $2}')
  BASE=$(basename $FILE)

  echo File: $BASE
  echo UUID: $UUID

  security add-generic-password -a $UUID -D "disk image password" -s $BASE -w $(cat $PWD)
done
</code></pre></div></div> <p>When opening <code class="language-plaintext highlighter-rouge">.dmg</code> from Finder, operating system ask authorisation of using password by <code class="language-plaintext highlighter-rouge">diskimages-helper</code>.</p> <p><img src="/images/2016-12-13-dmg2.png" alt="Confirmation dialog"/></p> <p>You can skip this dialog by <code class="language-plaintext highlighter-rouge">-A</code> option of <code class="language-plaintext highlighter-rouge">security</code> command, but this option authorise for all applications. It’s better not use this <code class="language-plaintext highlighter-rouge">-A</code> option for better security.</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2016/12/13/dmg-and-cli/"> ディスクイメージファイル(.dmg)をコマンドラインから </a> </h1> <span class="post-date"> 13th December 2016</span> <span class="post-tags"> #<a href="/tags/cli">cli</a> #<a href="/tags/dmg">dmg</a> #<a href="/tags/hdiutil">hdiutil</a> #<a href="/tags/keychain">keychain</a> #<a href="/tags/mac">mac</a> #<a href="/tags/security">security</a> </span> <p>Macでたくさんのファイルをひとまとめにするのであればzipで圧縮するよりも、ディスクイメージファイルにしたほうが便利なこともあります。zipだと標準では中身を確認するのに毎回どこかに展開しないといけないですし、ファイルの内容を変更するのも面倒です。zip用のツールを使えばおそらくそれらも解決できると思いますが、個人的にはディスクイメージファイル(.dmg)を使うことの方が多いです。</p> <p>ディスクイメージファイルは外付けディスクのようなイメージでマウントして使えます。macOSに標準添付されている「ディスクユーティリティー」ツールを使えばこのイメージファイルを簡単に作ることができます。読み取り専用、読み書き可能、暗号化、圧縮などオプションを選ぶこともできます。</p> <p>終了したプロジェクトのファイル一式は.dmgファイルとしてまとめていますが、まとめたいプロジェクトファイルがたくさんあったり、ワークフローを自動化したいとなってくるとコマンドライン操作を覚えると便利です。</p> <h2 id="ディスクイメージファイルの作成">ディスクイメージファイルの作成</h2> <p><code class="language-plaintext highlighter-rouge">hdiutil</code>コマンドを使うとディスクイメージファイルの作成や設定変更、ディスクイメージファイルのマウント、アンマウントなどさまざま操作可能です。詳しくは<code class="language-plaintext highlighter-rouge">man hdiutil</code>をご参照いただくとして手元での利用例をご紹介します。</p> <p>フォルダ以下にあるサブフォルダをそれぞれ<code class="language-plaintext highlighter-rouge">.dmg</code>として一括変換したい場合に使っているスクリプトです。それぞれ一応暗号化しておこうということで、暗号化用のパスワードを<code class="language-plaintext highlighter-rouge">$HOME/.dmg-password</code>というファイルにあらかじめ格納してあります。パスワードファイルには最後に改行が入らないようにつくっておいてください。</p> <p>あとパーミッションも <code class="language-plaintext highlighter-rouge">chmod 600 $HOME/.dmg-password</code>など他者から読み出せないようにしておきます。そうはいっても、後述しますが一連のプロセスはさほど安全性が高いわけではありませんので「添付ファイルはパスワードつきzipでパスワードは別メールですぐ送信!」とあまり変わらないセキュリティーレベルとお考えいただいていいかと思います。</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span><span class="nt">-lt</span> 2 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="nv">$0</span> SRC_DIR DEST_DIR
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">SRC</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">DST</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">PWD</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/.dmg-password"</span>

<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-e</span> <span class="nv">$PWD</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo </span>Disk Image password not found
  <span class="nb">exit </span>2
<span class="k">fi

for </span>t <span class="k">in</span> <span class="s2">"</span><span class="nv">$SRC</span><span class="s2">"</span>/<span class="k">*</span><span class="p">;</span> <span class="k">do
  if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$t</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo </span>Creating: <span class="nv">$t</span>
    <span class="nv">n</span><span class="o">=</span><span class="si">$(</span><span class="nb">basename</span> <span class="nv">$t</span><span class="si">)</span>
    <span class="nb">cat</span> <span class="nv">$PWD</span> |                <span class="se">\</span>
      hdiutil create          <span class="se">\</span>
        <span class="nt">-srcfolder</span> <span class="s2">"</span><span class="nv">$t</span><span class="s2">"</span>       <span class="se">\</span>
        <span class="nt">-fs</span> HFS+              <span class="se">\</span>
        <span class="nt">-encryption</span> AES-128   <span class="se">\</span>
        <span class="nt">-format</span> UDBZ          <span class="se">\</span>
        <span class="nt">-stdinpass</span>            <span class="se">\</span>
        <span class="s2">"</span><span class="nv">$DST</span><span class="s2">/</span><span class="nv">$n</span><span class="s2">.dmg"</span>
  <span class="k">fi
done</span>
</code></pre></div></div> <h2 id="ディスクイメージファイルのパスワードをkeychainにプリセットしておく">ディスクイメージファイルのパスワードをKeyChainにプリセットしておく</h2> <p>暗号化しておいたのはいいですが、作成したディスクイメージファイルを開く際にいちいちパスワードを入力するのは面倒です。Finderからダブルクリックしてマウントしようとしたときに聞かれるパスワードダイアログはコピー&amp;ペーストを受け入れてくれないというのもさらに面倒さを増しています。</p> <p><img src="/images/2016-12-13-dmg1.png" alt="パスワードダイアログ"/></p> <p>パスワードをキーチェインに記憶させるというオプションがありますが、あらかじめコマンドラインから記憶させておけばいいという発想です。</p> <p>ディスクイメージファイルに対するパスワードは一般パスワードとして各ディスクイメージファイルのUUIDと対応して管理されています。このUUIDは</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>hdiutil isencrypted ディスクイメージファイル.dmg
</code></pre></div></div> <p>というように<code class="language-plaintext highlighter-rouge">isencrypted</code>オプションで知ることができます。キーチェインにパスワードを追加するには</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>security add-generic-password <span class="nt">-a</span> <span class="o">(</span>上記のUUID<span class="o">)</span> <span class="nt">-D</span> <span class="s2">"disk image password"</span> <span class="nt">-s</span> <span class="o">(</span>ファイル名<span class="o">)</span>.dmg <span class="nt">-w</span> <span class="o">(</span>パスワード<span class="o">)</span>
</code></pre></div></div> <p>というように実行すればよいでしょう。<code class="language-plaintext highlighter-rouge">security</code>コマンドの大変残念な点は<code class="language-plaintext highlighter-rouge">hdiutil</code>の<code class="language-plaintext highlighter-rouge">-stdinpass</code>のように標準入力からパスワードを受け取る手段がどうやらなさそうな点です。</p> <p>コマンド引数として実行してしまうと、シェルの履歴に残ったり、<code class="language-plaintext highlighter-rouge">ps</code>コマンドなどでパスワードが漏えいしてしまうケースがあります。このような点から上述のように「添付ファイルはパスワードつきzipでパスワードは別メールですぐ送信!」というセキュリティーレベルとたいして変わらないと思っています。</p> <p>さて、上記を合わせて次のようなスクリプトにしてあります。</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/sh

if [ $# -lt 1 ]; then
  echo $0 [dmg file]...
  exit 1
fi

PWD=$HOME/.dmg-password

for FILE in "$@"; do
  UUID=$(hdiutil isencrypted "$FILE" 2&gt;&amp;1 | grep uuid | awk '{print $2}')
  BASE=$(basename $FILE)

  echo File: $BASE
  echo UUID: $UUID

  security add-generic-password -a $UUID -D "disk image password" -s $BASE -w $(cat $PWD)
done
</code></pre></div></div> <p>このようにキーチェインにパスワードを設定したファイルを開こうとすると次のようにキーチェインからパスワードを取り出していいか確認されます。</p> <p><img src="/images/2016-12-13-dmg2.png" alt="確認ダイアログ"/></p> <p>このダイアログを<code class="language-plaintext highlighter-rouge">security</code>コマンドの<code class="language-plaintext highlighter-rouge">-A</code>オプションでスキップする手段もありますがすべてのアプリケーションに対して許可を出してしまいます。少し面倒ですが、ここは一手間かけておいたほうがいいでしょう。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2016/12/12/tumblr-to-jekyll/"> TumblrからJekyll + Github Pagesへ </a> </h1> <span class="post-date"> 12th December 2016</span> <span class="post-tags"> #<a href="/tags/github">github</a> #<a href="/tags/jekyll">jekyll</a> #<a href="/tags/migration">migration</a> #<a href="/tags/tumblr">tumblr</a> </span> <p><a href="/2013/08/24/wordpress-to-tumblr">3年ほど前にWordPressからTumblrへ移行しました</a>。特に大きな問題があったわけではないのですが、最近ソースコードを挿入した記事をいくつか書こうとしたところTumblrのMarkdownではうまく表現され切れない点にすこしストレスを感じていました。表示をあれこれいじっている時間ももったいなくなってきたのでいっそのこと、<a href="https://guides.github.com/features/mastering-markdown/#GitHub-flavored-markdown">GFM (GitHub Flavored Markdown)</a>で書けるようなサービスか、システムに移行しようと考え始めました。</p> <p>あれこれ調べているうちに、どうやら<a href="https://jekyllrb.com/">Jekyll</a>をつかって<a href="https://pages.github.com/">Github Pages</a>へ移行するのがスムーズそうだなと調べ始めて評価し、次の点で問題なさそうだったので移行することにしました。</p> <ul> <li>GFMで書ける</li> <li>既存のURL構成を引き継げる</li> <li>Tumblrからの記事取り込みもできる</li> <li>シンプルなテーマがある</li> </ul> <p>逆に移行に当たってできなくなる機能もあります。たとえばソーシャルメディア連携です。Tumblrでホストしてもらえば、Tumblr上のソーシャルメディアでリブログなど拡散手段があります。ほかには予約投稿やTwitter連携といった機能も使えなくなります。このあたりはトレードオフですが、ソーシャルメディアで拡散していただくよりも、そもそも記事が書きづらくて筆無精になるのであれば優先順位は明らかです。</p> <p>ソーシャルメディア連携もあとからIFTTTなど何か使えば実現できるでしょうし、予約投稿も必要になれば決まった時間に<code class="language-plaintext highlighter-rouge">git push</code>するよう何か構成を考えればいいだけです。</p> <h1 id="移行の効果">移行の効果</h1> <p>移行中のあれこれは後述することにしてまずは、移行によってどういったメリットがあったかみてみます。</p> <p>WordPressから移行した際にはサイトの速度が劇的に改善しましたが、今回は比較的軽微な差に収まっています。</p> <h2 id="tumblrでのpagespeed結果">TumblrでのPageSpeed結果</h2> <p>まずはTumblrでの<a href="https://developers.google.com/speed/pagespeed/">PageSpeed</a>計測結果から。</p> <p><img src="/images/2016-12-12-tumblr-mobile.png" alt="Tumblr / モバイル"/></p> <p>モバイル用のスコアは67点。画像サイズが大きいと警告がでているのと、キャッシュ設定などのところで最適化の余地があるとの判定です。</p> <p><img src="/images/2016-12-12-tumblr-desktop.png" alt="Tumblr / デスクトップ"/></p> <p>デスクトップ用のスコアは77点。モバイルと同様に画像が大きいと警告が出ています。いずれにしても体感的にはもっさりした感覚は全くなく、表示速度などの不満は特にありませんでした。</p> <h2 id="jekyll--github-pagesでpagespeed結果">Jekyll + Github PagesでPageSpeed結果</h2> <p><img src="/images/2016-12-12-jekyll-mobile.png" alt="Jekyll + Github Pages / モバイル"/></p> <p>モバイル用のスコアは72点と少しだけTumblrでの表示より改善しています。これはTumblrのインフラスピードとの差というよりは、採用しているテーマのCSSやJavaScriptの差がほとんどだと考えられます。</p> <p><img src="/images/2016-12-12-jekyll-desktop.png" alt="Jekyll + Github Pages / デスクトップ"/></p> <p>デスクトップ用のスコアは77点とTumblrでの結果と同じです。</p> <h2 id="その他の違い">その他の違い</h2> <p>Tumblrではモバイル対応していないテーマを使っていたので、TumblrのUIが優先して表示されています。一方、Jekyllで今回利用した<a href="http://lanyon.getpoole.com/">Lanyon</a>はモバイルフレンドリーなテーマで、今回どちらでも同じLook and Feelでサイトを表示できるようになりました。</p> <h1 id="移行">移行</h1> <p>移行作業はJekyllの使い方を覚えるところから全部でおおよそ5〜6時間かかったかと思います。Jekyllはかなり活発に開発されているようなのであまりここで細々と手順を書いてもすぐ使いもにならなくなってしまう気がするのでおおまかな流れだけご紹介しておきます。</p> <h2 id="jekyll環境の設定">Jekyll環境の設定</h2> <p>最近はこの手のツールを使うときはすべてDockerを使って独立した環境で実行するようにしています。再現性もありますし、手元の環境もシンプルに保てます。Jekyllを使うには既存のDockerイメージを使えば充分ですが、いくつかテーマを試したりしているうちに依存関係のあるライブラリをまとめてイメージとして持っていたほうが便利だったので次のような内容の<code class="language-plaintext highlighter-rouge">Dockerfile</code>を作っています。</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM jekyll/jekyll:builder

RUN apk add --no-cache --virtual build-dependencies build-base
RUN apk add --no-cache libxml2-dev libxslt-dev
RUN apk add --no-cache ruby-dev curl-dev zlib-dev yaml-dev
RUN gem install nokogiri
RUN gem install minima
RUN gem install jekyll-import
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">jekyll-import</code>は後述のTumblrから記事を取り込んだときに使ったものです。この<code class="language-plaintext highlighter-rouge">Dockerfile</code>をビルドしておきます。たとえば<code class="language-plaintext highlighter-rouge">site</code>ディレクトリ以下につくっていくならこんな感じにコンテナを実行して、テンプレートを作ったり<code class="language-plaintext highlighter-rouge">jekyll-import</code>を実行したりできます。</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">--rm</span> <span class="nt">-i</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/site:/srv/jekyll <span class="nt">-p</span> 4000:4000 <span class="nt">-t</span> <span class="o">(</span>ビルドしたときのタグ名<span class="o">)</span> bash
</code></pre></div></div> <p>今回はあれこれテーマをダウンロードし、<code class="language-plaintext highlighter-rouge">jekyll-import</code>でTumblrから記事をざっくり取り込んで表示確認をしながらレイアウトを決定しました。</p> <h2 id="tumblrからのインポート">Tumblrからのインポート</h2> <p><a href="http://import.jekyllrb.com/docs/tumblr/">jekyll-importのTumblrについての記事</a>にコマンドが書かれていますのでこれを実行します。 移行といっても今回はTumblrで書いた記事が12記事しかなかったので、ある程度の部分は詳しく調べずに手作業でファイルを修正していくというスタイルで解決しました。</p> <p>今回実行した際は次のように実行しました。</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ruby <span class="nt">-rubygems</span> <span class="nt">-e</span> <span class="s1">'require "jekyll-import";
    JekyllImport::Importers::Tumblr.run({
      "url"            =&gt; "http://(TumblrのID).tumblr.com",
      "format"         =&gt; "html",
      "grab_images"    =&gt; true,
      "add_highlights" =&gt; true,
      "rewrite_urls"   =&gt; true
    })'</span>
</code></pre></div></div> <p>最初formatはMarkdown(md)を指定していましたが、うまく記事が取りこめなかったのでhtmlで取り込み、あとで手動でMarkdownに変換しました。</p> <p>Tumblrでは記事のURLが <code class="language-plaintext highlighter-rouge">/post/(記事ID)/(記事タイトル)</code>というフォーマットでしたが、Jekyllでは<code class="language-plaintext highlighter-rouge">/(年)/(月)/(日)/(記事タイトル)</code>となるので変換が必要です。<code class="language-plaintext highlighter-rouge">rewrite_urls</code>で相当するアドレスにリダイレクトするファイルを作ってくれるので、リンクはそのまま維持できます。</p> <p>ただ困ったことに生々されたリダイレクト用の<code class="language-plaintext highlighter-rouge">index.html</code>では<code class="language-plaintext highlighter-rouge">/(年)-(月)-(日)-(記事タイトル)</code>へのリダイレクトになっていてうまく動きません。あれこれ探すのも面倒だったのでここは手動で直してしまいました。</p> <p><code class="language-plaintext highlighter-rouge">grab_images</code>という設定があり画像をもってきてくれそうな印象がありましたが、これもうまく動かなかったので手作業で画像をもってきたり、手元に保存してあったものを使ったりして再構成しました。</p> <h2 id="テーマ選び">テーマ選び</h2> <p>いくつかサンプルを見ながら選びましたがシンプルなものがよかったのでLanyonにしました。ほかにもシンプルなデザインのものはありましたが、Lanyonは欲しい機能がおおむね入っていることと、CSSやJavaScriptを含めても全体の構成がシンプルで全体が見渡しやすいことが気に入りました。</p> <h1 id="切り替え">切り替え</h1> <p>できあがったJekyllのページ一式をGithub Pagesへプッシュし、あとはCloudFlareでDNSの切り替えをすれば終了です。</p> <p>Jekyllも開発スピードが速そうなので、開発についていくとしたらかなり大変そうです。ただでき上がったサイトはかなりシンプルなHTML、CSS、JavaScriptと画像ファイルだけで構成されているのでセキュリティー上の理由などで更新しなければいけないケースはかなり少ないと思います。</p> <p>そういった意味では、一度環境ができ上がってしまえばTumblrでプレビューにあれこれ悩みながら記事を書くよりも手元の環境で確実なプレビューを見てから公開できるワークフローをつくったほうがより生産性が高そうだということで今は満足しています。</p> <p>画像を含めたオーサリングのワークフローをつくったり、プレビューから予定投稿などまでいろいろ作り込みたいところですがそのあたりはまた今度じっくり作り込んでみることにします。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2016/10/27/dropbox-business-utilities-written-in-golang-ja/"> Dropbox Business utilities written in Golang </a> </h1> <span class="post-date"> 27th October 2016</span> <span class="post-tags"> #<a href="/tags/api">api</a> #<a href="/tags/dropbox">dropbox</a> #<a href="/tags/dropboxbusiness">dropboxbusiness</a> #<a href="/tags/go">go</a> #<a href="/tags/golang">golang</a> </span> <p>今夏ごろからDropbox Business向けのツールをちょこちょこと開発しています。<a href="https://www.dropbox.com/developers">Dropbox Business API</a>は一般的なOAuth2を使った認証と、HTTPでのAPIのためたいていのプログラミング言語で簡単に扱えます。また、DropboxからPython、Ruby、Java、JavaScript、.NET、Objective-C、SwiftなどSDKもリリースされているのでこれらを使えばより簡単です。</p> <p>ちなみにこれほど多くのSDKをメンテナンスするのはかなり手間ですが、それを解消するために<a href="https://github.com/dropbox/stone">Stone</a>というオープンソースが公開されています。StoneはAPI仕様記述からSDKを生成するツールで一度この仕様記述をメンテナンスしていけばSDKは自動生成できます。Dropbox APIの仕様についても同様に<a href="https://github.com/dropbox/dropbox-api-spec">Stoneでの仕様記述</a>があり、公開されているSDKは自動生成されたものをベースにしています。</p> <h1 id="つくったツール">つくったツール</h1> <p>作成したのは下記二つのツールです。</p> <ul> <li><a href="http://github.com/watermint/dcfg">dcfg</a> … G Suiteのグループで管理されている組織、グループ構成をDropbox Businessチーム用に同期する</li> <li><a href="https://github.com/watermint/dreport">dreport</a> … Dropbox Businessチームに関するメンバー一覧などをレポートとしてCSVで出力する</li> </ul> <p>いずれもCLIツールでシステム管理者が利用する想定のものです。ただ、昨今はシステム管理といってもWindowsだけでなくMacなど様々なシステム環境があります。このように利用用途からかんがえて複数プラットホームで利用できたほうが便利なので、個人的には初めてとなるGolangを採用してみました。</p> <h1 id="はじめてのgolang">はじめてのGolang</h1> <p>一番最近よく使っていたプログラミング言語はScalaだったので、カルチャーギャップというか、プログラミング言語がもつ信念のようなところに大きな差があって少し戸惑いました。</p> <p>Scalaのようなオブジェクト指向的にも関数型的にもかけるプログラミング言語の直後ということもあって、Golangの書き方はややまどろっこしく感じます。ただこのまどろっこしさも次第に慣れていくことで、また考え方がわかってきたことでさほど気にならなくなってきました。</p> <p>どこに書いてあったかソースは失念しましたがたとえば、「関数のなかで、計算量のオーダーが O(1) → O(n)のように変わるような書き方はあえてさせないことで、関数を使う側がどういうオーダーの計算量を常に意識させるようにしている」というような説明がありました。Golangのテストフレームワークがassertをあえて実装していない、といったこともそうですが、プログラミング言語やフレームワークで様々なヒューマンエラーを減らしていこうとする考え方とはまた違う思想を感じます。</p> <p>この考え方を真に受けてコードを書いていったので、でき上がったプログラムはにたようなforループやif分岐がたくさんでき上がりました。今回、コードをかくに当たってあまり他の方のコードを読んだりしなかったので本流とはだいぶ外れているかもしれません。</p> <h1 id="パッケージ管理">パッケージ管理</h1> <p>Golangで戸惑ったのがパッケージ管理です。Goのプログラムは<code class="language-plaintext highlighter-rouge">GOPATH</code>環境変数で指定したディレクトリ以下にすべての依存ファイル、そして自分のプロジェクトファイルも置いていくという方式です。</p> <p>自分のプロジェクトをたとえば、github.com/watermint/dcfg で公開する予定ならば下図のように <code class="language-plaintext highlighter-rouge">GOPATH</code>以下に置いていきます。外部ライブラリたとえば、github.com/dropbox/dropbox-sdk-go-unofficialを使うのであればこれらも<code class="language-plaintext highlighter-rouge">go get</code>コマンドを経由して同様に<code class="language-plaintext highlighter-rouge">GOPATH</code>以下に配置します。</p> <p><code class="language-plaintext highlighter-rouge">$GOPATH / src / github.com / watermint / dcfg</code></p> <p>ひょっとすると、Goの考え方でAPIは一度公開したならば同じ名前で同じように使えるべき。という信念があるのかもしれません。 この方式で困るのは複数プロジェクトを進行しているときに、異なるバージョンのライブラリを利用したいや、ライブラリのバージョンをしばらく固定しておきたいときにはやっかいです。</p> <p>また別の環境でビルドする際にも依存するライブラリの管理が煩雑になります。こういった問題に対しRubyであればgem、Javaなどではmaven、gradle、sbtなどパッケージ管理は様々あり、これらで管理するのが当たり前という風なイメージを持っています。Golangでも同じようなものを探してみましたが、いまひとつこれといったものがどれなのかわかりませんでした。</p> <p>これも今回はあまり細かく調べずに、<a href="https://github.com/Masterminds/glide">glide</a>というツールを利用しました。glideをつかうと、依存するライブラリ郡を自分のプロジェクトフォルダ以下の<code class="language-plaintext highlighter-rouge">vendor</code>というフォルダにまとめてくれます。バージョン指定も可能ですし、一括してライブラリ郡をダウンロードするなど細々面倒を見てくれます。</p> <p>また今回つかったdropbox-go-sdk-unofficialは名前の通りアンオフィシャルSDKで、まだ活発に大規模なリファクタリングがおこなわれていてバージョンを固定しないとまともに開発できない。。という現状もありglideによるパッケージ管理はもっとはやく導入しておけばと悔やまれました。</p> <p>おそらく他のツールでも同様によしなに準備してくれるのだと思います。</p> <h1 id="ビルド">ビルド</h1> <p>本格的にコーディングを始める前に、ビルド環境だけは念入りに準備することにしました。ビルド環境のOSのバージョンが違うことで何か問題がでたりするとかなりの時間を浪費してしまいますし、いろんなところで新しくビルドしようとおもったときにも手間がかかります。</p> <p>今回はご多分に漏れず<a href="https://www.docker.com/">Docker</a>を使っています。Dockerfileを用意しておいて、Dockerコンテナ上でビルドをしてそのバイナリを手元環境でテストするというワークフローを確立しました。</p> <p>ついでにTravis CIでもテストが自動的に実行されるようにしておきました。テストカバレッジなども集計するという流れを自動化しておくこともできますが、これもなかなか情報が分散していて地味に手間のかかる作業でした。</p> <p>これから環境を用意されようと思われる方は下記の.travis.ymlをご参考にしていただければと思います。</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">language</span><span class="pi">:</span> <span class="s">go</span>
<span class="na">go</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="m">1.7</span>
 <span class="pi">-</span> <span class="s">tip</span>

<span class="na">before_install</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="s">go get golang.org/x/tools/cmd/cover</span>
 <span class="pi">-</span> <span class="s">go get github.com/modocache/gover</span>
 <span class="pi">-</span> <span class="s">go get github.com/mattn/goveralls</span>
 <span class="pi">-</span> <span class="s">go get github.com/Masterminds/glide</span>

<span class="na">install</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="s">glide install</span>

<span class="na">script</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="s">go list -f '{{if len .TestGoFiles}}"go test -coverprofile={{.Dir}}/.coverprofile {{.ImportPath}}"{{end}}' $(glide novendor) | xargs -L 1 sh -c</span>
 <span class="pi">-</span> <span class="s">gover</span>

<span class="na">after_success</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="s">goveralls -coverprofile=gover.coverprofile -service=travis-ci -repotoken $COVERALLS_TOKEN</span>
</code></pre></div></div> <ul> <li><a href="https://github.com/watermint/dcfg/blob/v1.3.9/.travis.yml">https://github.com/watermint/dcfg/blob/v1.3.9/.travis.yml</a></li> </ul> <p>ここで登場するcover、gover、goverallsはカバレッジを取得、集約するためのものです。よく見るとgoverは前職の同僚が作ったものですね。こんなところでお目にかかるとは誇らしいものです。</p> <p>ところで<code class="language-plaintext highlighter-rouge">script:</code>のセクションはややトリッキーな書き方をしています。これもあれこれ情報を集めながら試行錯誤したものでこれでいいのか微妙なところですがひとまず動作しているのでこれで。。</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="s">go list -f '{{if len .TestGoFiles}}"go test -coverprofile={{.Dir}}/.coverprofile {{.ImportPath}}"{{end}}' $(glide novendor) | xargs -L 1 sh -c</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">go test</code>というのでカバレッジがとれますが残念ながら<code class="language-plaintext highlighter-rouge">go test</code>では1つのソースファイルについてのみテストとカバレッジ測定となってプロジェクト全体ではとれません。そこで、ソースコードひとつずつについて<code class="language-plaintext highlighter-rouge">go test</code>を実行してカバレッジデータのファイルを個別につくってあとで結合するという力技です。</p> <h1 id="retrospective">Retrospective</h1> <p>今回はCLIツールを作りましたが、利用シーンを考えるとGUIツールもぜひ作ってみたいところです。 GolangでのGUIライブラリはまだこれといった決定打がないようで、ひょっとしたらJavaでつくるか、SwiftをつかってiOSアプリにしてしまうほうがいいのかもしれません。</p> <p>今回CLIとは別に<a href="https://github.com/gin-gonic/gin">Gin</a>というライブラリを使ってWebサーバを立ち上げるパターンも試作してみました。Play framework等と比べればまだまだツールサポートなども弱いので生産性に課題を感じましたがしっかり作り込めばGUIでつくるよりも将来性がありそうです。</p> <p>このあたりはまた次回の研究課題です。</p> </div> </div> <div class="pagination"> <a class="pagination-item older" href="/page10">Older</a> <a class="pagination-item newer" href="/page8">Newer</a> </div> </div> <div class="container copyright"> &copy; 2007, 2013-2022 Takayuki Okazaki </div> </div> <label for="sidebar-checkbox" class="sidebar-toggle"></label> <script>!function(e){var r=e.querySelector(".sidebar-toggle"),t=e.querySelector("#sidebar"),n=e.querySelector("#sidebar-checkbox");e.addEventListener("click",function(e){var c=e.target;n.checked&&!t.contains(c)&&c!==n&&c!==r&&(n.checked=!1)},!1)}(document);</script> </body> </html>