<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> watermint.org &middot; Takayuki Okazaki's note </title> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/watermint-logo.png"> <link rel="shortcut icon" href="/public/watermint-logo.png"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <style>*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:serif;font-size:14px;line-height:1.8}@media(min-width:38em){html{font-size:20px}}body{color:#515151;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a strong{color:inherit}a:hover,a:focus{text-decoration:underline}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:bold;line-height:1.25;color:#313131;text-rendering:optimizeLegibility}h1{font-size:1.5rem;margin-top:1.6rem;margin-bottom:1.6rem}h2{margin-top:1.6rem;font-size:1.3rem}h3{margin-top:1.6rem;font-size:1.2rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}strong{color:#303030}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:bold}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:bold;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}code,pre{font-family:Menlo,Monaco,"Courier New",monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}.gist .gist-file{font-family:Menlo,Monaco,"Courier New",monospace!important}.gist .markdown-body{padding:15px}.gist pre{padding:0;background-color:transparent}.gist .gist-file .gist-data{font-size:.8rem!important;line-height:1.4}.gist code{padding:0;color:inherit;background-color:transparent;border-radius:0}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media(min-width:30em){blockquote{padding-right:5rem;padding-left:1.25rem}}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;border:1px solid #e5e5e5;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #e5e5e5}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#f9f9f9}.lead{font-size:1.25rem;font-weight:300}.message{margin-bottom:1rem;padding:1rem;color:#717171;background-color:#f9f9f9}.container{max-width:38rem;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.post-tags{display:block;margin-top:-.5rem;margin-bottom:1rem;text-align:right}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:"PT Sans",Helvetica,Arial,sans-serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}html,body{overflow-x:hidden;line-height:1.9em}html{font-family:serif}h1,h2,h3,h4,h5,h6{font-weight:400;color:#313131}.wrap{position:relative;width:100%}.container{max-width:28rem}@media(min-width:38em){.container{max-width:32rem}}@media(min-width:56em){.container{max-width:38rem}}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem;border-bottom:1px solid #eee}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}@media(max-width:48em){.masthead-title{text-align:center}.masthead-title small{display:none}}.sidebar{position:fixed;top:0;bottom:0;left:-14rem;width:14rem;visibility:hidden;overflow-y:auto;font-family:serif;font-size:.875rem;line-height:1.4em;color:rgba(255,255,255,.6);background-color:#202020;-webkit-transition:all .3s ease-in-out;transition:all .3s ease-in-out}
@media(min-width:30em){.sidebar{font-size:.75rem}}.sidebar a{font-weight:normal;color:#fff}.sidebar-item{padding:1rem}.sidebar-item p:last-child{margin-bottom:0}.sidebar-nav{border-bottom:1px solid rgba(255,255,255,.1)}.sidebar-nav-item{display:block;padding:.5rem 1rem;border-top:1px solid rgba(255,255,255,.1)}.sidebar-nav-item.active,a.sidebar-nav-item:hover,a.sidebar-nav-item:focus{text-decoration:none;background-color:rgba(255,255,255,.1);border-color:transparent}@media(min-width:48em){.sidebar-item{padding:1.5rem}.sidebar-nav-item{padding-left:1.5rem;padding-right:1.5rem}}.sidebar-checkbox{position:absolute;opacity:0;-webkit-user-select:none;-moz-user-select:none;user-select:none}.sidebar-toggle{position:absolute;top:.8rem;left:1rem;display:block;padding:.25rem .75rem;color:#555;border-radius:.25rem;cursor:pointer}.sidebar-toggle:before{display:inline-block;width:1rem;height:.75rem;content:"";background-image:-webkit-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-moz-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-ms-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%)}.sidebar-toggle:active,#sidebar-checkbox:focus ~ .sidebar-toggle,#sidebar-checkbox:checked ~ .sidebar-toggle{color:#fff}.sidebar-toggle:active:before,#sidebar-checkbox:focus ~ .sidebar-toggle:before,#sidebar-checkbox:checked ~ .sidebar-toggle:before{background-image:-webkit-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-moz-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-ms-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%)}@media(min-width:30.1em){.sidebar-toggle{position:fixed}}@media print{.sidebar-toggle{display:none}}.wrap,.sidebar,.sidebar-toggle{-webkit-backface-visibility:hidden;-ms-backface-visibility:hidden;backface-visibility:hidden}.wrap,.sidebar-toggle{-webkit-transition:-webkit-transform .3s ease-in-out;transition:transform .3s ease-in-out}#sidebar-checkbox:checked+.sidebar{z-index:10;visibility:visible}#sidebar-checkbox:checked ~ .sidebar,#sidebar-checkbox:checked ~ .wrap,#sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(14rem);-ms-transform:translateX(14rem);transform:translateX(14rem)}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}.layout-reverse .sidebar{left:auto;right:-14rem}.layout-reverse .sidebar-toggle{left:auto;right:1rem}.layout-reverse #sidebar-checkbox:checked ~ .sidebar,.layout-reverse #sidebar-checkbox:checked ~ .wrap,.layout-reverse #sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(-14rem);-ms-transform:translateX(-14rem);transform:translateX(-14rem)}.theme-base-08 .sidebar,.theme-base-08 .sidebar-toggle:active,.theme-base-08 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#ac4142}.theme-base-08 .container a,.theme-base-08 .sidebar-toggle,.theme-base-08 .related-posts li a:hover{color:#ac4142}.theme-base-09 .sidebar,.theme-base-09 .sidebar-toggle:active,.theme-base-09 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#d28445}.theme-base-09 .container a,.theme-base-09 .sidebar-toggle,.theme-base-09 .related-posts li a:hover{color:#d28445}.theme-base-0a .sidebar,.theme-base-0a .sidebar-toggle:active,.theme-base-0a #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#f4bf75}
.theme-base-0a .container a,.theme-base-0a .sidebar-toggle,.theme-base-0a .related-posts li a:hover{color:#f4bf75}.theme-base-0b .sidebar,.theme-base-0b .sidebar-toggle:active,.theme-base-0b #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#90a959}.theme-base-0b .container a,.theme-base-0b .sidebar-toggle,.theme-base-0b .related-posts li a:hover{color:#90a959}.theme-base-0c .sidebar,.theme-base-0c .sidebar-toggle:active,.theme-base-0c #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#75b5aa}.theme-base-0c .container a,.theme-base-0c .sidebar-toggle,.theme-base-0c .related-posts li a:hover{color:#75b5aa}.theme-base-0d .sidebar,.theme-base-0d .sidebar-toggle:active,.theme-base-0d #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#6a9fb5}.theme-base-0d .container a,.theme-base-0d .sidebar-toggle,.theme-base-0d .related-posts li a:hover{color:#6a9fb5}.theme-base-0e .sidebar,.theme-base-0e .sidebar-toggle:active,.theme-base-0e #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#aa759f}.theme-base-0e .container a,.theme-base-0e .sidebar-toggle,.theme-base-0e .related-posts li a:hover{color:#aa759f}.theme-base-0f .sidebar,.theme-base-0f .sidebar-toggle:active,.theme-base-0f #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#8f5536}.theme-base-0f .container a,.theme-base-0f .sidebar-toggle,.theme-base-0f .related-posts li a:hover{color:#8f5536}.sidebar-overlay #sidebar-checkbox:checked ~ .wrap{-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0)}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar-toggle{box-shadow:0 0 0 .25rem #fff}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:.25rem 0 .5rem rgba(0,0,0,.1)}.layout-reverse.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:-.25rem 0 .5rem rgba(0,0,0,.1)}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight,.highlight .w{color:#586e75}.highlight .err{color:#002b36;background-color:#dc322f}.highlight .c,.highlight .cd,.highlight .cm,.highlight .c1,.highlight .cs{color:#657b83}.highlight .cp{color:#b58900}.highlight .nt{color:#b58900}.highlight .o,.highlight .ow{color:#93a1a1}.highlight .p,.highlight .pi{color:#93a1a1}.highlight .gi{color:#859900}.highlight .gd{color:#dc322f}.highlight .gh{color:#268bd2;background-color:#002b36;font-weight:bold}.highlight .k,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .kv{color:#6c71c4}.highlight .kc{color:#cb4b16}.highlight .kt{color:#cb4b16}.highlight .kd{color:#cb4b16}.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .sh,.highlight .sx,.highlight .s1{color:#859900}.highlight .sr{color:#2aa198}.highlight .si{color:#d33682}.highlight .se{color:#d33682}.highlight .nn{color:#b58900}.highlight .nc{color:#b58900}.highlight .no{color:#b58900}.highlight .na{color:#268bd2}.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .il,.highlight .mo,.highlight .mb,.highlight .mx{color:#859900}.highlight .ss{color:#859900}.copyright{font-size:.8em;font-style:italic;color:#555}</style> </head> <body class="theme-base-09"> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"> <div class="sidebar" id="sidebar"> <div class="sidebar-item"> <p>Travel, camera, photo, and technical things. I work at Dropbox. Thoughts are my own.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Archive</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> <a class="sidebar-nav-item" href="/atom.xml">Feed</a> <a class="sidebar-nav-item" href="https://github.com/watermint">Github</a> <a class="sidebar-nav-item" href="https://www.instagram.com/watermint/">Instagram</a> </nav> <div class="sidebar-item"> <p> &copy; 2005-2018 Takayuki Okazaki </p> </div> </div> <div class="wrap"> <div class="masthead"> <div class="container"> <h3 class="masthead-title"> <a href="/" title="Home">watermint.org</a> <small>- Takayuki Okazaki's note</small> </h3> </div> </div> <div class="container content"> <div class="posts"> <div class="post"> <h1 class="post-title"> <a href="/2017/01/22/go-bandwidth-limit-for-multiple-io/"> Go: Bandwidth limit for multiple Reader and Writer </a> </h1> <span class="post-date"> 22nd January 2017</span> <span class="post-tags"> #<a href="/tags/bandwidth">bandwidth</a> #<a href="/tags/concurrency">concurrency</a> #<a href="/tags/go">go</a> </span> <p>Bandwidth limit is really important for stabilizing systems. Core business logic stops if low priority job consume entire bandwidth of the system. When writing bandwidth limit for <code class="highlighter-rouge">Reader</code> or <code class="highlighter-rouge">Writer</code> in Go, I found <a href="https://github.com/mxk/go-flowrate">go-flowrate</a>. This library enables easy way to limit bandwidth like the code below.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">f</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data.dat"</span><span class="p">)</span><span class="x">

    </span><span class="c">// Create wrapper with 100 bytes per second</span><span class="x">
    </span><span class="n">f2</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">flowrate</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="x"> </span><span class="m">100</span><span class="p">)</span><span class="x">

    </span><span class="c">// Biz logic</span><span class="x">
    </span><span class="c">// ...</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div> <p>APIs are pretty simple and reliable. But <code class="highlighter-rouge">go-flowrate</code> can limit bandwidth only for single <code class="highlighter-rouge">Reader</code> or <code class="highlighter-rouge">Writer</code>. In my case, I was working on file uploader for Dropbox which has concurrent upload feature. This code require limiting bandwidth for multiple I/O. So I decided create new small library for bandwidth limit.</p> <h1 id="bwlimit"><code class="highlighter-rouge">bwlimit</code></h1> <p><code class="highlighter-rouge">bwlimit</code> is the name of my library. You can see or clone from github <a href="https://github.com/watermint/bwlimit">bwlimit</a>. Here is code example of <code class="highlighter-rouge">bwlimit</code>.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="c">// Limit 100 bytes per second</span><span class="x">
    </span><span class="n">bwlimit</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">NewBwlimit</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="x"> </span><span class="no">false</span><span class="p">)</span><span class="x">

    </span><span class="c">// Prepare multiple readers</span><span class="x">
    </span><span class="n">f1</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data1.dat"</span><span class="p">)</span><span class="x">
    </span><span class="n">f2</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data2.dat"</span><span class="p">)</span><span class="x">

    </span><span class="c">// Create wrapper</span><span class="x">
    </span><span class="n">fr1</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">bwlimit</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="x">
    </span><span class="n">fr2</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">bwlimit</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span><span class="x">

    </span><span class="c">// Biz logic</span><span class="x">
    </span><span class="c">// ...</span><span class="x">

    </span><span class="c">// Wait for all Reader to be closed or reach EOF</span><span class="x">
    </span><span class="n">bwlimit</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div> <p>1) Prepare bandwidth limiting object (<code class="highlighter-rouge">bwlimit</code> in above code) first. Second argument is the flag for block(true) or unblock(false) for <code class="highlighter-rouge">Read</code> or <code class="highlighter-rouge">Write</code> operation. 2) Then, create wrapper for each <code class="highlighter-rouge">Reader</code> or <code class="highlighter-rouge">Writer</code>.</p> <h1 id="concept">Concept</h1> <p>The concept of <code class="highlighter-rouge">bwlimit</code> comes from Toyota’s Production System (TPS). In TPS, <a href="https://en.wikipedia.org/wiki/Takt_time">Takt time</a> is the core concept for leveling production. Define time unit of ship defined quantity of products.</p> <p>For example; 1) Takt time is 100ms, 2) bandwidth limit is 1,000 bytes per second. 100 bytes is maximum transferrable data size per takt time. If <code class="highlighter-rouge">bwlimit</code> object has two <code class="highlighter-rouge">Readers</code>, that mean 50 bytes per <code class="highlighter-rouge">Reader</code> per takt time.</p> <h1 id="flow-control">Flow control</h1> <p><code class="highlighter-rouge">bwlimit</code> does not carry bandwidth window to next takt time. If the Reader have 50 bytes window per takt time, and the Reader read nothing. Then, window size of next takt time will be 50 bytes. This is because if <code class="highlighter-rouge">bwlimit</code> carry unused window to next takt time. <code class="highlighter-rouge">bwlimit</code> may allow burst IO for certain takt time. That sometime cause buffer overflow of routers. To prevent incident caused by burst IO.</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2017/01/15/from-github-pages-to-aerobatic/"> Github Pages + CloudFlareからAerobaticへ </a> </h1> <span class="post-date"> 15th January 2017</span> <span class="post-tags"> #<a href="/tags/aerobatic">aerobatic</a> #<a href="/tags/githubpages">githubpages</a> #<a href="/tags/jekyll">jekyll</a> </span> <p>つい先月、Tumblrから<a href="/2016/12/12/tumblr-to-jekyll/">Jekyll + Github Pages</a>に移行したところですが、今度はJekyll + <a href="https://www.aerobatic.com/">Aerobatic</a>に移行しました。</p> <p>これでこのブログのサーバお引っ越しは、次のように4回目になりました。</p> <ol> <li>WordPress + さくらインターネット (2005〜2013)</li> <li>Tumblr (2013〜2016)</li> <li>Jekyll + Github Pages + CloudFlare (2016〜2017)</li> <li>Jekyll + Aerobatic (2017〜)</li> </ol> <p>WordPressからTumblrに移行したり、TumblrからJekyllに移行するのはコンテンツの調整などでさまざま面倒な点があります。たとえば、既存コンテンツに対するURLを引き継ぎたいといった要望に対して対応するのはコンテンツ個別に調整と動作確認が必要でした。</p> <p>今回、コンテンツはそのままJekyllで運用するのでインフラ部分の移行のみです。</p> <h2 id="github-pagesから移行した理由">Github Pagesから移行した理由</h2> <p>基本的な使い方としてはGithub Pagesで充分満足が行くものでした。ただ、気になる点としては下記2点がありました。</p> <ul> <li>HTTPSに対応できない</li> <li>Minifierが使えない</li> </ul> <p>Github Pagesでカスタムドメインとして登録した場合、現状ではHTTPSでコンテンツを提供することができません。ブログコンテンツの内容として、HTTPS通信の必要性はさほどありません。ただ、Appleによる<a href="https://developer.apple.com/news/?id=12212016b">App Transport Securityなどでは2016年末までという期限こそ延長された</a>もののデフォルトでHTTPSを提供するようにとした方針に変更はありません。こういった状況を考えれば、HTTPSでのコンテンツ提供準備は早くできているに越したことはありません。</p> <p>次にMinifierです。<a href="https://github.com/digitalsparky/jekyll-minifier">jekyll-minifier</a>を使おうとしましたがGithub Pagesではうまく動作しませんでした。</p> <h2 id="github-pages--cloudflare">Github Pages + CloudFlare</h2> <p>次にGithub Pagesだけではうまく2つの課題に対応できなかったので、CloudFlareを組み合わせることにしました。CloudFlareを経由して通信を行えば２つの課題は解消できます。もともと、watermint.orgドメインのDNS管理はCloudFlareで行っていたのでCloudFlareを経由するかどうかのオプションを変えるだけですみました。</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Client] ---&lt;HTTP/HTTPS&gt;--- [CloudFlare] ---&lt;HTTP&gt;--- [Github Pages]
</code></pre></div></div> <p>CloudFlareを経由すると、HTTPSで接続要求があった場合CloudFlare側でHTTPSで処理してくれます。元のコンテンツであるGithub PagesとCloudFlare間は従来通りHTTPでの通信となります。CloudFlareから証明書も無償で発行してもらえます。</p> <p>CloudFlareではCDNとしてコンテンツキャッシュをするだけでなく、Minifyのような処理も追加オプションとして用意されています。これも使い方は単純にオプションを有効化すればよいだけで、自動的にHTMLやCSSなどのコンテンツを最適化してくれます。</p> <h2 id="aerobaticへの移行">Aerobaticへの移行</h2> <p>上記のように課題は解決されたので移行の必要性は高くありませんでしたが、機能面でGithub Pagesよりも多彩であることと、Aerobaticサーバ側から直接HTTPS通信をサポートすることができるのでこちらに移行することにしました。AerobaticでもCloudFlareと同様に証明書は無償で発行してもらえます。</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Client] ---&lt;HTTP/HTTPS&gt;--- [Aerobatic]
</code></pre></div></div> <p>AerobaticはGithubとGithub Pagesの関係と同様に、BitbucketとAerobaticというようにソースコードレポジトリと対にしてコンテンツを管理します。Aerobaticでは複数のブランチに対してサービスの設定が可能で、ステージング用のブランチとステージング用サブドメインを設定するといった運用ができます。</p> <p>コンテンツは公開順ごとにバージョンが振られていきロールバックなどもgit操作なしで簡単に行えます。</p> <p>他には、Githubでプライベートレポジトリは有償ですが、Bitbucketであればプライベートレポジトリも無償で利用できます。Jekyllのサイトデータであれば、公開してあっても特に困りませんが、あまりレポジトリ内のファイルが散らかっていると恥ずかしいので、、といった理由でプライベートにできたほうがうれしいですね。</p> <p><img src="/images/2017-01-15-website-versions.png" alt="Websiteバージョン"/></p> <p>実はTumblrからJekyllに移行する際の本命がこちらのAerobaticだったのですが後述の問題があったので取り急ぎGithub Pagesに移行することにしていました。</p> <h2 id="aerobaticでドメイン設定ができない">Aerobaticでドメイン設定ができない</h2> <p>AerobaticではCDNにAWSのCloudFrontを使っています。証明書はCloudFront側で発行されるものを使うのですが、この処理でエラーとなってしまい、ホスティングの設定ができませんでした。</p> <p>検索してもなかなか同様の報告が見当たらず解決の糸口がなかったのですが、今回とりあえずAerobaticのサポート宛てに問い合わせをしてみたところ、翌日には解決となりました。</p> <p>Aerobaticでカスタムドメインの設定をする際、まずCloudFront側からドメイン所有者であることを確認するためのメールを受け取り、承認処理を行います。この操作のあと、Aerobatic上でverify処理を進めれば次はDNSの設定。となるはずなのですがAerobatic上のverify処理で「CNAME already registered with CloudFront」というエラーがでて一向に進みません。</p> <p>このことをサポートに問い合わせたところ、すぐにエラーを解消してもらえたのですが、おそらく、ドメインwatermint.orgでCloudFrontを使ったことはなかったので承認処理手順の際に何かの拍子で2回処理が実行されてしまったのかもしれません。</p> <h2 id="jekyll-minifier--aerobatic">jekyll-minifier + Aerobatic</h2> <p>jekyll-minifierとAerobaticの組み合わせは先月試したときにはうまく動作したのですが、移行したタイミングでは動作しなくなってしまっていました。</p> <p>jekyll-minifierのリリース履歴を見ると2週間前に課題を解決するために、<a href="https://github.com/digitalsparky/jekyll-minifier/releases/tag/v0.1.0">0.1.0</a>がリリースされておりこの影響によるものでした。jekyll-minifierの参照については <code class="highlighter-rouge">_config.yml</code> に下記のように依存を書いておいただけだったのでバージョン指定はしていませんでした。</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">gems</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="s">jekyll-paginate</span>
 <span class="pi">-</span> <span class="s">jekyll-minifier</span>
</code></pre></div></div> <p>このように依存するライブラリのバージョンアップなどで急に動かなくなってしまっても不都合なので、<code class="highlighter-rouge">Gemfile</code>と<code class="highlighter-rouge">Gemfile.lock</code>でバージョンを固定しておくことにしました。Aerobaticの<a href="https://www.aerobatic.com/docs/automated-builds">Automated Builds</a>で説明がある通り、(1) <code class="highlighter-rouge">_plugins</code>にある<code class="highlighter-rouge">*.rb</code>ファイル、(2) <code class="highlighter-rouge">Gemfile</code>あるいは<code class="highlighter-rouge">Gemfile.lock</code>があれば<code class="highlighter-rouge">bundler</code>によるインストール、(3) <code class="highlighter-rouge">_config.yml</code>の<code class="highlighter-rouge">gems</code>配列。といった順でライブラリが参照されます。</p> <h2 id="aerobaticでの運用">Aerobaticでの運用</h2> <p>Aerobaticでは無償プランにて2つのドメインに対してHTTPSを含むコンテンツをホスティングすることができます。一方で無償版の制約としては1日のデプロイ回数が5回までに制限されていることです。</p> <p>一日に何度も記事を公開するようなブログであれば有償プランを選択する必要があります。また、上述のminifierのような処理を入れようとするタイミングではいろいろ試行錯誤するので5回という制約はかなり作業に影響します。Aerobaticは際立って高価なサービスではないので有償版にアップグレードしてもよいのですが、複数のドメインでサービスを提供したり、大量のコンテンツを持っているということもないので現状は見送って1日5回という制約の中で運用することにしています。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2016/12/31/digital-filing/"> デジタルファイリング - データの整理整頓 </a> </h1> <span class="post-date"> 31st December 2016</span> <span class="post-tags"> #<a href="/tags/cloudstorage">cloudstorage</a> #<a href="/tags/digitalfiling">digitalfiling</a> #<a href="/tags/dropbox">dropbox</a> #<a href="/tags/nas">nas</a> #<a href="/tags/productivity">productivity</a> </span> <p>気がつけばあっというまに2016年の大晦日。昨年の大晦日も大掃除をしたり、ファイルの整理をしたりと今年は整理整頓の一年でした。</p> <p>断捨離をしつつ部屋の掃除も一段落しましたが、今年はデジタルデータの整理にも時間をかけています。デジタルデータで特に時間をかけたのが写真の整理です。昨年末から約1年かけて紙などアナログデータと、デジタルデータの整理を続けてきました。<a href="http://watermint.org/2016/06/01/manage-100k-photos-and-choice-of-storage/">10万枚を超える写真データの整理とストレージ選び</a>でもご紹介した通りNASを廃してクラウドストレージに移行しました。</p> <p>この1年試行錯誤をして、整理整頓でこだわるべきだと感じたのは次の2点でした。</p> <ul> <li>なるべく長期保存に耐えるフォーマットに統一する</li> <li>なるべく階層を減らし、フラットな構造にする</li> </ul> <p>それぞれどのようにこだわったのか紹介していきます。</p> <h1 id="長期保存に耐えるフォーマットへの統一">長期保存に耐えるフォーマットへの統一</h1> <p>手元に残るうち、自分で作成した一番古いファイルのタイムスタンプを見ると1995年10月31日となっています。当時高校生でしたが、かれこれ20年以上経っています。ほとんどのファイルはまだ変換作業などすれば利用可能ですが、変換せずに閲覧できればファイルの利用価値はぐっと上がります。</p> <p>あまり古いドキュメントをいまさら変換するのは面倒ですし特にモチベーションもないのですが、最近つくったドキュメント類はPDF/XまたはPDF/Aで保存し、フォントや埋め込み画像なども含めた格好で保存するようにしています。</p> <p>ドキュメント類は上述のようにPDF/Aなどで保存していれば間違いないのですが、少し面倒なのが動画ファイルです。デジカメで撮った動画ファイルが手元にはたくさんありますが、デジカメの機種によってファイル形式はばらばらです。これらは一括で、H.264のようなに今どきの機器でプレビューしやすいフォーマットに変換しました。</p> <h2 id="紙からデジタルデータに">紙からデジタルデータに</h2> <p>紙のデータは10年程度前から積極的にデジタルデータ化しています。クレジットカードの申込書や明細、商品を買ったときに同封されていた注意書きの紙、携帯電話やインターネットサービスの申込書や規約、購入した家電の説明書など。</p> <p>同等のデジタルデータがダウンロードできる場合には、ダウンロードして保存しておき、そうでない場合にはスキャナーをつかってPDFデータにしておきます。</p> <p>紙媒体ではサイズがまちまちだったり、大きさや重さの制約があり一ヶ所に保存するのは難しいですがデジタルデータにしてしまえばフォーマットを統一して参照することができます。</p> <p>紙媒体では契約書など現物が必要なものもありますが、デジタルデータにしておくことで、契約年月日を知りたいとか、契約の種類が何だったかといった確認のためには重宝します。</p> <h1 id="なるべく階層を減らしフラットな構造にする">なるべく階層を減らし、フラットな構造にする</h1> <p>本屋に行くと「整理整頓」「片づけ上手」といったキーワードの本がたくさん見つかります。また、最近では「ミニマル」とか「断捨離」といったキーワードのように捨てることについて注目して説明している記事も多く見られます。</p> <p>デジタルファイリングもおそらくこの手法をそのまま採用できるだろうというのが最近の考えです。</p> <p>片づけ指南本によると基本的な考えは「よく使うものは手前に置く」というシンプルなルールであると指南されています。デジタルデータでもこれは同様です。ただ単純にフォルダ構成を考えればいいというわけではなく、仕事の進め方も同時に変えていく必要があります。</p> <h2 id="最近のファイル">最近のファイル</h2> <p>よく使うファイルというのはほとんどん場合最近つくったファイルです。</p> <p>最近書いている記事のファイル、最近とった写真、進行中のプロジェクトといったファイルが最小の手数で開ける位置にあれば作業効率はバカにならないほど改善します。</p> <p>ですから、Macならばファインダー、Windowsならばエクスプローラーを開いてすぐにこれらのファイルやフォルダにたどり着くことができるようにします。</p> <p>こういったファイルやフォルダをデスクトップに置いている人も多いでしょう。デスクトップの使い方については少しこだわりがあるのでこちらも紹介させていただきます。</p> <h2 id="デスクトップの整理">デスクトップの整理</h2> <p>個人的にはデスクトップは一時的な作業領域ととらえていて、一日の終わりに完全に空っぽの状態にしています。数年前受講したメール整理法の研修を受けました。この研修では「Inboxを毎日空っぽの状態にしましょう」という整理術を紹介していました。</p> <p>このメール整理術ではフォルダに割り振るか、TODOリストに加えるか、スケジュール帳に書き込むか、削除/アーカイブするか行き先はこの4つだけ。この狙いは、まぜこぜになった情報一覧から必要な情報を探すのにいちいち時間がかかってしまう時間ロスを減らすことにあります。</p> <p>デスクトップを空っぽにするのも同じ狙いです。たとえばプレゼンテーションスライドを作るときに大量の画像素材を準備するときは、デスクトップへ乱雑に置いていきます。ある程度情報を整理してプレゼンテーションスライドに配置が終わればスライドはプロジェクトのフォルダなどに整理しデスクトップは空っぽにします。</p> <p>もし、画像を乱雑にデスクトップへ置いたまま、別のプロジェクトの作業をデスクトップ上で始めてしまうと、どのファイルがプレゼンテーション用のものだったか探すための時間ロスが生まれます。さらにデスクトップを空っぽにするにしても、どれが不要なファイルなのか簡単に区別がつかないのでまた時間ロスがうまれたり、「念のため」ということでそのまま放置してしまうことになりがちです。</p> <h2 id="最近つくったファイルの置き場所">最近つくったファイルの置き場所</h2> <p>比較的よく利用する最近つくったファイルはWebサイトデザインなどの際によくいわれる「3クリックルール」を想定して整頓するとよいでしょう。チーム作業などのために、共有フォルダの構成が決まっている場合はショートカットなどを活用します。</p> <p><img src="/images/2016-12-31-finder.jpg" alt="開くフォルダの設定"/></p> <p>ファインダーであれば、ファインダーを開いた時に表示されるフォルダを設定できます。</p> <h2 id="すべてのファイルを一ヶ所に">すべてのファイルを一ヶ所に</h2> <p>ここまでは今までも似たような整理をしていたのですが、今年はNASや外付けハードディスクなどに保存していたすべてのファイルをDropboxに移行していったのでさらにファイリングを工夫しました。</p> <p>これまでバックアップのために外付けハードディスクに保存したりNASに分散管理するなどしていましたが、Dropboxに移行したことで冗長性の確保ついてはすべてDropboxに依存することにしました。これによって、同じファイルを手元で複数管理する必要がなくなったので、バックアップ頻度などバックアップ漏れがないことを意識しなくてよくなりました。</p> <p>整理を進めるに当たって、冗長管理をする必要がなくなったのは大きな進歩でした。すべてのファイルが一ヶ所にまとまっていますし、重複したファイルを持つ必要がなくなったので不要なファイルをどんどん削除することができました。ファイル数、フォルダ数が減ったことによってフォルダの見通しがよくなりました。検索も簡単です。</p> <h2 id="ファイル総量の制限">ファイル総量の制限</h2> <p>外付けハードディスクを利用していたときには要領あたりの単価が安いこともあって湯水のようにディスク領域を利用していました。いまはパソコンやDropboxの容量制限もありますが、主にファイル発見への時間ロスを考慮して総量制限をしています。</p> <p>ファイルが多すぎると探すための時間を使ってしまいます。ご家庭でもDeep learningなどで自動的に分類されて必要なファイルが探せる時代になればいいのですが、まだそういった使い方は先になりそうですから、時間ロスを減らすにはある程度ファイル総量を制限していくほうが理にかなっていると考えています。</p> <p>11月ごろにMacBook Proを買い替えて、内蔵SSDが1TBのモデルにしました。これはファイル総量はだいたい1TBぐらいだと時間ロスも防ぎつつ必要なファイルを保存していくためにちょうどいいのではないかなと考えたためです。</p> <p>これまでにデジカメで撮った10万枚の写真総量ではおおよそ2TB強ありました。特にNikon D800で撮影したRAWファイルは1枚当たり50MB前後とかなりの容量でした。ただ、ほとんどの写真は連射写真で個別に再利用することがなかったので、思い切ってすべて削除し、2TB強のデータを170GB程度までに削減しました。</p> <p>この制限によって、見返すことも簡単になりましたし、内蔵SSD上ですべて処理できるようになったので昔の写真を含めてすべてブラウズするといった操作もストレスなく快適になりました。</p> <h2 id="フラットに配置する">フラットに配置する</h2> <p>フォルダの見通しをさらによくするために、すべてのフォルダを3〜4クリック程度でたどり着けるように整理しました。フォルダ階層をなるべく減らしてソフトウエア等の制約で必要がない限り4階層までにおさえるようにしました。</p> <p>iPhoneやiPadなどのスマートデバイスでもたくさんタップをするよりは縦スクロールをしていくほうが簡単です。近年のパソコンでもタッチパッドなどが使いやすくなりスクロールは非常に簡単です。ですから、ファイルがフラットに並んでいるほうが階層が深くなっているよりもより目的のファイルを簡単に探すことができます。</p> <p><img src="/images/2016-12-31-flatten.jpg" alt="フォルダ階層"/></p> <p>五十音順／アルファベット順／日付順などファイルの種類におうじて工夫します。3年前から購読している新聞はすべてPDFでダウンロードができますが、新聞であれば日付順に並んでいると一目瞭然です。あまりファイルが多すぎても探しづらいので月ぐらいでフォルダを作っています。</p> <p>すべてのファイルをフラットに配置したことで、過去のファイルを参照することが日常的な作業になりました。NASや外付けハードディスクに保存していた時には、よほどの確信がなければできない作業だったのでこれは大きな変化です。</p> <h1 id="整理整頓とデジタルファイリング">整理整頓とデジタルファイリング</h1> <p>デジタルファイリングを工夫したことで過去の情報を扱うことが簡単になりました。10年前の家計簿を見直したり、冷蔵庫の製氷機を掃除する方法を調べたり、飲み会の場で友人に3年前の旅行写真を見せたり、2年前の新聞を見直すなど一ヶ所にデジタルデータとして保存していなければなかなか面倒でした。</p> <p>この十数年でインターネットで一般的な情報を探したり、現在進行中のニュースを知ることは安価でかんたんにできるようになりました。一方で、自分にかかわる過去の情報は自分自身で整理していないとインターネット以前と同様にかんたんには探すことができません。</p> <p>今年はデジタルファイリングが一区切りついたので、来年はこれらの情報を活用する方法を研究していきます。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2016/12/15/go-bandwidth-limit-for-multilpe-io/"> Go: 複数のReader/Writerに対する帯域幅制御 </a> </h1> <span class="post-date"> 15th December 2016</span> <span class="post-tags"> #<a href="/tags/bandwidth">bandwidth</a> #<a href="/tags/concurrency">concurrency</a> #<a href="/tags/go">go</a> </span> <p>ネットワークやディスクへの読み書き処理の際、帯域幅制御をしたい場合があります。低優先度の処理などによって主となるビジネスロジックが阻害されないよう制御するといった目的や、一つのサーバ資源で複数のサービスを提供するときに一つのサービスが資源を消費しすぎないようにしたいといった目的があります。</p> <p>Goでこのような処理を書きたいとき、ざっと調べてみたところ<a href="https://github.com/mxk/go-flowrate">go-flowrate</a>という実装が見つかりました。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">f</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data.dat"</span><span class="p">)</span><span class="x">

    </span><span class="c">// 100バイト/秒の帯域幅制御付きのラッパーをつくる</span><span class="x">
    </span><span class="n">f2</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">flowrate</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="x"> </span><span class="m">100</span><span class="p">)</span><span class="x">

    </span><span class="c">// 実際の処理</span><span class="x">
    </span><span class="c">// ...</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div> <p>使い方もシンプルできっちり制御できるのでこれでいいのですが、制御できるのが一つの<code class="highlighter-rouge">io.Reader</code>または<code class="highlighter-rouge">io.Writer</code>のみに対してのみ可能で、複数の<code class="highlighter-rouge">io.Reader</code>や<code class="highlighter-rouge">io.Writer</code>に対しては制御することができません。</p> <p>並列処理が必要なプログラムを書いているとちょっとこれではそのまま使えそうにありません。もう少しほかの選択肢を探してもよいのですが、ちょうどいいGoのプログラミング課題ということで新しく実装してみることにしました。</p> <h1 id="出来上がり">出来上がり</h1> <p>まずはでき上がったライブラリを紹介します。<a href="https://github.com/watermint/bwlimit">bwlimit</a>としてGithub上に公開してあります。利用例は次のようなイメージです。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="c">// 100バイト/秒に制限</span><span class="x">
    </span><span class="n">bwlimit</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">NewBwlimit</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="x"> </span><span class="no">false</span><span class="p">)</span><span class="x">

    </span><span class="c">// 複数のReader</span><span class="x">
    </span><span class="n">f1</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data1.dat"</span><span class="p">)</span><span class="x">
    </span><span class="n">f2</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data2.dat"</span><span class="p">)</span><span class="x">

    </span><span class="c">// ラッパーを作成</span><span class="x">
    </span><span class="n">fr1</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">bwlimit</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="x">
    </span><span class="n">fr2</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">bwlimit</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span><span class="x">

    </span><span class="c">// 実際の処理</span><span class="x">
    </span><span class="c">// ...</span><span class="x">

    </span><span class="c">// すべてのReaderがClose()されるかEOFになるまで待機</span><span class="x">
    </span><span class="n">bwlimit</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div> <p>まずは帯域幅制御を制御するオブジェクト(上図では<code class="highlighter-rouge">bwlimit</code>)を作り、さらにそれぞれラッパーを作成します。<code class="highlighter-rouge">NewBwlimit</code>の第二引数は帯域幅制限しているときRead/Write処理を待たせるかどうかです。</p> <p>あとはラッパーを普通の<code class="highlighter-rouge">io.Reader</code>として扱うだけです。並列処理をしていて、すべてのReaderまたはWriterについて処理が完了したかどうか知りたくなったので待機する<code class="highlighter-rouge">Wait()</code>もつくりました。</p> <h1 id="仕組み">仕組み</h1> <p>キューを作る方法などいくつか実装方法を検討しましたが最終的にはかなりシンプルな構造になりました。トヨタ生産方式の本を思い出してヒントを得ました。</p> <p><a href="https://ja.wikipedia.org/wiki/%E3%82%BF%E3%82%AF%E3%83%88%E3%82%BF%E3%82%A4%E3%83%A0">タクトタイム</a>という一定時間のリズムを刻んで、各拍子のタイミングで利用可能な帯域を現在有効なReader/Writerで分割して利用するアイデアです。</p> <p>たとえばタクトタイムを1秒間に10回に設定したとします。帯域幅設定を1000バイト/秒にした場合、タクトタイム1回あたりに利用可能な帯域幅は100バイトです。有効なReaderが2つであればこの100バイトをわけあって、50バイトずつの読み取りを許可する枠を設定します。実際に、Reader側が読み取るかどうかはわかりませんが、読み取り可能な上限を制御することでこのような流量制御を行っています。</p> <h1 id="流量制御と障害防止">流量制御と障害防止</h1> <p>あるタクトタイムのときに、読み取りが実際に発生せず50バイト分の枠がまるまるある状態で、次のタクトタイムになったとき読み取り可能枠を50 + 50バイト分にはしないようにしました。流量はこれによってすこし減ってしまいますが、意図しない障害を防ぐためです。</p> <p>読み取り可能枠が溜まりにたまって一気に転送が行われてしまうと、他のサービスへ影響がでることはもちろん、場合によってはルーターなどのバッファサイズを超えるなどして障害が発生することも考えられます。</p> <h1 id="利用例">利用例</h1> <p>また別の記事として各予定ですが、Dropboxへのファイルアップローダーをいま作っています。このファイルアップローダーで並列してファイルのアップロードをする際に、帯域幅制御をつけたかったのがこのライブラリ作成のモチベーションです。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2016/12/14/dmg-and-cli-en/"> Disk image file (.dmg) from command line </a> </h1> <span class="post-date"> 14th December 2016</span> <span class="post-tags"> #<a href="/tags/cli">cli</a> #<a href="/tags/dmg">dmg</a> #<a href="/tags/hdiutil">hdiutil</a> #<a href="/tags/keychain">keychain</a> #<a href="/tags/mac">mac</a> #<a href="/tags/security">security</a> </span> <p>I prefer .dmg instaed of zip for archiving project data, etc. <code class="highlighter-rouge">.dmg</code> is handy for refering files, modify contents without extract files to somewhere.</p> <p><code class="highlighter-rouge">.dmg</code> can usable as like USB drive. Disk Utility tool can create/update <code class="highlighter-rouge">.dmg</code> from folder with various options. Options are like encryption, readonly, compression, etc.</p> <p>But if you have tens of folders to archive, it’s better to use command line tools.</p> <h2 id="create-encrypted-dmg-file">Create encrypted <code class="highlighter-rouge">.dmg</code> file</h2> <p><code class="highlighter-rouge">hdiutil</code> is command line version of Disk Utility app. This command can mount/unmount/create/update disk image files. Please see <code class="highlighter-rouge">man hdiutil</code> for more detail.</p> <p>Below script is part of my workflow of archiving project files. I’m using encrypted <code class="highlighter-rouge">.dmg</code> for archive. The script require prepare password file under <code class="highlighter-rouge">$HOME/.dmg-password</code>. Please create and store password for <code class="highlighter-rouge">.dmg</code> without LF.</p> <p>And update permission like <code class="highlighter-rouge">chmod 600 $HOME/.dmg-password</code> to prevent read from other users. This sequence using password and encryption. But it’s not strong enough, reason described below.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span><span class="nt">-lt</span> 2 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="nv">$0</span> SRC_DIR DEST_DIR
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">SRC</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">DST</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">PWD</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/.dmg-password"</span>

<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-e</span> <span class="nv">$PWD</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo </span>Disk Image password not found
  <span class="nb">exit </span>2
<span class="k">fi

for </span>t <span class="k">in</span> <span class="s2">"</span><span class="nv">$SRC</span><span class="s2">"</span>/<span class="k">*</span><span class="p">;</span> <span class="k">do
  if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$t</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo </span>Creating: <span class="nv">$t</span>
    <span class="nv">n</span><span class="o">=</span><span class="k">$(</span><span class="nb">basename</span> <span class="nv">$t</span><span class="k">)</span>
    <span class="nb">cat</span> <span class="nv">$PWD</span> |                <span class="se">\</span>
      hdiutil create          <span class="se">\</span>
        <span class="nt">-srcfolder</span> <span class="s2">"</span><span class="nv">$t</span><span class="s2">"</span>       <span class="se">\</span>
        <span class="nt">-fs</span> HFS+              <span class="se">\</span>
        <span class="nt">-encryption</span> AES-128   <span class="se">\</span>
        <span class="nt">-format</span> UDBZ          <span class="se">\</span>
        <span class="nt">-stdinpass</span>            <span class="se">\</span>
        <span class="s2">"</span><span class="nv">$DST</span><span class="s2">/</span><span class="nv">$n</span><span class="s2">.dmg"</span>
  <span class="k">fi
done</span>
</code></pre></div></div> <h2 id="preset-password-for-dmg-in-key-chain">Preset password for <code class="highlighter-rouge">.dmg</code> in Key Chain</h2> <p>It’s kind of pain in neck entering password for opening <code class="highlighter-rouge">.dmg</code> everytime. If you open <code class="highlighter-rouge">.dmg</code> from Finder.app, the password dialog refuse copy &amp; paste operation.</p> <p><img src="/images/2016-12-13-dmg1.png" alt="Password dialog"/></p> <p>There is option “remember password in my keychain”. Concept is similar to this.</p> <p>The password for disk image is stored in keychain which identified by UUID of <code class="highlighter-rouge">.dmg</code>. The UUID is referable by command like below.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>hdiutil isencrypted YOURDISKIMAGE.dmg
</code></pre></div></div> <p>Now you can store password through <code class="highlighter-rouge">security</code> command.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>security add-generic-password <span class="nt">-a</span> <span class="o">(</span>UUID above<span class="o">)</span> <span class="nt">-D</span> <span class="s2">"disk image password"</span> <span class="nt">-s</span> <span class="o">(</span>YOUR DISK IMAGE<span class="o">)</span>.dmg <span class="nt">-w</span> <span class="o">(</span>PASSWORD OF DISK IMAGE<span class="o">)</span>
</code></pre></div></div> <p>Unfortunatelly, there are no option like <code class="highlighter-rouge">-stdinpass</code>. So the password must be passed through command line argument. This mean optential leak through <code class="highlighter-rouge">ps</code> command or shell history.</p> <p>By the way, I’m using below script for preset password to disk images.</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span><span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="nv">$0</span> <span class="o">[</span>dmg file]...
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">PWD</span><span class="o">=</span><span class="nv">$HOME</span>/.dmg-password

<span class="k">for </span>FILE <span class="k">in</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
  </span><span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>hdiutil isencrypted <span class="s2">"</span><span class="nv">$FILE</span><span class="s2">"</span> 2&gt;&amp;1 | <span class="nb">grep </span>uuid | <span class="nb">awk</span> <span class="s1">'{print $2}'</span><span class="k">)</span>
  <span class="nv">BASE</span><span class="o">=</span><span class="k">$(</span><span class="nb">basename</span> <span class="nv">$FILE</span><span class="k">)</span>

  <span class="nb">echo </span>File: <span class="nv">$BASE</span>
  <span class="nb">echo </span>UUID: <span class="nv">$UUID</span>

  security add-generic-password <span class="nt">-a</span> <span class="nv">$UUID</span> <span class="nt">-D</span> <span class="s2">"disk image password"</span> <span class="nt">-s</span> <span class="nv">$BASE</span> <span class="nt">-w</span> <span class="k">$(</span><span class="nb">cat</span> <span class="nv">$PWD</span><span class="k">)</span>
<span class="k">done</span>
</code></pre></div></div> <p>When opening <code class="highlighter-rouge">.dmg</code> from Finder, operating system ask authorisation of using password by <code class="highlighter-rouge">diskimages-helper</code>.</p> <p><img src="/images/2016-12-13-dmg2.png" alt="Confirmation dialog"/></p> <p>You can skip this dialog by <code class="highlighter-rouge">-A</code> option of <code class="highlighter-rouge">security</code> command, but this option authorise for all applications. It’s better not use this <code class="highlighter-rouge">-A</code> option for better security.</p> </div> </div> <div class="pagination"> <a class="pagination-item older" href="/page6">Older</a> <a class="pagination-item newer" href="/page4">Newer</a> </div> </div> <div class="container copyright"> &copy; 2005-2018 Takayuki Okazaki </div> </div> <label for="sidebar-checkbox" class="sidebar-toggle"></label> <script>!function(e){var c=e.querySelector(".sidebar-toggle"),r=e.querySelector("#sidebar"),t=e.querySelector("#sidebar-checkbox");e.addEventListener("click",function(e){var n=e.target;t.checked&&!r.contains(n)&&n!==t&&n!==c&&(t.checked=!1)},!1)}(document);</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-769616-6","auto"),ga("send","pageview");</script> </body> </html>