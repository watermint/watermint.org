<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> watermint.org &middot; Takayuki Okazaki's note </title> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/watermint-logo.png"> <link rel="shortcut icon" href="/public/watermint-logo.png"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <style>*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:serif;font-size:14px;line-height:1.8}@media(min-width:38em){html{font-size:20px}}body{color:#515151;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a strong{color:inherit}a:hover,a:focus{text-decoration:underline}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:bold;line-height:1.25;color:#313131;text-rendering:optimizeLegibility}h1{font-size:1.5rem;margin-top:1.6rem;margin-bottom:1.6rem}h2{margin-top:1.6rem;font-size:1.3rem}h3{margin-top:1.6rem;font-size:1.2rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}strong{color:#303030}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:bold}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:bold;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}code,pre{font-family:Menlo,Monaco,"Courier New",monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}.gist .gist-file{font-family:Menlo,Monaco,"Courier New",monospace!important}.gist .markdown-body{padding:15px}.gist pre{padding:0;background-color:transparent}.gist .gist-file .gist-data{font-size:.8rem!important;line-height:1.4}.gist code{padding:0;color:inherit;background-color:transparent;border-radius:0}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media(min-width:30em){blockquote{padding-right:5rem;padding-left:1.25rem}}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;border:1px solid #e5e5e5;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #e5e5e5}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#f9f9f9}.lead{font-size:1.25rem;font-weight:300}.message{margin-bottom:1rem;padding:1rem;color:#717171;background-color:#f9f9f9}.container{max-width:38rem;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.post-tags{display:block;margin-top:-.5rem;margin-bottom:1rem;text-align:right}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:"PT Sans",Helvetica,Arial,sans-serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}html,body{overflow-x:hidden;line-height:1.9em}html{font-family:serif}h1,h2,h3,h4,h5,h6{font-weight:400;color:#313131}.wrap{position:relative;width:100%}.container{max-width:28rem}@media(min-width:38em){.container{max-width:32rem}}@media(min-width:56em){.container{max-width:38rem}}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem;border-bottom:1px solid #eee}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}@media(max-width:48em){.masthead-title{text-align:center}.masthead-title small{display:none}}.sidebar{position:fixed;top:0;bottom:0;left:-14rem;width:14rem;visibility:hidden;overflow-y:auto;font-family:serif;font-size:.875rem;line-height:1.4em;color:rgba(255,255,255,.6);background-color:#202020;-webkit-transition:all .3s ease-in-out;transition:all .3s ease-in-out}
@media(min-width:30em){.sidebar{font-size:.75rem}}.sidebar a{font-weight:normal;color:#fff}.sidebar-item{padding:1rem}.sidebar-item p:last-child{margin-bottom:0}.sidebar-nav{border-bottom:1px solid rgba(255,255,255,.1)}.sidebar-nav-item{display:block;padding:.5rem 1rem;border-top:1px solid rgba(255,255,255,.1)}.sidebar-nav-item.active,a.sidebar-nav-item:hover,a.sidebar-nav-item:focus{text-decoration:none;background-color:rgba(255,255,255,.1);border-color:transparent}@media(min-width:48em){.sidebar-item{padding:1.5rem}.sidebar-nav-item{padding-left:1.5rem;padding-right:1.5rem}}.sidebar-checkbox{position:absolute;opacity:0;-webkit-user-select:none;-moz-user-select:none;user-select:none}.sidebar-toggle{position:absolute;top:.8rem;left:1rem;display:block;padding:.25rem .75rem;color:#555;border-radius:.25rem;cursor:pointer}.sidebar-toggle:before{display:inline-block;width:1rem;height:.75rem;content:"";background-image:-webkit-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-moz-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-ms-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%)}.sidebar-toggle:active,#sidebar-checkbox:focus ~ .sidebar-toggle,#sidebar-checkbox:checked ~ .sidebar-toggle{color:#fff}.sidebar-toggle:active:before,#sidebar-checkbox:focus ~ .sidebar-toggle:before,#sidebar-checkbox:checked ~ .sidebar-toggle:before{background-image:-webkit-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-moz-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-ms-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%)}@media(min-width:30.1em){.sidebar-toggle{position:fixed}}@media print{.sidebar-toggle{display:none}}.wrap,.sidebar,.sidebar-toggle{-webkit-backface-visibility:hidden;-ms-backface-visibility:hidden;backface-visibility:hidden}.wrap,.sidebar-toggle{-webkit-transition:-webkit-transform .3s ease-in-out;transition:transform .3s ease-in-out}#sidebar-checkbox:checked+.sidebar{z-index:10;visibility:visible}#sidebar-checkbox:checked ~ .sidebar,#sidebar-checkbox:checked ~ .wrap,#sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(14rem);-ms-transform:translateX(14rem);transform:translateX(14rem)}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}.layout-reverse .sidebar{left:auto;right:-14rem}.layout-reverse .sidebar-toggle{left:auto;right:1rem}.layout-reverse #sidebar-checkbox:checked ~ .sidebar,.layout-reverse #sidebar-checkbox:checked ~ .wrap,.layout-reverse #sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(-14rem);-ms-transform:translateX(-14rem);transform:translateX(-14rem)}.theme-base-08 .sidebar,.theme-base-08 .sidebar-toggle:active,.theme-base-08 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#ac4142}.theme-base-08 .container a,.theme-base-08 .sidebar-toggle,.theme-base-08 .related-posts li a:hover{color:#ac4142}.theme-base-09 .sidebar,.theme-base-09 .sidebar-toggle:active,.theme-base-09 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#d28445}.theme-base-09 .container a,.theme-base-09 .sidebar-toggle,.theme-base-09 .related-posts li a:hover{color:#d28445}.theme-base-0a .sidebar,.theme-base-0a .sidebar-toggle:active,.theme-base-0a #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#f4bf75}
.theme-base-0a .container a,.theme-base-0a .sidebar-toggle,.theme-base-0a .related-posts li a:hover{color:#f4bf75}.theme-base-0b .sidebar,.theme-base-0b .sidebar-toggle:active,.theme-base-0b #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#90a959}.theme-base-0b .container a,.theme-base-0b .sidebar-toggle,.theme-base-0b .related-posts li a:hover{color:#90a959}.theme-base-0c .sidebar,.theme-base-0c .sidebar-toggle:active,.theme-base-0c #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#75b5aa}.theme-base-0c .container a,.theme-base-0c .sidebar-toggle,.theme-base-0c .related-posts li a:hover{color:#75b5aa}.theme-base-0d .sidebar,.theme-base-0d .sidebar-toggle:active,.theme-base-0d #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#6a9fb5}.theme-base-0d .container a,.theme-base-0d .sidebar-toggle,.theme-base-0d .related-posts li a:hover{color:#6a9fb5}.theme-base-0e .sidebar,.theme-base-0e .sidebar-toggle:active,.theme-base-0e #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#aa759f}.theme-base-0e .container a,.theme-base-0e .sidebar-toggle,.theme-base-0e .related-posts li a:hover{color:#aa759f}.theme-base-0f .sidebar,.theme-base-0f .sidebar-toggle:active,.theme-base-0f #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#8f5536}.theme-base-0f .container a,.theme-base-0f .sidebar-toggle,.theme-base-0f .related-posts li a:hover{color:#8f5536}.sidebar-overlay #sidebar-checkbox:checked ~ .wrap{-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0)}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar-toggle{box-shadow:0 0 0 .25rem #fff}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:.25rem 0 .5rem rgba(0,0,0,.1)}.layout-reverse.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:-.25rem 0 .5rem rgba(0,0,0,.1)}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight,.highlight .w{color:#586e75}.highlight .err{color:#002b36;background-color:#dc322f}.highlight .c,.highlight .cd,.highlight .cm,.highlight .c1,.highlight .cs{color:#657b83}.highlight .cp{color:#b58900}.highlight .nt{color:#b58900}.highlight .o,.highlight .ow{color:#93a1a1}.highlight .p,.highlight .pi{color:#93a1a1}.highlight .gi{color:#859900}.highlight .gd{color:#dc322f}.highlight .gh{color:#268bd2;background-color:#002b36;font-weight:bold}.highlight .k,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .kv{color:#6c71c4}.highlight .kc{color:#cb4b16}.highlight .kt{color:#cb4b16}.highlight .kd{color:#cb4b16}.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .sh,.highlight .sx,.highlight .s1{color:#859900}.highlight .sr{color:#2aa198}.highlight .si{color:#d33682}.highlight .se{color:#d33682}.highlight .nn{color:#b58900}.highlight .nc{color:#b58900}.highlight .no{color:#b58900}.highlight .na{color:#268bd2}.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .il,.highlight .mo,.highlight .mb,.highlight .mx{color:#859900}.highlight .ss{color:#859900}.copyright{font-size:.8em;font-style:italic;color:#555}</style> </head> <body class="theme-base-09"> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"> <div class="sidebar" id="sidebar"> <div class="sidebar-item"> <p>Travel, camera, photo, and technical things. I work at Dropbox. Thoughts are my own.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Archive</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> <a class="sidebar-nav-item" href="/atom.xml">Feed</a> <a class="sidebar-nav-item" href="https://github.com/watermint">Github</a> </nav> <div class="sidebar-item"> <p> &copy; 2005-2022 Takayuki Okazaki </p> </div> </div> <div class="wrap"> <div class="masthead"> <div class="container"> <h3 class="masthead-title"> <a href="/" title="Home">watermint.org</a> <small>- Takayuki Okazaki's note</small> </h3> </div> </div> <div class="container content"> <div class="posts"> <div class="post"> <h1 class="post-title"> <a href="/2018/03/27/golang-csvfile-with-bom/"> GolangでBOM付きCSVファイルを読み込む </a> </h1> <span class="post-date"> 27th March 2018</span> <span class="post-tags"> #<a href="/tags/csv">csv</a> #<a href="/tags/go">go</a> #<a href="/tags/golang">golang</a> #<a href="/tags/unicode">unicode</a> </span> <p>先行事例・解決策は山ほどあるかと思いますが、はまったのでメモがてら解決方法を。BOM付きUTF16などでエンコードされたテキストを扱うに当たって、ライブラリなどが対応してくれているといいのですが、GolangのCSVReaderは対応していないようです。このため、次のような関数を準備してエンコーディングを変換してやります。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">NewBomAwareCsvReader</span><span class="p">(</span><span class="n">r</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span> <span class="o">*</span><span class="n">csv</span><span class="o">.</span><span class="n">Reader</span> <span class="p">{</span>
  <span class="k">var</span> <span class="p">(</span>
    <span class="n">bomUtf8</span>    <span class="o">=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="m">0xef</span><span class="p">,</span> <span class="m">0xbb</span><span class="p">,</span> <span class="m">0xbf</span><span class="p">}</span>
    <span class="n">bomUtf16BE</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="m">0xfe</span><span class="p">,</span> <span class="m">0xff</span><span class="p">}</span>
    <span class="n">bomUtf16LE</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="m">0xff</span><span class="p">,</span> <span class="m">0xfe</span><span class="p">}</span>
  <span class="p">)</span>
  <span class="n">br</span> <span class="o">:=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
  <span class="n">mark</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">br</span><span class="o">.</span><span class="n">Peek</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c">// decoder</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">unicode</span><span class="o">.</span><span class="n">UTF8</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">()</span>

  <span class="k">if</span> <span class="n">bytes</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">mark</span><span class="p">,</span> <span class="n">bomUtf8</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">br</span><span class="o">.</span><span class="n">Discard</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bomUtf8</span><span class="p">))</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">bytes</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">mark</span><span class="p">,</span> <span class="n">bomUtf16BE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">unicode</span><span class="o">.</span><span class="n">UTF16</span><span class="p">(</span><span class="n">unicode</span><span class="o">.</span><span class="n">BigEndian</span><span class="p">,</span> 
      <span class="n">unicode</span><span class="o">.</span><span class="n">UseBOM</span><span class="p">)</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">()</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">bytes</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">mark</span><span class="p">,</span> <span class="n">bomUtf16LE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">unicode</span><span class="o">.</span><span class="n">UTF16</span><span class="p">(</span><span class="n">unicode</span><span class="o">.</span><span class="n">LittleEndian</span><span class="p">,</span>
     <span class="n">unicode</span><span class="o">.</span><span class="n">UseBOM</span><span class="p">)</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">csv</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">br</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div> <p>あとはファイルを読み込めば変換できます。ひとまず必要が無かったので対応しませんでしたが、<a href="https://godoc.org/golang.org/x/text/encoding/unicode/utf32">utf32パッケージ</a>を使って同様処理を追加してやればUTF32も対応できます。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2018/02/19/googlemaps-to-dayone2/"> Googleマップのスターが消える問題と、Day One 2に移行した話 </a> </h1> <span class="post-date"> 19th February 2018</span> <span class="post-tags"> #<a href="/tags/dayone">dayone</a> #<a href="/tags/googlemaps">googlemaps</a> </span> <p>Google Mapsのスターとは、お気に入りのレストランなどにスターをつけてメモしておけるというものです。旅行先で行こうと考えている観光スポット、知人から教わったおすすめレストランなど今まで記録はすべてGoogle Mapsでスターをつけることでメモしていました。 ただこの便利な機能にも不満が2点。一つはスターが勝手に消えてしまうことで。二つ目があまり追加情報が書き込めないことです。</p> <p><img src="/images/2018-02-19-googlemaps.jpg" alt="Google Mapsでのスター"/></p> <p>今回はGoogle Mapsでスターをつけた位置をDay One 2の記事として移行した際のお話です。なお各種仕様は変わるかもしれませんので試される際には自己責任で。</p> <h1 id="google-mapsでの2つの課題">Google Mapsでの2つの課題</h1> <h2 id="課題1-スターが消える問題">課題1: スターが消える問題</h2> <p>まず一つ目のスターが勝手に消えてしまう問題について。少し検索してみると下記のように詳細に調査されている記事が見つかりました。</p> <ul> <li><a href="http://www.bousaid.com/entry/2017/06/05/081606">Googleマップの「スター」(お気に入りの場所)が、古いものから消えて表示されなくなる問題</a></li> </ul> <p>いろいろ丁寧に検証されているので大変参考になりました。結局、保存はされているが、どうやら表示数に制限があり、古いものから表示されなくなるのではとのこと。データが保存されていても簡単に取り出せないとするとあまり保存している意味もありません。</p> <h2 id="課題2-追加情報が書き込めない">課題2: 追加情報が書き込めない</h2> <p>この中華料理屋さんの担々麺がおいしいとか、この焼き鳥屋さんは塩よりタレがおすすめとか些細ではあるものの、教えてもらった情報は書き留めておきたいものです。Google Mapsでは最近スターの種類が増えたのでカテゴリごとにスターを分けたりできますが、それでも追加情報を書き込むという段階まではたどり着きません。</p> <p>Google+などSNSを使って管理する方法もあるのですが、各所に情報が分散しても使いづらいですし、自分で投稿したものにもかかわらず検索が難しいので数年前からこの目的のためにSNSは利用していません。</p> <h1 id="day-one-2へ移行">Day One 2へ移行</h1> <p><a href="http://dayoneapp.com/">Day One 2</a>はもともと日記などライフログをつけるためのアプリです。写真やメモに対して位置情報やタグなどを追加して情報を管理することができます。</p> <p>Day Oneは2013年頃から使い始めていて、ようやく最近Day One 2へ移行を完了しました。Day One 2では基本的な使い勝手はそのままにかなり機能が追加されています。よく見ると、Day One 2ではJSON Zip Fileという形式でデータをエクスポートしたり、インポートすることができます。これを使えば、Google Mapsから一括してデータを読み込みできそうです。</p> <h2 id="day-one-2のjson-zip-file形式">Day One 2のJSON Zip File形式</h2> <p>JSON Zip File形式のドキュメントは見つかりませんでしたが、データ形式としてはごく単純なものです。ZIPファイルの中にJournalごとのJSONファイルと、写真データが格納されています。Day One 2にデータをインポートするにはこのJSONファイルをインポートすれば良さそうです。</p> <p>JSONファイルは次のようなフォーマットです。Day One 2 version 2.5.10にて幾つかテストをしてみたところ、インポートの際には記事ごとのuuidは振らなくても自動的に発番されるので問題ありません。locationデータについても緯度(longitude)・経度(latitude)のみあればよく他は省略してもインポートは成功します。</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"metadata"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"version"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0"</span><span class="w">
</span><span class="p">},</span><span class="w">
</span><span class="nl">"entries"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"starred"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"location"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"region"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"center"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"longitude"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">120.1973037719727</span><span class="p">,</span><span class="w">
        </span><span class="nl">"latitude"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">22.99810981750488</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"radius"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">75</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"longitude"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">120.1973</span><span class="p">,</span><span class="w">
    </span><span class="nl">"placeName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"有方公寓 Your Fun Apartment"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"latitude"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">22.99811</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"creationDate"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-03-14T11:35:05Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"text"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"[有方公寓 Your Fun Apartment](http:</span><span class="se">\/\/</span><span class="s2">maps.google.com</span><span class="se">\/</span><span class="s2">?cid=1337703935590192274)</span><span class="se">\n\n</span><span class="s2">No. 9, Lane 269, Section 2, Hai'an Road, West Central District, Tainan City, Taiwan 700"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timeZone"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Asia</span><span class="se">\/</span><span class="s2">Tokyo"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"uuid"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"345585B421AF47DEA98B497C66CFBF8F"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"duration"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">]}</span><span class="w">
</span></code></pre></div></div> <h2 id="google-takeoutでスター一覧を取得">Google Takeoutでスター一覧を取得</h2> <p>Google TakeoutでスターをつけたデータをGeoJSONとして取り出します。手順については先ほど掲載させていただいた<a href="http://www.bousaid.com/entry/2017/06/05/081606">Googleマップの「スター」(お気に入りの場所)が、古いものから消えて表示されなくなる問題</a>に詳しく書かれています。</p> <p>GeoJSONの中身をみてみると以下のように緯度、経度、タイトル、Google Maps上でのURLなどが得られることがわかりました。</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"FeatureCollection"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"features"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"geometry"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"coordinates"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">120.1972925</span><span class="p">,</span><span class="w"> </span><span class="mf">22.9981111</span><span class="w"> </span><span class="p">],</span><span class="w">
      </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Point"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Google Maps URL"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"http://maps.google.com/?cid=1337703935590192274"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Location"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Address"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"No. 9, Lane 269, Section 2, Hai'an Road, West Central District, Tainan City, Taiwan 700"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Business Name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"有方公寓 Your Fun Apartment"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Country Code"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"TW"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Geo Coordinates"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"Latitude"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"22.9981111"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"Longitude"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"120.1972925"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Published"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-03-14T11:35:05Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Title"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"有方公寓 Your Fun Apartment"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Updated"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"2017-02-22T12:03:22Z"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Feature"</span><span class="w">
  </span><span class="p">},</span><span class="w">
</span><span class="p">]}</span><span class="w">
</span></code></pre></div></div> <h2 id="day-one-2のjson-zip-file形式に変換">Day One 2のJSON Zip File形式に変換</h2> <p>あとは形式を変更するだけですが、JSON同士の変換となるので簡単です。今回はRubyで書きました。ライセンスはMITライセンスとしておきます。</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># MIT License</span>
<span class="c1"># </span>
<span class="c1"># Copyright (c) 2018 Takayuki Okazaki</span>
<span class="c1"># </span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining</span>
<span class="c1"># a copy of this software and associated documentation files (the</span>
<span class="c1"># "Software"), to deal in the Software without restriction, including</span>
<span class="c1"># without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="c1"># distribute, sublicense, and/or sell copies of the Software, and to</span>
<span class="c1"># permit persons to whom the Software is furnished to do so, subject to</span>
<span class="c1"># the following conditions:</span>
<span class="c1"># </span>
<span class="c1"># The above copyright notice and this permission notice shall be</span>
<span class="c1"># included in all copies or substantial portions of the Software.</span>
<span class="c1"># </span>
<span class="c1"># THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,</span>
<span class="c1"># EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="c1"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.</span>
<span class="c1"># IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY</span>
<span class="c1"># CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,</span>
<span class="c1"># TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE</span>
<span class="c1"># SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>

<span class="nb">require</span> <span class="s1">'json'</span>

<span class="k">def</span> <span class="nf">feature2entry</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">geo</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="s1">'Geo Coordinates'</span><span class="p">)</span>
      <span class="n">f</span><span class="p">[</span><span class="s1">'Geo Coordinates'</span><span class="p">][</span><span class="n">l</span><span class="p">]</span>
    <span class="k">elsif</span> <span class="n">f</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
      <span class="n">f</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nb">p</span> <span class="n">feature</span>
      <span class="nb">exit</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">if</span> <span class="n">feature</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">].</span><span class="nf">key?</span><span class="p">(</span><span class="s1">'Address'</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n\n</span><span class="si">#{</span><span class="n">feature</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">][</span><span class="s1">'Address'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">else</span>
    <span class="n">address</span> <span class="o">=</span> <span class="s1">''</span>
  <span class="k">end</span>
  <span class="k">if</span> <span class="n">feature</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">].</span><span class="nf">key?</span><span class="p">(</span><span class="s1">'Business Name'</span><span class="p">)</span>
    <span class="n">place_name</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">][</span><span class="s1">'Business Name'</span><span class="p">]</span>
  <span class="k">else</span>
    <span class="n">place_name</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s1">'Title'</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="p">{</span>
    <span class="ss">:location</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:placeName</span> <span class="o">=&gt;</span> <span class="n">place_name</span><span class="p">,</span>
      <span class="ss">:longitude</span> <span class="o">=&gt;</span> <span class="n">geo</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">],</span> <span class="s1">'Longitude'</span><span class="p">).</span><span class="nf">to_f</span><span class="p">,</span>
      <span class="ss">:latitude</span>  <span class="o">=&gt;</span> <span class="n">geo</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">],</span> <span class="s1">'Latitude'</span><span class="p">).</span><span class="nf">to_f</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">"[</span><span class="si">#{</span><span class="n">feature</span><span class="p">[</span><span class="s1">'Title'</span><span class="p">]</span><span class="si">}</span><span class="s2">](</span><span class="si">#{</span><span class="n">feature</span><span class="p">[</span><span class="s1">'Google Maps URL'</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="si">#{</span><span class="n">address</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
    <span class="ss">:creationDate</span> <span class="o">=&gt;</span> <span class="n">feature</span><span class="p">[</span><span class="s1">'Published'</span><span class="p">],</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">dayone</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
  <span class="n">journal</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">:metadata</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="s2">"1.0"</span>
    <span class="p">},</span>
    <span class="ss">:entries</span> <span class="o">=&gt;</span> <span class="n">entries</span>
  <span class="p">}</span>
  <span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="n">journal</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">geojson</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">'Saved Places.json'</span><span class="p">))</span>
<span class="n">entries</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">[</span><span class="n">geojson</span><span class="p">[</span><span class="s1">'features'</span><span class="p">].</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">'properties'</span><span class="p">][</span><span class="s1">'Google Maps URL'</span><span class="p">],</span> <span class="n">f</span><span class="p">]</span> <span class="p">}]</span>
<span class="n">journal</span> <span class="o">=</span> <span class="n">dayone</span><span class="p">(</span><span class="n">entries</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">feature2entry</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">'properties'</span><span class="p">])</span> <span class="p">})</span>

<span class="nb">puts</span> <span class="n">journal</span>
</code></pre></div></div> <p>あとはこの出力を Location.json など新しいジャーナル名として保存し、zipファイルにしてインポートします。これで無事にDay One 2に読み込み完了です。あとは、ゴミデータを削除したり、中華料理とか和食とかタグをつけて整理すれば完了です。</p> <p><img src="/images/2018-02-19-dayone1.jpg" alt="記事として読み込まれた位置情報"/></p> <p>地図表示に切り替えればGoogle Mapsと同じように周辺の地図といままでメモした場所を一覧して確認することができます。</p> <p><img src="/images/2018-02-19-dayone2.jpg" alt="地図表示"/></p> </div> <div class="post"> <h1 class="post-title"> <a href="/2018/01/22/dropbox-api-path/"> Dropbox API: ネームスペースとパスの表現 </a> </h1> <span class="post-date"> 22nd January 2018</span> <span class="post-tags"> #<a href="/tags/api">api</a> #<a href="/tags/dropbox">dropbox</a> #<a href="/tags/dropboxapi">dropboxapi</a> </span> <p>Dropbox APIファイル操作をするときに必ず必要になってくるのがネームスペースの概念とファイルやフォルダへのパスです。実際にはほとんど意識することなく使えるのですが、知っていると見えてくる仕様もあるのでそのあたりを詳しく見てみましょう。</p> <h1 id="dropboxがどのようにファイルを管理しているか">Dropboxがどのようにファイルを管理しているか</h1> <p>Dropboxがどのようにファイルを管理しているかみていきます。まずは次の記事を参照してみます。</p> <ul> <li><a href="https://blogs.dropbox.com/tech/2014/07/streaming-file-synchronization/">Streaming File Synchronization</a></li> </ul> <p>これはStreaming同期という機能を紹介したブログエントリですがDropboxファイルシステムについても言及しています。Dropboxでは、ファイルシステムを抽象化するにあたってネームスペースという概念を定義しています。ネームスペースはすべてのユーザーのルートフォルダにあたり、また共有フォルダのように他のユーザーと共有しているスペースについては別のネームスペースが与えられます。</p> <p>ユーザーがいくつかの共有フォルダを持っている場合、それぞれの共有フォルダのネームスペースは特定のパス以下に<a href="https://ja.wikipedia.org/wiki/Mount_(UNIX)">マウントされている</a>状態となります。</p> <h1 id="パスの書式">パスの書式</h1> <p><a href="https://www.dropbox.com/developers/documentation/http/documentation">APIドキュメント</a>のPath formatsというセクションに詳しく書かれていますがいくつか特徴をピックアップしてみます。</p> <ul> <li>”” (空文字列)はルートフォルダを示す (ルートフォルダは “/” ではない)</li> <li>すべてのファイルやフォルダはIDを持っていて、このIDでも表現できる (例: <code class="language-plaintext highlighter-rouge">"id:abc123xyz"</code>)</li> <li>IDで表現したフォルダからさらに相対パスを指定できる (例: <code class="language-plaintext highlighter-rouge">"id:abc123xyz/hello.txt"</code>)</li> <li>ネームスペースIDを指定して、相対パスを指定できる (例: <code class="language-plaintext highlighter-rouge">"ns:12345/cupcake.png"</code>)</li> <li>アルファベット大文字小文字の違いは無視されて、/A/B/c.txtも/a/b/c.txtも同一視される</li> <li>パスの区切り文字は “/”. Windowsで利用されている “" ではありませんのでご注意</li> </ul> <p>なお、ネームスペースIDやフォルダのIDを指定した場合、当然ながら該当フォルダなどへのアクセス権限が必要となります。</p> <h2 id="実行例">実行例</h2> <p>下図はルートフォルダからのファイル一覧を取得する例です。ルートフォルダから一覧を取得するためにpathには”“を指定しています。</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST https://api.dropboxapi.com/2/files/list_folder <span class="se">\</span>
    <span class="nt">--header</span> <span class="s2">"Authorization: Bearer &lt;access token&gt;"</span> <span class="se">\</span>
    <span class="nt">--header</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
    <span class="nt">--data</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">path</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"\"</span><span class="s2">}"</span>
</code></pre></div></div> <p>ルートフォルダを示すためにもし、”/” のようにスラッシュを入れてしまうと次のようなエラーが返されます。</p> <blockquote> <p>Error in call to API function “files/list_folder”: request body: path: Specify the root folder as an empty string rather than as “/”.</p> </blockquote> <h1 id="ネームスペース">ネームスペース</h1> <p>ネームスペースについてもう少し詳しく見てみましょう。<a href="https://www.dropbox.com/developers/reference/namespace-guide">Namespace Guide</a>にいくつか例がありますが、契約しているプランなどによって共有フォルダなどの種類に若干違いがあります。</p> <p>ネームスペースとなるものとしては下記5つが列挙されています。いずれの場合も、ネームスペース = アクセス制御の範囲と考えると良いでしょう。</p> <ul> <li>ユーザーのホームフォルダ</li> <li>共有フォルダ</li> <li>チームフォルダ</li> <li>チームルートフォルダ</li> <li>アプリケーションフォルダ</li> </ul> <p>ユーザーのホームフォルダはユーザー毎に作成されるものです。共有フォルダは共有フォルダとして新しくフォルダを共有した段階でそのフォルダが独立した別のネームスペースとして管理されます。</p> <p>チームフォルダにはいくつか種類があるのですがどの場合でも独立したネームスペースとして管理されます。<a href="https://www.dropbox.com/help/business/team-folders">チームフォルダではチームフォルダ以下に作成したフォルダに追加のメンバーを設定することができるなど、共有フォルダにはできない設定が可能です</a>。この場合、追加のメンバーを設定した下位のフォルダも実装上は別のネームスペースとして管理されることになります。</p> <p>アプリケーションフォルダはアクセス範囲を制限した、Dropbox APIを利用するアプリケーション向けのフォルダです。各ユーザーのルートフォルダ以下「<code class="language-plaintext highlighter-rouge">/アプリ/&lt;アプリ名&gt;</code>」のようなフォルダにアプリケーション専用のデータを格納することができます。アプリケーションからみるとこのフォルダがルートフォルダとなり、ユーザーのホームフォルダなど他のネームスペースとなる部分にはアクセスできません。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2017/12/16/toolbox/"> Dropbox用ユーティリティ toolbox </a> </h1> <span class="post-date"> 16th December 2017</span> <span class="post-tags"> #<a href="/tags/dropbox">dropbox</a> #<a href="/tags/dropboxapi">dropboxapi</a> #<a href="/tags/toolbox">toolbox</a> </span> <p>Dropbox APIを使ったプログラムを昨年から幾つか作っています。いまこぢんまりと作っているのが<a href="https://github.com/watermint/toolbox">toolbox</a>というプログラムで今回はこれについて少し紹介させてください。</p> <p>toolboxはGoで書いているプログラムで、ファイルの操作やDropbox Businessチーム管理などの機能をコマンドラインから実行できるようにしたい。というものです。 Dropbox APIのようなAPIを直接呼び出すのは面倒でも、コマンドラインになっていればシェルスクリプトなどからコマンドを組み合わせて簡単に使えるからです。</p> <p>このtoolboxには類似のプロジェクトとして<a href="https://github.com/dropbox/dbxcli">dbxcli</a>というものがあります。これも、コマンドラインからファイル管理やDropbox Businessチーム管理を実現するようなものです。</p> <p>車輪の再発明的ですが解決しようとしている問題がすこし違うのでその点について紹介できればと思っています。</p> <h1 id="toolboxのねらい">toolboxのねらい</h1> <p>ファイルの移動やコピー操作などはエクスプローラーやFinderなどでやれば簡単ですが、大量のファイルとなるとそうはいかないことが多いです。たとえば4TBのハードディスクから、4TB空きのあるNASへコピーするというのは意外とやっかいです。ネットワーク接続が切れて途中で失敗したり、パソコンがフリーズしたり、何かとトラブルにぶつかります。</p> <p>NASからDropboxへ移行したり、前職で大量のファイルやサーバを管理していた経験から、こういったときには<code class="language-plaintext highlighter-rouge">rsync</code>などのように信頼がおけ、帯域制御、再実行などもよく考えられたコマンドを利用するようにしています。</p> <p>toolboxは単にコマンドラインで簡単に実行できるようにするというよりは、実運用において信頼性のおけるコマンドになることを目指しています。</p> <h1 id="大量ファイルフォルダへの対応">大量ファイル・フォルダへの対応</h1> <p>Dropboxへアップロードしたファイル数が増加してくると、場合によってはパフォーマンスに影響がでると言われています。<a href="https://www.dropbox.com/help/space/file-storage-limit">Dropbox で保存可能なファイル件数</a>によれば30万件を超えるとパフォーマンスが低下してくるそうです。</p> <p>実際に、自分のアカウントにNASから移行した70〜80万ファイルを置いていたときには、同期処理完了までの時間が気になることがありました。これらのファイルを別のフォルダに移動したり、保存しているフォルダ名を変更するとかなりの時間がかかってしまいます。</p> <p>処理が遅いだけでいずれは終了するのですがもう少し早く解決できないかということで大量のファイル向けの処理をコマンドラインから実行できるようにしました。</p> <h1 id="利用方法">利用方法</h1> <p>現在の実装では移動とコピーを実装しています。(まだちゃんと自動テストなど整備できていませんし、動作を保証するものではありませんのでご利用の際には自己責任で)</p> <p>バイナリはGoでコンパイルしたものでWindows版(32bit)、Linux版(32bit)、macOS版(64bit)を用意しています。下図はmacOSでの実行例ですがコマンドラインから展開したファイルのうち、OSや環境に合わせたものを実行してもらうと利用方法が出力されます。macOS版はdarwinと名前のついたものです。</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% ./tbx-32.1.0.0-darwin-10.6-amd64

Usage: ./tbx-32.1.0.0-darwin-10.6-amd64 COMMAND

Available commands:
  file       File operation


Run <span class="s1">'./tbx-32.1.0.0-darwin-10.6-amd64 COMMAND'</span> <span class="k">for </span>more information on a command.

please specify sub <span class="nb">command</span>
</code></pre></div></div> <p>プログラムの引数にコマンド、サブコマンド、パラメータなどを指定していきます。ファイルを移動する場合には次のように実行します。</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% ./tbx-32.1.0.0-darwin-10.6-amd64 file move /移動もとパス /移動先のパス
</code></pre></div></div> <p>実行すると初回は認証のためのURLが表示されるので、Dropboxにログインしているブラウザに貼り付けて認可して、トークンをコピペします。このトークンは<code class="language-plaintext highlighter-rouge">$HOME/.tbx</code>以下に保存しているので2度目以降は聞かれません。</p> <p>トークンを保存しているファイルの権限は他者に読み取られないよう設定していますが、それでも様々な攻撃方法があるかと思うので、ある程度コマンドの体裁が整ってきたら、トークンを保存しないように仕様変更しようかと思っています。</p> <h1 id="toolboxの設計">toolboxの設計</h1> <p>最初はひさしぶりにDDDなんかでモデリングして作ろうかと考えましたが、あきらめてほとんどコマンドをべた書きしています。いずれリファクタリングするかもしれません。</p> <p>というのも「ファイルを移動する」という簡単なユースケースでも実際には様々な要件があったり、エラー対応が必要となります。そういったエラー処理をすべて抽象化しながら書いていくにはかなり手間がかかりますし、「ファイルを移動する」で使えていた経験が「ファイルをコピーする」では通用しないといった場合もありますので抽象化に時間をかけるよりは、ソースコードコピペは許容しつつ、自動テストに力を入れようと考えています。</p> <p>いまのところ、まだ自動テストのカバレッジもほとんどなくて寂しい限りですが、コマンドがある程度揃ってきたらブラックボックステストを幾つか最初に追加する予定です。</p> <h1 id="動作仕様">動作仕様</h1> <p>最終的にはrsyncや、mv/cp/rmなどUNIXライクOSで見かけるコマンドと同じような操作感になるよう仕上げたいと思っているので仕様はまだころころ変えていく予定です。あしからずご了承ください。</p> <p>また野望としてはwebサーバを立ち上げてWebベースのGUIてきなツールも提供できればと考えていますが、セキュリティーをどう担保するかと言った課題もありますし、まだ大分先になりそうです。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2017/12/14/dropbox-api-upload/"> Dropbox API: ファイルのアップロード </a> </h1> <span class="post-date"> 14th December 2017</span> <span class="post-tags"> #<a href="/tags/api">api</a> #<a href="/tags/dropbox">dropbox</a> #<a href="/tags/dropboxapi">dropboxapi</a> #<a href="/tags/go">go</a> </span> <p>今回はDropbox APIを使ってファイルをアップロードをする流れをご紹介します。ファイルアップロード処理は<a href="https://www.dropbox.com/developers/documentation/http/documentation#files-upload">/files/upload</a>を使えば良いのですが、ファイルサイズが大きい場合には一つのリクエストで処理するのではなく分割してアップロードすることが求められます。</p> <p>分割アップロードする場合には、次のように3つの手順をたどります。</p> <ol> <li>分割した最初のチャンクをアップロード (戻り値としてセッションIDが得られます) - <a href="https://www.dropbox.com/developers/documentation/http/documentation#files-upload_session-start">/files/upload_session/start</a></li> <li>セッションIDをもとに最後の一つ手前チャンクまでを追記アップロードします - <a href="https://www.dropbox.com/developers/documentation/http/documentation#files-upload_session-append_v2">/files/upload_session/append_v2</a></li> <li>セッションIDと最後のチャンクをアップロードします - <a href="https://www.dropbox.com/developers/documentation/http/documentation#files-upload_session-finish">/files/upload_session/finish</a></li> </ol> <h1 id="分割の閾値">分割の閾値</h1> <p>分割するかどうかの閾値はAPIドキュメントに下記のように記載があります。</p> <blockquote> <p>A single request should not upload more than 150 MB.</p> </blockquote> <p>150MB以上であれば分割してアップロードすべし。とのことなのですが、気になるのはこの1MBが 1,000,000バイトなのか、1,048,576バイトなのか。です。 気になるので試してみたところ次の通りでした。</p> <ul> <li>150,000,000バイト … アップロード成功</li> <li>157,286,399バイト (150 * 1,048,576 - 1)… アップロード成功</li> <li>157,286,400バイト (150 * 1,048,576) … アップロード成功</li> <li>160,000,000バイト … アップロード成功</li> </ul> <p>予想外のことですがとりあえず150MBを軽く超えてもエラーなど出ず、アップロードができるようです。 ただ、あまり一度にアップロードするサイズが大きくなりすぎると、途中で通信エラーが出た場合に再送するならばロスが大きくなるのでそこそこに分割した方が良いでしょう。</p> <h1 id="goでの実装例">Goでの実装例</h1> <p>前回と同様に<a href="https://github.com/dropbox/dropbox-sdk-go-unofficial">dropbox-sdk-go-unofficial</a>を使った実装例です。まずはソースをご覧ください。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">uploadSrc</span> <span class="o">:=</span> <span class="s">"data.zip"</span>
<span class="c">// 分割してアップロードするかどうかの閾値</span>
<span class="k">var</span> <span class="n">chunkedUploadThreshold</span><span class="p">,</span> <span class="n">chunkSize</span> <span class="kt">int64</span>
<span class="n">chunkedUploadThreshold</span> <span class="o">=</span> <span class="m">150</span> <span class="o">*</span> <span class="m">1048576</span>
<span class="n">chunkSize</span> <span class="o">=</span> <span class="n">chunkedUploadThreshold</span>
<span class="n">config</span> <span class="o">:=</span> <span class="n">dropbox</span><span class="o">.</span><span class="n">Config</span><span class="p">{</span>
  <span class="n">Token</span><span class="o">:</span> <span class="s">"トークン文字列"</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">client</span> <span class="o">:=</span> <span class="n">files</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="c">// ローカルファイルの情報取得</span>
<span class="n">info</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Lstat</span><span class="p">(</span><span class="n">uploadSrc</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">err</span>
<span class="p">}</span>
<span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">uploadSrc</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
<span class="n">ci</span> <span class="o">:=</span> <span class="n">files</span><span class="o">.</span><span class="n">NewCommitInfo</span><span class="p">(</span><span class="s">"/アップロード先/data.zip"</span><span class="p">)</span>
<span class="c">// ファイルの日付、UTCで秒未満の単位は丸める</span>
<span class="n">ci</span><span class="o">.</span><span class="n">ClientModified</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">ModTime</span><span class="p">()</span><span class="o">.</span><span class="n">UTC</span><span class="p">()</span><span class="o">.</span><span class="n">Round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
<span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">Size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">chunkedUploadThreshold</span> <span class="p">{</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">Upload</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">err</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c">// セッションを開始、最初のチャンクサイズ分だけアップロード</span>
  <span class="n">r</span> <span class="o">:=</span> <span class="n">io</span><span class="o">.</span><span class="n">LimitReader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">chunkSize</span><span class="p">)</span>
  <span class="n">s</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">UploadSessionStart</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">NewUploadSessionStartArg</span><span class="p">(),</span> <span class="n">r</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">err</span>
  <span class="p">}</span>
  <span class="c">// 最後から一つ手前のチャンクまで分割アップロード</span>
  <span class="k">var</span> <span class="n">uploaded</span> <span class="kt">int64</span> <span class="c">// アップロード済みサイズ</span>
  <span class="n">uploaded</span> <span class="o">=</span> <span class="n">chunkSize</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">Size</span><span class="p">()</span> <span class="o">-</span> <span class="n">uploaded</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">chunkSize</span> <span class="p">{</span>
    <span class="n">cursor</span> <span class="o">:=</span> <span class="n">files</span><span class="o">.</span><span class="n">NewUploadSessionCursor</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">SessionId</span><span class="p">,</span> <span class="kt">uint64</span><span class="p">(</span><span class="n">uploaded</span><span class="p">))</span>
    <span class="n">arg</span> <span class="o">:=</span> <span class="n">files</span><span class="o">.</span><span class="n">NewUploadSessionAppendArg</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">LimitReader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">chunkSize</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">UploadSessionAppendV2</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="n">uploaded</span> <span class="o">+=</span> <span class="n">chunkSize</span>
  <span class="p">}</span>
  <span class="c">// 最後のチャンクをアップロード</span>
  <span class="n">cursor</span> <span class="o">:=</span> <span class="n">files</span><span class="o">.</span><span class="n">NewUploadSessionCursor</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">SessionId</span><span class="p">,</span> <span class="kt">uint64</span><span class="p">(</span><span class="n">uploaded</span><span class="p">))</span>
  <span class="n">arg</span> <span class="o">:=</span> <span class="n">files</span><span class="o">.</span><span class="n">NewUploadSessionFinishArg</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">ci</span><span class="p">)</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">UploadSessionFinish</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">err</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="アップロード先">アップロード先</h2> <p><code class="language-plaintext highlighter-rouge">CommitInfo</code>構造体にパスやファイルの日付などを設定します。アップロード先パスですが、アップロード先ディレクトリ名だけでなく、アップロード先ファイル名も含めたパスを指定します。</p> <p><code class="language-plaintext highlighter-rouge">autorename</code>というパラメータがありますが、これを<code class="language-plaintext highlighter-rouge">true</code>にすると同じパスにすでにファイルがある場合は新しくアップロードするファイルが<code class="language-plaintext highlighter-rouge">data (1).zip</code>のように重複しないファイル名でアップロードされます。</p> <h2 id="ファイル更新日付">ファイル更新日付</h2> <p>ファイル更新日付を指定する場合には<code class="language-plaintext highlighter-rouge">client_modified</code>パラメータを指定します。指定しない場合にはDropboxへファイルが保存された際のサーバ日時になります。指定はISO 8601フォーマットで、UTCとします。</p> <p>Goの例ではUTCに変換した上で、下記のように秒以下を丸めています。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ci</span><span class="o">.</span><span class="n">ClientModified</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">ModTime</span><span class="p">()</span><span class="o">.</span><span class="n">UTC</span><span class="p">()</span><span class="o">.</span><span class="n">Round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
</code></pre></div></div> <h2 id="分割アップロード">分割アップロード</h2> <p>Goの場合には分割アップロードに便利な<code class="language-plaintext highlighter-rouge">io.LimitReader</code>というクラスがありますのでこれを利用するといいでしょう。分割したいチャンクサイズを指定するとそこでEOFになってくれます。</p> <p><a href="https://www.dropbox.com/developers/documentation/http/documentation#files-upload_session-start">/files/upload_session/start</a>で最初のチャンクをアップロードしたら、セッションIDが得られます。</p> <p>これを使って、以降は<a href="https://www.dropbox.com/developers/documentation/http/documentation#files-upload_session-append_v2">/files/upload_session/append_v2</a>を呼び出してチャンクをアップロードしていきます。なお、ファイルは0バイト目から連続している必要があり、cursorで飛び飛びのオフセットを指定した場合には<code class="language-plaintext highlighter-rouge">incorrect_offset</code>エラーとなります。</p> <p>このoffsetパラメータの目的はAPIドキュメントにあるとおり、通信エラーなどで重複送信や部分的なロスが発生した場合にデータの整合性を検出するためです。</p> <blockquote> <p>We use this to make sure upload data isn’t lost or duplicated in the event of a network error.</p> </blockquote> </div> </div> <div class="pagination"> <a class="pagination-item older" href="/page6">Older</a> <a class="pagination-item newer" href="/page4">Newer</a> </div> </div> <div class="container copyright"> &copy; 2007, 2013-2022 Takayuki Okazaki </div> </div> <label for="sidebar-checkbox" class="sidebar-toggle"></label> <script>!function(e){var r=e.querySelector(".sidebar-toggle"),t=e.querySelector("#sidebar"),n=e.querySelector("#sidebar-checkbox");e.addEventListener("click",function(e){var c=e.target;n.checked&&!t.contains(c)&&c!==n&&c!==r&&(n.checked=!1)},!1)}(document);</script> </body> </html>