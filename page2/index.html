<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> watermint.org &middot; Takayuki Okazaki's note </title> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/watermint-logo.png"> <link rel="shortcut icon" href="/public/watermint-logo.png"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <style>*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:serif;font-size:14px;line-height:1.8}@media(min-width:38em){html{font-size:20px}}body{color:#515151;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a strong{color:inherit}a:hover,a:focus{text-decoration:underline}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:bold;line-height:1.25;color:#313131;text-rendering:optimizeLegibility}h1{font-size:1.5rem;margin-top:1.6rem;margin-bottom:1.6rem}h2{margin-top:1.6rem;font-size:1.3rem}h3{margin-top:1.6rem;font-size:1.2rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}strong{color:#303030}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:bold}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:bold;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}code,pre{font-family:Menlo,Monaco,"Courier New",monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}.gist .gist-file{font-family:Menlo,Monaco,"Courier New",monospace!important}.gist .markdown-body{padding:15px}.gist pre{padding:0;background-color:transparent}.gist .gist-file .gist-data{font-size:.8rem!important;line-height:1.4}.gist code{padding:0;color:inherit;background-color:transparent;border-radius:0}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media(min-width:30em){blockquote{padding-right:5rem;padding-left:1.25rem}}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;border:1px solid #e5e5e5;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #e5e5e5}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#f9f9f9}.lead{font-size:1.25rem;font-weight:300}.message{margin-bottom:1rem;padding:1rem;color:#717171;background-color:#f9f9f9}.container{max-width:38rem;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.post-tags{display:block;margin-top:-.5rem;margin-bottom:1rem;text-align:right}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:"PT Sans",Helvetica,Arial,sans-serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}html,body{overflow-x:hidden;line-height:1.9em}html{font-family:serif}h1,h2,h3,h4,h5,h6{font-weight:400;color:#313131}.wrap{position:relative;width:100%}.container{max-width:28rem}@media(min-width:38em){.container{max-width:32rem}}@media(min-width:56em){.container{max-width:38rem}}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem;border-bottom:1px solid #eee}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}@media(max-width:48em){.masthead-title{text-align:center}.masthead-title small{display:none}}.sidebar{position:fixed;top:0;bottom:0;left:-14rem;width:14rem;visibility:hidden;overflow-y:auto;font-family:serif;font-size:.875rem;line-height:1.4em;color:rgba(255,255,255,.6);background-color:#202020;-webkit-transition:all .3s ease-in-out;transition:all .3s ease-in-out}
@media(min-width:30em){.sidebar{font-size:.75rem}}.sidebar a{font-weight:normal;color:#fff}.sidebar-item{padding:1rem}.sidebar-item p:last-child{margin-bottom:0}.sidebar-nav{border-bottom:1px solid rgba(255,255,255,.1)}.sidebar-nav-item{display:block;padding:.5rem 1rem;border-top:1px solid rgba(255,255,255,.1)}.sidebar-nav-item.active,a.sidebar-nav-item:hover,a.sidebar-nav-item:focus{text-decoration:none;background-color:rgba(255,255,255,.1);border-color:transparent}@media(min-width:48em){.sidebar-item{padding:1.5rem}.sidebar-nav-item{padding-left:1.5rem;padding-right:1.5rem}}.sidebar-checkbox{position:absolute;opacity:0;-webkit-user-select:none;-moz-user-select:none;user-select:none}.sidebar-toggle{position:absolute;top:.8rem;left:1rem;display:block;padding:.25rem .75rem;color:#555;border-radius:.25rem;cursor:pointer}.sidebar-toggle:before{display:inline-block;width:1rem;height:.75rem;content:"";background-image:-webkit-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-moz-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-ms-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%)}.sidebar-toggle:active,#sidebar-checkbox:focus ~ .sidebar-toggle,#sidebar-checkbox:checked ~ .sidebar-toggle{color:#fff}.sidebar-toggle:active:before,#sidebar-checkbox:focus ~ .sidebar-toggle:before,#sidebar-checkbox:checked ~ .sidebar-toggle:before{background-image:-webkit-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-moz-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-ms-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%)}@media(min-width:30.1em){.sidebar-toggle{position:fixed}}@media print{.sidebar-toggle{display:none}}.wrap,.sidebar,.sidebar-toggle{-webkit-backface-visibility:hidden;-ms-backface-visibility:hidden;backface-visibility:hidden}.wrap,.sidebar-toggle{-webkit-transition:-webkit-transform .3s ease-in-out;transition:transform .3s ease-in-out}#sidebar-checkbox:checked+.sidebar{z-index:10;visibility:visible}#sidebar-checkbox:checked ~ .sidebar,#sidebar-checkbox:checked ~ .wrap,#sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(14rem);-ms-transform:translateX(14rem);transform:translateX(14rem)}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}.layout-reverse .sidebar{left:auto;right:-14rem}.layout-reverse .sidebar-toggle{left:auto;right:1rem}.layout-reverse #sidebar-checkbox:checked ~ .sidebar,.layout-reverse #sidebar-checkbox:checked ~ .wrap,.layout-reverse #sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(-14rem);-ms-transform:translateX(-14rem);transform:translateX(-14rem)}.theme-base-08 .sidebar,.theme-base-08 .sidebar-toggle:active,.theme-base-08 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#ac4142}.theme-base-08 .container a,.theme-base-08 .sidebar-toggle,.theme-base-08 .related-posts li a:hover{color:#ac4142}.theme-base-09 .sidebar,.theme-base-09 .sidebar-toggle:active,.theme-base-09 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#d28445}.theme-base-09 .container a,.theme-base-09 .sidebar-toggle,.theme-base-09 .related-posts li a:hover{color:#d28445}.theme-base-0a .sidebar,.theme-base-0a .sidebar-toggle:active,.theme-base-0a #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#f4bf75}
.theme-base-0a .container a,.theme-base-0a .sidebar-toggle,.theme-base-0a .related-posts li a:hover{color:#f4bf75}.theme-base-0b .sidebar,.theme-base-0b .sidebar-toggle:active,.theme-base-0b #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#90a959}.theme-base-0b .container a,.theme-base-0b .sidebar-toggle,.theme-base-0b .related-posts li a:hover{color:#90a959}.theme-base-0c .sidebar,.theme-base-0c .sidebar-toggle:active,.theme-base-0c #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#75b5aa}.theme-base-0c .container a,.theme-base-0c .sidebar-toggle,.theme-base-0c .related-posts li a:hover{color:#75b5aa}.theme-base-0d .sidebar,.theme-base-0d .sidebar-toggle:active,.theme-base-0d #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#6a9fb5}.theme-base-0d .container a,.theme-base-0d .sidebar-toggle,.theme-base-0d .related-posts li a:hover{color:#6a9fb5}.theme-base-0e .sidebar,.theme-base-0e .sidebar-toggle:active,.theme-base-0e #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#aa759f}.theme-base-0e .container a,.theme-base-0e .sidebar-toggle,.theme-base-0e .related-posts li a:hover{color:#aa759f}.theme-base-0f .sidebar,.theme-base-0f .sidebar-toggle:active,.theme-base-0f #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#8f5536}.theme-base-0f .container a,.theme-base-0f .sidebar-toggle,.theme-base-0f .related-posts li a:hover{color:#8f5536}.sidebar-overlay #sidebar-checkbox:checked ~ .wrap{-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0)}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar-toggle{box-shadow:0 0 0 .25rem #fff}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:.25rem 0 .5rem rgba(0,0,0,.1)}.layout-reverse.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:-.25rem 0 .5rem rgba(0,0,0,.1)}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight,.highlight .w{color:#586e75}.highlight .err{color:#002b36;background-color:#dc322f}.highlight .c,.highlight .cd,.highlight .cm,.highlight .c1,.highlight .cs{color:#657b83}.highlight .cp{color:#b58900}.highlight .nt{color:#b58900}.highlight .o,.highlight .ow{color:#93a1a1}.highlight .p,.highlight .pi{color:#93a1a1}.highlight .gi{color:#859900}.highlight .gd{color:#dc322f}.highlight .gh{color:#268bd2;background-color:#002b36;font-weight:bold}.highlight .k,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .kv{color:#6c71c4}.highlight .kc{color:#cb4b16}.highlight .kt{color:#cb4b16}.highlight .kd{color:#cb4b16}.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .sh,.highlight .sx,.highlight .s1{color:#859900}.highlight .sr{color:#2aa198}.highlight .si{color:#d33682}.highlight .se{color:#d33682}.highlight .nn{color:#b58900}.highlight .nc{color:#b58900}.highlight .no{color:#b58900}.highlight .na{color:#268bd2}.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .il,.highlight .mo,.highlight .mb,.highlight .mx{color:#859900}.highlight .ss{color:#859900}.copyright{font-size:.8em;font-style:italic;color:#555}</style> </head> <body class="theme-base-09"> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"> <div class="sidebar" id="sidebar"> <div class="sidebar-item"> <p>Travel, camera, photo, and technical things. I work at Dropbox. Thoughts are my own.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Archive</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> <a class="sidebar-nav-item" href="/atom.xml">Feed</a> <a class="sidebar-nav-item" href="https://github.com/watermint">Github</a> <a class="sidebar-nav-item" href="https://www.instagram.com/watermint/">Instagram</a> </nav> <div class="sidebar-item"> <p> &copy; 2005-2020 Takayuki Okazaki </p> </div> </div> <div class="wrap"> <div class="masthead"> <div class="container"> <h3 class="masthead-title"> <a href="/" title="Home">watermint.org</a> <small>- Takayuki Okazaki's note</small> </h3> </div> </div> <div class="container content"> <div class="posts"> <div class="post"> <h1 class="post-title"> <a href="/2018/07/23/how-its-made-java-puzzlers/"> Javaパズラーの問題ができるまで </a> </h1> <span class="post-date"> 23rd July 2018</span> <span class="post-tags"> #<a href="/tags/howitsmade">howitsmade</a> #<a href="/tags/java">java</a> #<a href="/tags/javapuzzlers">javapuzzlers</a> </span> <p>以前日経ソフトウエア2013年9月号〜2015年3月号にて至極のJavaクイズという連載を、持ち回りにて執筆していました。この連載は2ページの分量に、十数行程度のコードを示し、実行結果を4択程度の選択肢、掛け合いの形式で問題を補足し、正解を示し、問題から得られる教訓までを説明するというもので、もとはJoshua BlockらによるJavaOneの人気セッションJava Puzzlersを参考にしています。ほかには<a href="https://blogs.oracle.com/wlc/java-javajava-day-tokyo-2013-v2">Java Day Tokyo</a>などのイベントでも過去に同様のセッションを行なっていました。このJavaパズラーの問題ができるまでを数年ぶりに振り返ってみます。</p> <h1 id="問題ができるまで">問題ができるまで</h1> <p>良問といえるのは、問題を正解できなかったとしても、なるほどと言える教訓が得られるものです。そのような問題は間違えたとしてもスッキリと気持ちよく教訓として読み進めることができます。実際、本家Java Puzzlersにはそのような良問がたくさん掲載されています。</p> <p>逆に良問と言いづらいのは重箱の隅をつついたような違いを問題として表現したものです。そのような問題は、教訓が得られるというよりは「ふーん、そうなの。。」ぐらいの感想しか得られないものです。</p> <p>また、知識だけを問う問題もあまり良問とは言えないでしょう。たとえば<code class="highlighter-rouge">javax.time</code>のようなパッケージは問題を作りやすいのですが、インタフェースやクラス、メソッドもかなり多いので知識を問う問題になりがちです。出題する際には解説などで工夫が必要になります。</p> <p>出題範囲について、あまり一般的でないライブラリの仕様などを出題するのはためらわれます。たとえばJava SE標準ライブラリで、日常よく利用するであろう基本ライブラリです。ラムダ式など比較的新しい言語仕様も良いでしょう。 パッケージで言えば<code class="highlighter-rouge">java.lang</code>、<code class="highlighter-rouge">java.util</code>あたりで出題できると良問の期待が高まります。 <code class="highlighter-rouge">java.io</code>、<code class="highlighter-rouge">java.nio</code>、<code class="highlighter-rouge">java.sql</code>なども範囲として良いですが直接これらのパッケージを利用するよりはフレームワークなどに処理を任せることが多いでしょう。出題する場合には多めに注釈を入れるなどで調整を進めます。</p> <p>個人的には問題を考えるには教訓から考えていきます。Java言語仕様はもちろんのこと、新しいJava SEバージョンで変更された振る舞いや、<a href="http://findbugs.sourceforge.net/">FindBugs</a>や<a href="http://checkstyle.sourceforge.net/">Checkstyle</a>などのルールもよく参考にしていました。</p> <p><code class="highlighter-rouge">null</code>の扱いや<code class="highlighter-rouge">equals</code>の振る舞い、評価順などにまつわる問題は作りやすい印象があります。ただ、それらにまつわる問題はすでに出題済みであったり本家Java Puzzlersでだいたいカバーされているので新規性のあるテーマを探すのはなかなか骨の折れる作業です。</p> <h1 id="選択肢ができるまで">選択肢ができるまで</h1> <p>回答は4択程度のなかから選ぶことになっています。必ず4択でなければならない訳ではありませんが、2択だと大抵の場合回答があからさますぎるので、4択程度になるよう調整します。 たとえば<code class="highlighter-rouge">equals</code>と<code class="highlighter-rouge">==</code>の違いについて出題しようとした場合、ぱっと思いつく選択肢のパターンは次のようなものです。</p> <ol> <li><code class="highlighter-rouge">equals</code>と<code class="highlighter-rouge">==</code>が同じ振る舞いになる</li> <li><code class="highlighter-rouge">equals</code>と<code class="highlighter-rouge">==</code>が異なる振る舞いになる</li> <li><code class="highlighter-rouge">NullPointerException</code>が発生する</li> <li>その他</li> </ol> <p>選択肢を考える上で、4つ目が「その他」となるのはできれば避けたいものです。ボツとなりやすいのは「その他」で全く別の例外が発生するようなケースです。<code class="highlighter-rouge">equals</code>と<code class="highlighter-rouge">==</code>の違いから教訓を説明したいのに、別の例外が発生するというようでは出題意図がよくわからなくなってしまいます。時間の都合で妥協することもありますが、なるべくこだわりたい部分です。</p> <p>どうしても詰まってしまった場合は、あえて出題意図を変えて選択肢をすべて例外発生にしてみるというのも面白いでしょう。たとえば下記のような選択肢ではどうでしょうか。</p> <ol> <li><code class="highlighter-rouge">NullPointerException</code>が発生する</li> <li><code class="highlighter-rouge">StackOverflowError</code>が発生する</li> <li><code class="highlighter-rouge">ConcurrentModificationException</code>が発生する</li> <li><code class="highlighter-rouge">IndexOutOfBoundsException</code>が発生する</li> </ol> <p><code class="highlighter-rouge">IndexOutOfBoundsException</code>や<code class="highlighter-rouge">ConcurrentModificationException</code>があるので<code class="highlighter-rouge">java.util.List</code>などに関連する問題と教訓にすれば面白そうです。<code class="highlighter-rouge">StackOverflowError</code>と迷うように再帰処理をいれてみるなどいろいろ試せそうです。</p> <p>このように最初<code class="highlighter-rouge">equals</code>と<code class="highlighter-rouge">==</code>の違いを出題しようと考えていたものが、別の教訓を説明するような問題にどんどん変わっていくこともあります。問題のコードは<code class="highlighter-rouge">equals</code>と<code class="highlighter-rouge">==</code>の違いを説明しようとしてそうなのに、実は<code class="highlighter-rouge">java.util.List</code>の振る舞いについての教訓だった。となれば読みがいがありそうです。</p> <h1 id="問題コードができるまで">問題コードができるまで</h1> <p>問題コードができるまでにも紆余曲折があります。日経ソフトウエアのように紙面であれば40行程度あっても入ることがあるのですが、やはりあまり長いとテンポが悪くなるのでなるべく短く済ませたいものです。セミナーなどでプレゼンテーションとして出題する際にはスライドに選択肢まで入れた上で一画面に収まり、会場後ろの方にも見えるようフォントサイズはできるだけ大きくする必要があります。スライドテンプレートやレイアウトによりますが15行程度までがおおよその限度となります。</p> <p>このためあまり冗長な初期化処理はできませんし、教訓のコアとなる出題部分以外に必要となるクラス・メソッド定義については最低限に抑える必要があります。 読みやすさを考慮しある程度改行も入れていく必要があり、インデントも不自然にならないよう工夫する必要があります。Java言語仕様などの制限を考えると実際に使えるのは20行程度と考える必要があります。</p> <p>どれだけ削っても収まりきらない場合は残念ながらボツ案となります。よりテーマを絞り込むなど教訓を考えるところまで手戻りとなります。</p> <h1 id="掛け合い部分ができるまで">掛け合い部分ができるまで</h1> <p>イベントなどでプレゼンテーションする場合は2人のプレゼンターがあらかじめ出題者と模擬回答者として役割をきめておきます。問題がJava SEバージョンに依存する場合や新仕様などをテーマにしている場合、模擬回答者がうまく出題者に質問するような格好で補足していきます。</p> <p>追加で模擬回答者は「これはひっかけですね」などと、いくつかのトリックを説明しつつ、あまり教訓の核心に触れないように打ち合わせておきます。理想的にはこのように掛け合いで説明できるようなトリックが教訓以外でも含まれていたほうが良いのですが、あまりいろいろ高望みすると締め切りがどんどん厳しくなります。。</p> <h1 id="教訓ができるまで">教訓ができるまで</h1> <p>問題と選択肢ができあがえれば作業のほとんどは完成です。あとは教訓をわかりやすく説明するのですが、そうは言っても紙面に収まるようわかりやすく手短に伝えようとするとなかなか難しいものです。</p> <h1 id="タイトルができるまで">タイトルができるまで</h1> <p>タイトルはなるべく教訓や選択肢の特徴を表現しつつも、ヒントになりすぎないよう微妙な調整が必要です。教訓を知った上でニヤリとできるようなタイトルとなれば大成功といっていいと思います。</p> <h1 id="問題を作ってみる">問題を作ってみる</h1> <p>数年ぶりに問題を作ってみました。</p> <h2 id="オーはオリンピックのオー">オーはオリンピックのオー</h2> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">City</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">futureOlympics</span> <span class="o">=</span>
        <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"Tokyo"</span><span class="o">,</span> <span class="s">"Paris"</span><span class="o">,</span> <span class="s">"Los Angeles"</span><span class="o">);</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">city</span><span class="o">;</span>
  <span class="nc">City</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">city</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
  <span class="kt">boolean</span> <span class="nf">isFuture</span><span class="o">()</span> <span class="o">{</span> 
    <span class="k">return</span> <span class="n">futureOlympics</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">city</span><span class="o">.</span><span class="na">trim</span><span class="o">());</span> 
  <span class="o">}</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Olympics</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kt">long</span> <span class="nf">countO</span><span class="o">(</span><span class="nc">String</span> <span class="n">city</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">city</span><span class="o">.</span><span class="na">chars</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'o'</span><span class="o">).</span><span class="na">count</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
      <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"London"</span><span class="o">,</span> <span class="s">"Rio"</span><span class="o">,</span> <span class="s">"Tokyo"</span><span class="o">,</span> <span class="s">"Paris"</span><span class="o">,</span> <span class="s">"Los Angeles"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">City:</span><span class="o">:</span><span class="k">new</span><span class="o">)</span>
        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="nl">City:</span><span class="o">:</span><span class="n">isFuture</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span> <span class="o">+</span> <span class="s">" Olympics"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Olympics:</span><span class="o">:</span><span class="n">countO</span><span class="o">)</span>
        <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="o">(</span><span class="n">sum</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">sum</span> <span class="o">+</span> <span class="n">count</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>プログラムを実行すると何が出力されるでしょうか。</p> <ol> <li>「0」</li> <li>「2」</li> <li>「3」</li> <li>「6」</li> </ol> <p>.</p> <p>.</p> <p>.</p> <p>.</p> <p>.</p> <p>.</p> <p>.</p> <p>.</p> <p>.</p> <p>.</p> <p>.</p> <h2 id="解答">解答</h2> <p>答えは「1. 「0」」です。”London”や”Rio”といった文字列を順番にCityクラスのインスタンスにマッピングし、<code class="highlighter-rouge">isFuture</code>で将来のオリンピックだけに限定したうえで、残ったオリンピック開催都市の名前から <code class="highlighter-rouge">o</code> (小文字のオー)が何文字あるか合計を計算するプログラムです。</p> <p><code class="highlighter-rouge">isFuture</code>や<code class="highlighter-rouge">countO</code>にはあまり不審なところはありませんが、いかにも怪しいのは次の行です。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span> <span class="o">+</span> <span class="s">" Olympics"</span><span class="o">)</span>
</code></pre></div></div> <p>Cityクラスのインスタンスに文字列を連結しています。オートキャストにより<code class="highlighter-rouge">City#toString</code>が呼び出され、その後に” Olympics”が連結されます。<code class="highlighter-rouge">City</code>クラスは<code class="highlighter-rouge">toString</code>をオーバーライドしていないため<code class="highlighter-rouge">Object#toString</code>が呼び出され<code class="highlighter-rouge">City@2ed94a8b</code>のようなクラス名とハッシュ値を使った文字列表現になります。</p> <p>この<code class="highlighter-rouge">City@2ed94a8b</code>にはo (小文字のオー)は含まれませんから合計値は0となるというわけです。</p> <h2 id="教訓">教訓</h2> <p><code class="highlighter-rouge">toString</code>の実装は忘れずに。</p> <p>.</p> <p>.</p> <p>.</p> <h2 id="問題のレビュー">問題のレビュー</h2> <p>さてではこのパズラー問題をレビューしてみましょう。先ほど怪しいとご紹介したこの行。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span> <span class="o">+</span> <span class="s">" Olympics"</span><span class="o">)</span>
</code></pre></div></div> <p>処理の文脈上、<code class="highlighter-rouge">isFuture</code>などまでの処理は自然ですが、<code class="highlighter-rouge">o</code>をカウントする処理の前に” Olympics”と追加するというのはかなり不自然です。できればこの不自然さをうまく消したいところです。また、いくつかStream APIを利用しているのにあまり特徴を活かせていないにのも改善したいところです。</p> <p>選択肢についても同様でうまく迷いを誘導できていないように見えます。「2.「2」」はTokyoだけがカウントされる、あるいはTokyoとLos Angelsで1ずつカウントされればそうなりますがちょっと考えにくい選択肢です。 「3. 「3」」はTokyoとLos Angelsでどちらも<code class="highlighter-rouge">o</code>がカウントされたと考えるなら選択される可能性があります。 「4. 「6」」はすべての都市名について<code class="highlighter-rouge">o</code>がカウントされたと考えるなら選択される可能性があります(<code class="highlighter-rouge">isFuture</code>がうまく働かなかった)。ただちょっとそれも強引でしょう。</p> <h1 id="まとめ">まとめ</h1> <p>このように、教訓を作る → 選択肢を作る → コードを作る → レビューというサイクルを何度も繰り返すことでより良い問題が作成できます。 ただ、本当にちゃんとした教訓となるような良問を作るのはなかなか難しいものです。(特に締め切りがある場合には。。)</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2018/07/22/jekyll-tagging-and-minimize/"> Jekyllサイトにタグとミニマイズを </a> </h1> <span class="post-date"> 22nd July 2018</span> <span class="post-tags"> #<a href="/tags/docker">docker</a> #<a href="/tags/githubpages">githubpages</a> #<a href="/tags/jekyll">jekyll</a> </span> <p>このサイトを<a href="/tags/jekyll/">Jekyllに移行した</a>ことでメンテナンスはかなり簡単になりました。<a href="/2017/01/15/from-github-pages-to-aerobatic/">Github Pagesのホスティング</a>を使っているのでJekyllで構築したサイトも自動生成してくれます。</p> <p>ただ、Github Pagesで利用できるJekyllプラグインには制限があり、利用したかったタグごとのページ生成プラグインや、ミニマイズのプラグインは利用できませんでした。仕方なしとは思っていたのですが、タグごとに記事がまとまっているURLがあったほうが記事を紹介する際にも便利ですからGithub Pages側でHTML生成してもらうのではなく、あらかじめ手元でHTMLを生成することにしました。</p> <h1 id="docker環境">Docker環境</h1> <p>HTML生成のためにプラグインなどを導入済みのDocker環境を作っておきます。</p> <pre><code class="language-Dockerfile">FROM jekyll/jekyll:stable

RUN apk add --no-cache --virtual build-dependencies build-base
RUN apk add --no-cache libxml2-dev libxslt-dev
RUN apk add --no-cache ruby-dev curl-dev zlib-dev yaml-dev
RUN gem install nokogiri
RUN gem install minima
RUN gem install jekyll-import
RUN gem install jekyll-minifier
RUN gem install jekyll-tagging
RUN gem install jekyll-paginate

ENTRYPOINT ["jekyll", "build", "--config", "/srv/jekyll/source/_config.yml,/srv/jekyll/source/_config_prd.yml", "--destination", "/srv/jekyll/release", "--source", "/srv/jekyll/source"]
</code></pre> <p>なお、ディレクトリ構成は次のようなイメージです。必要に応じて読み替えてください。</p> <ul> <li>サイトルート <ul> <li>source … Jekyllのソース一式</li> <li>release … Github PagesにアップロードするHTML一式</li> <li>staging … 表示確認用HTML生成先</li> </ul> </li> </ul> <p>表示確認用にjekyllをserveで起動するには最後の行を下記のように変えたイメージを準備しておきます。</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ENTRYPOINT ["jekyll", "serve", "--config", "/srv/jekyll/source/_config.yml,/srv/jekyll/source/_config_dev.yml", "--watch", "--destination", "/srv/jekyll/staging", "--source", "/srv/jekyll/source"]
</code></pre></div></div> <p>設定ファイル<code class="highlighter-rouge">_config.yml</code>は共通のものと、表示確認用のもので分離しています。これはMinifierは実行にそれなりに時間がかかるプラグインを外したり、デバッグ用にURLを切り替えるなどしています。 ちなみにMinifierを有効化した際、本サイトのデータを手元のMacBook Pro (Late 2016、Core i7)で実行してMinifierがない場合と比べ1分程度の追加時間が必要となります。</p> <h1 id="タグの有効化">タグの有効化</h1> <p>jekyll-taggingプラグインを利用します。プラグインの設定とjekyll-taggingへの設定は下記のようなイメージです。ハマりどころとして、jekyll-taggingは <code class="highlighter-rouge">jekyll/tagging</code>とスラッシュで区切ります。他のプラグインはだいたい<code class="highlighter-rouge">jekyll-paginate</code>のようにハイフン区切りなのでそれに倣ってしまいがちです。。</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">plugins</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">jekyll-paginate</span>
  <span class="pi">-</span> <span class="s">jekyll-sitemap</span>
  <span class="pi">-</span> <span class="s">jekyll/tagging</span>

<span class="na">tag_page_layout</span><span class="pi">:</span>          <span class="s">tagpage</span>
<span class="na">tag_page_dir</span><span class="pi">:</span>             <span class="s">tags</span>
<span class="na">tag_permalink_style</span><span class="pi">:</span>      <span class="s">pretty</span>
</code></pre></div></div> <p>あとは<a href="https://github.com/pattex/jekyll-tagging">jekyll-tagging</a>の説明にあるように<code class="highlighter-rouge">_plugins/ext.rb</code>へプラグイン指定追加、<code class="highlighter-rouge">_layouts/tag_page.html</code>を作成して完成です。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2018/05/14/dropbox-api-whole-team-file-list/"> Dropbox API: チーム全体のフォルダ・ファイル一覧を取得する </a> </h1> <span class="post-date"> 14th May 2018</span> <span class="post-tags"> #<a href="/tags/api">api</a> #<a href="/tags/dropbox">dropbox</a> #<a href="/tags/dropboxapi">dropboxapi</a> #<a href="/tags/dropboxbusiness">dropboxbusiness</a> </span> <p>Dropbox BusinessではAPIを通じてチーム内のユーザーについてファイル・フォルダ一覧を取得したり、更新することができます。これは、マルウェア対策システムがファイルを検査・隔離するために利用したり、ワークフローや生産性向上ツールが自動的にファイルを仕分けするといった用途を想定していると考えられます。なお便利な一方、非常に強力な権限となるため取り扱い上の注意は管理者パスワードなどと同様厳重に管理する必要があることは言うまでもありません。</p> <p>このようにチーム全体のファイルを扱う場合には<a href="/2017/12/08/dropbox-api-overview/#business-endpoints">Dropbox APIの概要のBusiness Endpoints</a>でご紹介したTeam member file access権限を用います。この権限を使うアプリケーションを作成する手順などは<a href="/2017/12/08/dropbox-api-overview/#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%99%BB%E9%8C%B2">該当記事</a>をご参照ください。</p> <p>チームメンバーのファイルやフォルダを操作するには大きく分けて二種類の方法があります。</p> <ol> <li>チームメンバーの代理として実行</li> <li>管理者として実行</li> </ol> <p>チームメンバーの代理として実行する方法では、指定したユーザーが所有しているファイルやフォルダ、参加している共有フォルダ・チームフォルダなどへアクセスすることができます。 管理者として実行する場合にはチーム内すべてのファイル・フォルダへアクセスすることができます。</p> <p>使い分けとして、たとえばワークフローアプリケーションなどで承認されたドキュメントを所定フォルダに移動するといった用途であれば、承認者の権限で承認者が所有フォルダに移動するといった場合には代理での実行が適切でしょう。マルウェアのスキャンや監査といったチーム全体を対象としたい場合には管理者としての実行が適切でしょう。</p> <h1 id="チームメンバーの代理として実行">チームメンバーの代理として実行</h1> <p>チームメンバーの代理として実行する場合にはまず<a href="https://www.dropbox.com/developers/documentation/http/teams#team-members-list">teams/members/list</a>でアカウント一覧を取得します。User Endpointに対してAPIコールする際にHTTPヘッダ<code class="highlighter-rouge">Dropbox-API-Select-User: チームメンバーID</code>を追加すると、その該当アカウントとして処理が行われます。</p> <p>たとえば<a href="https://www.dropbox.com/developers/documentation/http/documentation#files-list_folder">files/list_folder</a>を代理として実行する場合には次のように呼び出します。</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST https://api.dropboxapi.com/2/files/list_folder <span class="se">\</span>
  <span class="nt">--header</span> <span class="s1">'Authorization: Bearer 認証トークン'</span> <span class="se">\</span>
  <span class="nt">--header</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
  <span class="nt">--header</span> <span class="s1">'Dropbox-Api-Select-User: チームメンバーID'</span> <span class="se">\</span>
  <span class="nt">--data</span> <span class="s1">'{"path":""}'</span>
</code></pre></div></div> <h1 id="チーム管理者として実行">チーム管理者として実行</h1> <p>チーム管理者として実行する場合には<code class="highlighter-rouge">Dropbox-API-Select-User</code>ヘッダの代わりに<code class="highlighter-rouge">Dropbox-API-Select-Admin</code>ヘッダを用います。また、チームメンバーIDにはチーム管理者のメンバーIDを指定します。 <code class="highlighter-rouge">Dropbox-API-Select-Admin</code>ヘッダを用いた場合、チーム内のネームスペースすべてにアクセス可能となりますがAPIによって二つのモードがあり可視範囲が変わります。</p> <p>一つ目はWhole Teamと呼ばれるモードです。主に参照系APIが該当します。該当APIはAPIドキュメントにてAUTHENTICATIONに<code class="highlighter-rouge">Dropbox-API-Select-Admin (Whole Team)</code>と記載されています。Whole Teamモードではメンバーのプライベートファイルを含むすべてのファイルにアクセスすることができます。</p> <p>もう一つはTeam Adminと呼ばれるモードです。主に更新系APIが該当します。該当APIはAPIドキュメントにてAUTHENTICATIONに<code class="highlighter-rouge">Dropbox-API-Select-Admin (Team Admin)</code>と記載されています。Team Adminモードではメンバーのプライベートファイルにはアクセスできません。</p> <p>チーム管理者として実行する際の流れは大まかに次のようになると思います。</p> <ol> <li>実行するチーム管理者のメンバーIDを取得</li> <li>チームフォルダ一覧やネームスペース一覧を取得</li> <li>各ネームスペースについて処理</li> </ol> <p>まずチームメンバーの代理として実行する場合と同様に<a href="https://www.dropbox.com/developers/documentation/http/teams#team-members-list">teams/members/list</a>でアカウント一覧を取得しチーム管理者のメンバーIDを取得します。アプリケーション用に専用のアカウントが用意できるようであればアプリケーションにあらかじめメンバーIDを設定しておくといった運用も可能でしょう。</p> <p>次にチームフォルダ一覧やネームスペース一覧を取得します。チームフォルダ一覧は<a href="https://www.dropbox.com/developers/documentation/http/teams#team-team_folder-list">team/team_folder/list</a>、ネームスペース一覧は<a href="https://www.dropbox.com/developers/documentation/http/teams#team-namespaces-list">team/namespaces/list</a>で取得できます。ワークフロー処理などチームフォルダ内で処理が完結する場合は<a href="https://www.dropbox.com/developers/documentation/http/teams#team-team_folder-list">team/team_folder/list</a>、チーム全体のファイルを監査するといった処理の場合はネームスペース一覧から処理を始めるとよいでしょう。</p> <p>処理したいチームフォルダやネームスペースのネームスペースIDを取得します。なお、チームフォルダIDはそのままネームスペースIDとして利用できます。たとえば、<a href="https://www.dropbox.com/developers/documentation/http/teams#team-team_folder-list">team/team_folder/list</a>のレスポンスが次のような場合、ネームスペースIDは123456789となります。</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"team_folders"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"team_folder_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123456789"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Marketing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">".tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"is_team_shared_dropbox"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"cursor"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ZtkX9_EHj3x7PMkVuFIhwKYXEpwpLwyxp9vMKomUhllil9q7eWiAu"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"has_more"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <h1 id="ネームスペースを使ってファイル一覧を取得する">ネームスペースを使ってファイル一覧を取得する</h1> <p>パスとネームスペースの扱いについては以前の記事<a href="/2018/01/22/dropbox-api-path/">Dropbox API: ネームスペースとパスの表現</a>にてご紹介いたしました。こちらでご紹介したとおり、<code class="highlighter-rouge">ns:ネームスペースID/パス</code>といった形式でパス指定すれば通常のファイル一覧取得と同じようにファイル一覧を取得することができます。</p> <p>たとえばチームフォルダ(ネームスペースID = <code class="highlighter-rouge">123456789</code>)のトップフォルダからファイル一覧を取得するには次のように実行します。</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST https://api.dropboxapi.com/2/files/list_folder <span class="se">\</span>
  <span class="nt">--header</span> <span class="s1">'Authorization: Bearer 認証トークン'</span> <span class="se">\</span>
  <span class="nt">--header</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
  <span class="nt">--header</span> <span class="s1">'Dropbox-Api-Select-Admin: チーム管理者のメンバーID'</span> <span class="se">\</span>
  <span class="nt">--data</span> <span class="s1">'{"path":"ns:123456789"}'</span>
</code></pre></div></div> </div> <div class="post"> <h1 class="post-title"> <a href="/2018/04/25/mruby-and-go/"> mruby and go: value mapping library </a> </h1> <span class="post-date"> 25th April 2018</span> <span class="post-tags"> #<a href="/tags/go">go</a> #<a href="/tags/mruby">mruby</a> </span> <p>I’m recently working on my hobby project that requires DSL on Go language. From my little research of DSL on Go; <a href="https://github.com/mitchellh/go-mruby/">go-mruby</a> looks attractive to implement DSL. <a href="https://github.com/mruby/mruby">mruby</a> is the lightweight version of Ruby. That is embeddable into an app. With go language, an app can be compilable into a single binary.</p> <h1 id="go-mruby">go-mruby</h1> <p><code class="highlighter-rouge">go-mruby</code> have set of functions that enable essential integration with mruby code and Go. For example, <code class="highlighter-rouge">go-mruby</code> can define mruby class or method from Go. But current functions are it’s too primitive for dealing with real-world applications.</p> <p>Like mapping values from mruby to Go, or vice versa. It’s a bit tiresome for getting/putting each struct field. For example below, just for two fields of struct require 9 lines of code.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mrb</span> <span class="o">:=</span> <span class="n">mruby</span><span class="o">.</span><span class="n">NewMrb</span><span class="p">()</span>
<span class="k">defer</span> <span class="n">mrb</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

<span class="k">type</span> <span class="n">Planet</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Id</span>   <span class="kt">int</span>
    <span class="n">Name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="n">rv</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">mrb</span><span class="o">.</span><span class="n">LoadString</span><span class="p">(</span><span class="s">`
class Planet
  attr_accessor :id
  attr_accessor :name
end

p = Planet.new
p.id   = 3
p.name = "Earth"
p
`</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
<span class="p">}</span>

<span class="n">p</span> <span class="o">:=</span> <span class="n">Planet</span><span class="p">{}</span>
<span class="k">if</span> <span class="n">rId</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rv</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="s">"id"</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">rId</span><span class="o">.</span><span class="n">Fixnum</span><span class="p">()</span>
<span class="p">}</span>
<span class="k">if</span> <span class="n">rName</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rv</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="s">"name"</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Name</span> <span class="o">=</span> <span class="n">rName</span><span class="o">.</span><span class="n">String</span><span class="p">()</span>
<span class="p">}</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Planet: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</code></pre></div></div> <p>For more productivity, I wrote mapping functions. Functions are open sourced on GitHub in MIT license. <a href="https://github.com/watermint/grb">grb</a>.</p> <h1 id="grb"><code class="highlighter-rouge">grb</code></h1> <h2 id="unmarshal-ruby-values-into-go-struct-data">Unmarshal Ruby values into Go struct data</h2> <p>Func <code class="highlighter-rouge">Unmarshal</code> fetch values for every field in Ruby object that defined by <code class="highlighter-rouge">mruby:"METHOD_NAME"</code> tag.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Planet</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Id</span>         <span class="kt">int</span>            <span class="s">`mruby:"id"`</span>
    <span class="n">Name</span>       <span class="kt">string</span>         <span class="s">`mruby:"name"`</span>
    <span class="n">Radius</span>     <span class="kt">float64</span>        <span class="s">`mruby:"radius"`</span>
    <span class="n">HasMoon</span>    <span class="kt">bool</span>           <span class="s">`mruby:"has_moon"`</span>
    <span class="n">Moon</span>       <span class="p">[]</span><span class="kt">string</span>       <span class="s">`mruby:"moon"`</span>
    <span class="n">MoonRadius</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span> <span class="s">`mruby:"moon_radius"`</span>
<span class="p">}</span>
</code></pre></div></div> <p>Define each value accessor in Ruby class.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Planet</span>
  <span class="nb">attr_accessor</span> <span class="ss">:id</span>
  <span class="nb">attr_accessor</span> <span class="ss">:name</span>
  <span class="nb">attr_accessor</span> <span class="ss">:radius</span>
  <span class="nb">attr_accessor</span> <span class="ss">:has_moon</span>
  <span class="nb">attr_accessor</span> <span class="ss">:moon</span>
  <span class="nb">attr_accessor</span> <span class="ss">:moon_radius</span>
<span class="k">end</span>
</code></pre></div></div> <p>Retrieve ruby value <code class="highlighter-rouge">*ruby.MrbValue</code>, then unmarshal it into the Go struct.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rv</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">mrb</span><span class="o">.</span><span class="n">LoadString</span><span class="p">(</span><span class="s">`
p = Planet.new
p.id          = 3
p.name        = "Earth"
p.radius      = 6371.0
p.has_moon    = true
p.moon        = ["Moon"]
p.moon_radius = {"Moon" =&gt; 1737}
p
`</span><span class="p">)</span>

<span class="n">p</span> <span class="o">:=</span> <span class="n">Planet</span><span class="p">{}</span>
<span class="n">Unmarshal</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">)</span>

<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Planet: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="c">// Planet: {3 Earth 6371 true [Moon] map[Moon:1737]}</span>
</code></pre></div></div> <h2 id="decodeencode-between-ruby-values-and-go-values">Decode/encode between Ruby values and Go values</h2> <p>Similar to func <code class="highlighter-rouge">Unmarshal</code>. Func <code class="highlighter-rouge">DecodeMrbValue</code> and <code class="highlighter-rouge">EncodeMrbValue</code> enable mapping values between mruby and Go. <code class="highlighter-rouge">DecodeMrbValue</code>/<code class="highlighter-rouge">EncodeMrbValue</code> have limitation for a type of value. This supports JSON equivalent types like below.</p> <ul> <li>nil</li> <li>bool</li> <li>int</li> <li>float</li> <li>string</li> <li>Array / slice</li> <li>Hash / map (Hash/map key must be a string)</li> </ul> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mrb</span> <span class="o">:=</span> <span class="n">mruby</span><span class="o">.</span><span class="n">NewMrb</span><span class="p">()</span>
<span class="k">defer</span> <span class="n">mrb</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

<span class="c">// Mapping to mruby value</span>
<span class="n">rv</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">EncodeMrbValue</span><span class="p">(</span><span class="n">mrb</span><span class="p">,</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}{</span><span class="s">"Earth"</span><span class="o">:</span> <span class="m">6371</span><span class="p">,</span> <span class="s">"Moon"</span><span class="o">:</span> <span class="m">1737</span><span class="p">})</span>

<span class="c">// Mapping from mruby value</span>
<span class="n">gv</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">DecodeMrbValue</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
</code></pre></div></div> </div> <div class="post"> <h1 class="post-title"> <a href="/2018/03/27/golang-csvfile-with-bom/"> GolangでBOM付きCSVファイルを読み込む </a> </h1> <span class="post-date"> 27th March 2018</span> <span class="post-tags"> #<a href="/tags/csv">csv</a> #<a href="/tags/go">go</a> #<a href="/tags/golang">golang</a> #<a href="/tags/unicode">unicode</a> </span> <p>先行事例・解決策は山ほどあるかと思いますが、はまったのでメモがてら解決方法を。BOM付きUTF16などでエンコードされたテキストを扱うに当たって、ライブラリなどが対応してくれているといいのですが、GolangのCSVReaderは対応していないようです。このため、次のような関数を準備してエンコーディングを変換してやります。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">NewBomAwareCsvReader</span><span class="p">(</span><span class="n">r</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span> <span class="o">*</span><span class="n">csv</span><span class="o">.</span><span class="n">Reader</span> <span class="p">{</span>
  <span class="k">var</span> <span class="p">(</span>
    <span class="n">bomUtf8</span>    <span class="o">=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="m">0xef</span><span class="p">,</span> <span class="m">0xbb</span><span class="p">,</span> <span class="m">0xbf</span><span class="p">}</span>
    <span class="n">bomUtf16BE</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="m">0xfe</span><span class="p">,</span> <span class="m">0xff</span><span class="p">}</span>
    <span class="n">bomUtf16LE</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="m">0xff</span><span class="p">,</span> <span class="m">0xfe</span><span class="p">}</span>
  <span class="p">)</span>
  <span class="n">br</span> <span class="o">:=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
  <span class="n">mark</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">br</span><span class="o">.</span><span class="n">Peek</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c">// decoder</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">unicode</span><span class="o">.</span><span class="n">UTF8</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">()</span>

  <span class="k">if</span> <span class="n">bytes</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">mark</span><span class="p">,</span> <span class="n">bomUtf8</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">br</span><span class="o">.</span><span class="n">Discard</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bomUtf8</span><span class="p">))</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">bytes</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">mark</span><span class="p">,</span> <span class="n">bomUtf16BE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">unicode</span><span class="o">.</span><span class="n">UTF16</span><span class="p">(</span><span class="n">unicode</span><span class="o">.</span><span class="n">BigEndian</span><span class="p">,</span> 
      <span class="n">unicode</span><span class="o">.</span><span class="n">UseBOM</span><span class="p">)</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">()</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">bytes</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">mark</span><span class="p">,</span> <span class="n">bomUtf16LE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">unicode</span><span class="o">.</span><span class="n">UTF16</span><span class="p">(</span><span class="n">unicode</span><span class="o">.</span><span class="n">LittleEndian</span><span class="p">,</span>
     <span class="n">unicode</span><span class="o">.</span><span class="n">UseBOM</span><span class="p">)</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">csv</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">br</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div> <p>あとはファイルを読み込めば変換できます。ひとまず必要が無かったので対応しませんでしたが、<a href="https://godoc.org/golang.org/x/text/encoding/unicode/utf32">utf32パッケージ</a>を使って同様処理を追加してやればUTF32も対応できます。</p> </div> </div> <div class="pagination"> <a class="pagination-item older" href="/page3">Older</a> <a class="pagination-item newer" href="/">Newer</a> </div> </div> <div class="container copyright"> &copy; 2016-2020 Takayuki Okazaki </div> </div> <label for="sidebar-checkbox" class="sidebar-toggle"></label> <script>!function(e){var r=e.querySelector(".sidebar-toggle"),t=e.querySelector("#sidebar"),n=e.querySelector("#sidebar-checkbox");e.addEventListener("click",function(e){var c=e.target;n.checked&&!t.contains(c)&&c!==n&&c!==r&&(n.checked=!1)},!1)}(document);</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-769616-6","auto"),ga("send","pageview");</script> </body> </html>