<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> watermint.org &middot; Takayuki Okazaki's note </title> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/watermint-logo.png"> <link rel="shortcut icon" href="/public/watermint-logo.png"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <style>*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:serif;font-size:14px;line-height:1.8}@media(min-width:38em){html{font-size:20px}}body{color:#515151;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a strong{color:inherit}a:hover,a:focus{text-decoration:underline}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:bold;line-height:1.25;color:#313131;text-rendering:optimizeLegibility}h1{font-size:1.5rem;margin-top:1.6rem;margin-bottom:1.6rem}h2{margin-top:1.6rem;font-size:1.3rem}h3{margin-top:1.6rem;font-size:1.2rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}strong{color:#303030}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:bold}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:bold;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}code,pre{font-family:Menlo,Monaco,"Courier New",monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}.gist .gist-file{font-family:Menlo,Monaco,"Courier New",monospace!important}.gist .markdown-body{padding:15px}.gist pre{padding:0;background-color:transparent}.gist .gist-file .gist-data{font-size:.8rem!important;line-height:1.4}.gist code{padding:0;color:inherit;background-color:transparent;border-radius:0}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media(min-width:30em){blockquote{padding-right:5rem;padding-left:1.25rem}}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;border:1px solid #e5e5e5;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #e5e5e5}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#f9f9f9}.lead{font-size:1.25rem;font-weight:300}.message{margin-bottom:1rem;padding:1rem;color:#717171;background-color:#f9f9f9}.container{max-width:38rem;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.post-tags{display:block;margin-top:-.5rem;margin-bottom:1rem;text-align:right}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:"PT Sans",Helvetica,Arial,sans-serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}html,body{overflow-x:hidden;line-height:1.9em}html{font-family:serif}h1,h2,h3,h4,h5,h6{font-weight:400;color:#313131}.wrap{position:relative;width:100%}.container{max-width:28rem}@media(min-width:38em){.container{max-width:32rem}}@media(min-width:56em){.container{max-width:38rem}}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem;border-bottom:1px solid #eee}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}@media(max-width:48em){.masthead-title{text-align:center}.masthead-title small{display:none}}.sidebar{position:fixed;top:0;bottom:0;left:-14rem;width:14rem;visibility:hidden;overflow-y:auto;font-family:serif;font-size:.875rem;line-height:1.4em;color:rgba(255,255,255,.6);background-color:#202020;-webkit-transition:all .3s ease-in-out;transition:all .3s ease-in-out}
@media(min-width:30em){.sidebar{font-size:.75rem}}.sidebar a{font-weight:normal;color:#fff}.sidebar-item{padding:1rem}.sidebar-item p:last-child{margin-bottom:0}.sidebar-nav{border-bottom:1px solid rgba(255,255,255,.1)}.sidebar-nav-item{display:block;padding:.5rem 1rem;border-top:1px solid rgba(255,255,255,.1)}.sidebar-nav-item.active,a.sidebar-nav-item:hover,a.sidebar-nav-item:focus{text-decoration:none;background-color:rgba(255,255,255,.1);border-color:transparent}@media(min-width:48em){.sidebar-item{padding:1.5rem}.sidebar-nav-item{padding-left:1.5rem;padding-right:1.5rem}}.sidebar-checkbox{position:absolute;opacity:0;-webkit-user-select:none;-moz-user-select:none;user-select:none}.sidebar-toggle{position:absolute;top:.8rem;left:1rem;display:block;padding:.25rem .75rem;color:#555;border-radius:.25rem;cursor:pointer}.sidebar-toggle:before{display:inline-block;width:1rem;height:.75rem;content:"";background-image:-webkit-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-moz-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-ms-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%)}.sidebar-toggle:active,#sidebar-checkbox:focus ~ .sidebar-toggle,#sidebar-checkbox:checked ~ .sidebar-toggle{color:#fff}.sidebar-toggle:active:before,#sidebar-checkbox:focus ~ .sidebar-toggle:before,#sidebar-checkbox:checked ~ .sidebar-toggle:before{background-image:-webkit-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-moz-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-ms-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%)}@media(min-width:30.1em){.sidebar-toggle{position:fixed}}@media print{.sidebar-toggle{display:none}}.wrap,.sidebar,.sidebar-toggle{-webkit-backface-visibility:hidden;-ms-backface-visibility:hidden;backface-visibility:hidden}.wrap,.sidebar-toggle{-webkit-transition:-webkit-transform .3s ease-in-out;transition:transform .3s ease-in-out}#sidebar-checkbox:checked+.sidebar{z-index:10;visibility:visible}#sidebar-checkbox:checked ~ .sidebar,#sidebar-checkbox:checked ~ .wrap,#sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(14rem);-ms-transform:translateX(14rem);transform:translateX(14rem)}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}.layout-reverse .sidebar{left:auto;right:-14rem}.layout-reverse .sidebar-toggle{left:auto;right:1rem}.layout-reverse #sidebar-checkbox:checked ~ .sidebar,.layout-reverse #sidebar-checkbox:checked ~ .wrap,.layout-reverse #sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(-14rem);-ms-transform:translateX(-14rem);transform:translateX(-14rem)}.theme-base-08 .sidebar,.theme-base-08 .sidebar-toggle:active,.theme-base-08 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#ac4142}.theme-base-08 .container a,.theme-base-08 .sidebar-toggle,.theme-base-08 .related-posts li a:hover{color:#ac4142}.theme-base-09 .sidebar,.theme-base-09 .sidebar-toggle:active,.theme-base-09 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#d28445}.theme-base-09 .container a,.theme-base-09 .sidebar-toggle,.theme-base-09 .related-posts li a:hover{color:#d28445}.theme-base-0a .sidebar,.theme-base-0a .sidebar-toggle:active,.theme-base-0a #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#f4bf75}
.theme-base-0a .container a,.theme-base-0a .sidebar-toggle,.theme-base-0a .related-posts li a:hover{color:#f4bf75}.theme-base-0b .sidebar,.theme-base-0b .sidebar-toggle:active,.theme-base-0b #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#90a959}.theme-base-0b .container a,.theme-base-0b .sidebar-toggle,.theme-base-0b .related-posts li a:hover{color:#90a959}.theme-base-0c .sidebar,.theme-base-0c .sidebar-toggle:active,.theme-base-0c #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#75b5aa}.theme-base-0c .container a,.theme-base-0c .sidebar-toggle,.theme-base-0c .related-posts li a:hover{color:#75b5aa}.theme-base-0d .sidebar,.theme-base-0d .sidebar-toggle:active,.theme-base-0d #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#6a9fb5}.theme-base-0d .container a,.theme-base-0d .sidebar-toggle,.theme-base-0d .related-posts li a:hover{color:#6a9fb5}.theme-base-0e .sidebar,.theme-base-0e .sidebar-toggle:active,.theme-base-0e #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#aa759f}.theme-base-0e .container a,.theme-base-0e .sidebar-toggle,.theme-base-0e .related-posts li a:hover{color:#aa759f}.theme-base-0f .sidebar,.theme-base-0f .sidebar-toggle:active,.theme-base-0f #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#8f5536}.theme-base-0f .container a,.theme-base-0f .sidebar-toggle,.theme-base-0f .related-posts li a:hover{color:#8f5536}.sidebar-overlay #sidebar-checkbox:checked ~ .wrap{-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0)}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar-toggle{box-shadow:0 0 0 .25rem #fff}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:.25rem 0 .5rem rgba(0,0,0,.1)}.layout-reverse.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:-.25rem 0 .5rem rgba(0,0,0,.1)}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight,.highlight .w{color:#586e75}.highlight .err{color:#002b36;background-color:#dc322f}.highlight .c,.highlight .cd,.highlight .cm,.highlight .c1,.highlight .cs{color:#657b83}.highlight .cp{color:#b58900}.highlight .nt{color:#b58900}.highlight .o,.highlight .ow{color:#93a1a1}.highlight .p,.highlight .pi{color:#93a1a1}.highlight .gi{color:#859900}.highlight .gd{color:#dc322f}.highlight .gh{color:#268bd2;background-color:#002b36;font-weight:bold}.highlight .k,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .kv{color:#6c71c4}.highlight .kc{color:#cb4b16}.highlight .kt{color:#cb4b16}.highlight .kd{color:#cb4b16}.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .sh,.highlight .sx,.highlight .s1{color:#859900}.highlight .sr{color:#2aa198}.highlight .si{color:#d33682}.highlight .se{color:#d33682}.highlight .nn{color:#b58900}.highlight .nc{color:#b58900}.highlight .no{color:#b58900}.highlight .na{color:#268bd2}.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .il,.highlight .mo,.highlight .mb,.highlight .mx{color:#859900}.highlight .ss{color:#859900}.copyright{font-size:.8em;font-style:italic;color:#555}</style> </head> <body class="theme-base-09"> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"> <div class="sidebar" id="sidebar"> <div class="sidebar-item"> <p>Travel, camera, photo, and technical things. I work at Dropbox. Thoughts are my own.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Archive</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> <a class="sidebar-nav-item" href="/atom.xml">Feed</a> <a class="sidebar-nav-item" href="https://github.com/watermint">Github</a> </nav> <div class="sidebar-item"> <p> &copy; 2005-2022 Takayuki Okazaki </p> </div> </div> <div class="wrap"> <div class="masthead"> <div class="container"> <h3 class="masthead-title"> <a href="/" title="Home">watermint.org</a> <small>- Takayuki Okazaki's note</small> </h3> </div> </div> <div class="container content"> <div class="posts"> <div class="post"> <h1 class="post-title"> <a href="/2017/03/31/mathematica/"> Mathematicaの練習: Asanaタスクの集計 </a> </h1> <span class="post-date"> 31st March 2017</span> <span class="post-tags"> #<a href="/tags/asana">asana</a> #<a href="/tags/mathematica">mathematica</a> </span> <p>大学で使ってからもう十数年ぶりになりますがMathematicaをさわっています。数学とあとは機械学習関連を勉強するためMathematicaのHome版を購入してみました。まずはデータを分析したりするところから手始めにやってみようと思っていますが、 十数年ぶりということもありますし、大学時代もさほど深く使い込んでいなかったのでWolfram Languageの知識はほぼゼロの状態です。</p> <p>慣れたプログラミング言語で書けばすぐできることですが、手始めにAsanaで管理しているタスクを集計したり分析する流れをやってみました。AsanaのタスクはJSON形式でエクスポートができますのでこれを読み込んで集計してみます。</p> <p><img src="/images/2017-03-31-mathematica.jpg" alt="週ごとのタスク数"/></p> <p>JSONを読み込むにはImportを使いますがこのとき、”JSON”ではなく、”RawJSON”をつかうとすべてがAssociation(連想配列のようなもの)として読み込むことができます。ここまでくるだけで結構つまづきました。Asanaから得られるJSONは”data”というキーが最初にあるのでいろいろなプログラミング言語の連想配列と同じように<code class="language-plaintext highlighter-rouge">["data"]</code>のように書いて値を取得します。値が取り出せたので続いて集計です。</p> <p>AsanaのJSON書式は<a href="https://asana.com/developers/api-reference/tasks">API reference</a>あたりを参照しながら処理を進めましょう。たとえばタスクが作成された日時は、”created_at”というキーに対する値として設定されています。時刻の書式はISO 8601形式です。</p> <p>ISO8601形式をMathematicaで読み込むには <code class="language-plaintext highlighter-rouge">DateObject["2017-03-31T09:00:00Z"]</code>のようにDateObjectへ渡してやればよいようです。</p> <p>手元のAsanaデータは1月中旬に整理整頓してそれ以前はあまり正確ではありませんでしたから、1月中旬以降のものだけを集計対象としています。</p> <div class="language-mathematica highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">asanaTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> 
  </span><span class="nb">Select</span><span class="p">[</span><span class="nv">asanaJSON</span><span class="o">,</span><span class="w"> 
   </span><span class="nb">DateObject</span><span class="p">[</span><span class="nf">#</span><span class="p">[</span><span class="s">"created_at"</span><span class="p">]]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nb">DateObject</span><span class="p">[{</span><span class="m">2017</span><span class="o">,</span><span class="w"> </span><span class="m">1</span><span class="o">,</span><span class="w"> </span><span class="m">15</span><span class="p">}]</span><span class="w"> </span><span class="o">&amp;</span><span class="p">]</span><span class="o">;</span><span class="w">
</span></code></pre></div></div> <p>集計対象としたいタスクだけを取り出すには<code class="language-plaintext highlighter-rouge">Select</code>関数を使えば良いようです。関数型言語でプログラミングした経験があれば比較的すんなり理解しやすいかと思いますが、<code class="language-plaintext highlighter-rouge">&amp;</code>のような簡略書式はMathematica独特なのでこれはマニュアルや例をみながら見様見まねで覚えるしかなさそうですね。</p> <p>集計をするときも<code class="language-plaintext highlighter-rouge">CountsBy</code>のような関数で簡単に集計できます。関数がたくさんあるので、プロトタイピングするにはもってこいです。</p> <p>週ごとに集計するために日付を丸めたかったのですがこれがなかなかわからず苦労しました。</p> <div class="language-mathematica highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">taskCountPerWeek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">CountsBy</span><span class="p">[</span><span class="w">
   </span><span class="nv">asanaTasks</span><span class="o">,</span><span class="w">
   </span><span class="nb">CurrentDate</span><span class="p">[</span><span class="w">
     </span><span class="nb">DateObject</span><span class="p">[</span><span class="nf">#</span><span class="p">[</span><span class="s">"created_at"</span><span class="p">]]</span><span class="o">,</span><span class="w">
     </span><span class="s">"Week"</span><span class="w">
     </span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w">
   </span><span class="p">]</span><span class="o">;</span><span class="w">
</span></code></pre></div></div> <p>最近出た11.1というリリースで追加された<code class="language-plaintext highlighter-rouge">CurrentDate</code>を使うと簡単にできるようです。<code class="language-plaintext highlighter-rouge">CurrentDate[Now, "Week"]</code>のように日付の粒度を指定すればその粒度で値がかえってきます。語感としてややこしいのは、CurrentDateとありますがDateObjectなどを渡してやれば与えた日時を基準に変換してくれます。</p> <p>最後に<code class="language-plaintext highlighter-rouge">DateListPlot</code>でグラフを書けば週ごとにどれぐらいタスクが作成されているかわかりました。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2017/02/21/dropbox-business-properties-api-poc/"> Dropbox Business API: Properties API Proof of Concept </a> </h1> <span class="post-date"> 21st February 2017</span> <span class="post-tags"> #<a href="/tags/api">api</a> #<a href="/tags/dropbox">dropbox</a> #<a href="/tags/dropboxbusiness">dropboxbusiness</a> #<a href="/tags/python">python</a> </span> <p>I wrote sample script of Properties API of Dropbox Business in Python.</p> <p>Note: Properties APIs are alpha release (as of Feb 2017). Specification of APIs may change without notice.</p> <h1 id="properties-api">Properties API</h1> <p>Dropbox API and Dropbox Business API provide store properties of files or folders. These properties are not displayed on desktop, mobile and web. Properties APIs are designed for application which integrate with Dropbox Business. Here are possible use cases.</p> <ul> <li>Store security policies for each files/folders.</li> <li>Store approval status of documents.</li> <li>Store document ID which issued from other CMS.</li> </ul> <h2 id="properties-template">Properties template</h2> <p>Before storing properties of files/folders. You need to create Properties template in Dropbox Business team. To perform properties template operation, application must have “Team member file access” token. See more detail about auth type at <a href="https://www.dropbox.com/developers/documentation/http/teams#access-types">Access Type</a>.</p> <p>Properties template can have multiple fields. Field can have single string value.</p> <p>Here are APIs for Properties template. No method for delete template. Applications should maintain properties template id. Because you can create same name properties template. Template name is just for human friendly purpose.</p> <ul> <li><a href="https://www.dropbox.com/developers/documentation/http/teams#team-properties-template-add">/team/properties/template/add</a></li> <li><a href="https://www.dropbox.com/developers/documentation/http/teams#team-properties-template-get">/team/properties/template/get</a></li> <li><a href="https://www.dropbox.com/developers/documentation/http/teams#team-properties-template-list">/team/properties/template/list</a></li> <li><a href="https://www.dropbox.com/developers/documentation/http/teams#team-properties-template-update">/team/properties/template/update</a></li> </ul> <p>Here is example of list existing templates:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">templates</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">team_properties_template_list</span><span class="p">()</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">.</span><span class="n">template_ids</span><span class="p">:</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">team_properties_template_get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">"Template Id: %s"</span> <span class="o">%</span> <span class="n">t</span>
    <span class="k">print</span> <span class="s">"Template Name: %s"</span> <span class="o">%</span> <span class="n">template</span><span class="p">.</span><span class="n">name</span>
    <span class="k">print</span> <span class="s">"Description: %s"</span> <span class="o">%</span> <span class="n">template</span><span class="p">.</span><span class="n">description</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">template</span><span class="p">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Field[%s] Description[%s]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">.</span><span class="n">description</span><span class="p">)</span>
</code></pre></div></div> <h2 id="storeretrieve-properties-of-filesfolders">Store/retrieve properties of files/folders</h2> <p>To retrieve properties of file/folder, use <a href="https://www.dropbox.com/developers/documentation/http/documentation#files-alpha-get_metadata">/files/alpha/get_metadata</a>. For retrieve properties, specify template id in <code class="language-plaintext highlighter-rouge">include_property_templates</code> attribute.</p> <p>To store properties of file/folder, use <a href="https://www.dropbox.com/developers/documentation/http/documentation#files-properties-add">/files/properties/add</a> or <a href="https://www.dropbox.com/developers/documentation/http/documentation#files-properties-overwrite">/files/properties/overwrite</a>.</p> <h1 id="code-sample">Code sample</h1> <p>Here is complete code sample of use case of properties APIs. This sample expect to store security policy and levels for each files. This sample code using latest <a href="https://github.com/dropbox/dropbox-sdk-python">Dropbox Python SDK</a>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">dropbox</span>
<span class="kn">from</span> <span class="nn">dropbox.files</span> <span class="kn">import</span> <span class="n">PropertyGroupUpdate</span>
<span class="kn">from</span> <span class="nn">dropbox.properties</span> <span class="kn">import</span> <span class="n">PropertyFieldTemplate</span><span class="p">,</span> <span class="n">PropertyType</span><span class="p">,</span> <span class="n">PropertyField</span><span class="p">,</span> <span class="n">PropertyGroup</span>

<span class="c1"># Dropbox Business Team file access token
</span><span class="n">DROPBOX_TEAM_FILE</span> <span class="o">=</span> <span class="s">''</span>


<span class="k">def</span> <span class="nf">list_more_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
    <span class="s">"""
    :type client: dropbox.Dropbox
    :type cursor: str
    :rtype: list[dropbox.files.Metadata]
    """</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">files_list_folder_continue</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">chunk</span><span class="p">.</span><span class="n">has_more</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chunk</span><span class="p">.</span><span class="n">entries</span> <span class="o">+</span> <span class="n">list_more_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chunk</span><span class="p">.</span><span class="n">cursor</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chunk</span><span class="p">.</span><span class="n">entries</span>


<span class="k">def</span> <span class="nf">list_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="s">"""
    :type client: dropbox.Dropbox
    :type path: str
    :rtype: list[dropbox.files.Metadata]
    """</span>

    <span class="c1"># Set recursive=False because files under shared folders are not listed.
</span>    <span class="c1"># call traverse_files for extract files recursively
</span>    <span class="n">chunk</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">files_list_folder</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">chunk</span><span class="p">.</span><span class="n">has_more</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">traverse_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chunk</span><span class="p">.</span><span class="n">entries</span> <span class="o">+</span> <span class="n">list_more_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chunk</span><span class="p">.</span><span class="n">cursor</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">traverse_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chunk</span><span class="p">.</span><span class="n">entries</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">traverse_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">entries</span><span class="p">):</span>
    <span class="s">"""
    :type client: dropbox.Dropbox
    :type entries: list[dropbox.files.Metadata]
    :rtype: list[dropbox.files.Metadata]
    """</span>
    <span class="nb">all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="nb">all</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dropbox</span><span class="p">.</span><span class="n">files</span><span class="p">.</span><span class="n">FolderMetadata</span><span class="p">):</span>
            <span class="nb">all</span> <span class="o">+=</span> <span class="n">list_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">f</span><span class="p">.</span><span class="n">path_lower</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">all</span>


<span class="k">def</span> <span class="nf">list_more_members</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
    <span class="s">"""
    :type client: dropbox.DropboxTeam
    :type cursor: str
    :rtype: list[dropbox.team.TeamMemberInfo]
    """</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">team_members_list_continue</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">chunk</span><span class="p">.</span><span class="n">has_more</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chunk</span><span class="p">.</span><span class="n">members</span> <span class="o">+</span> <span class="n">list_more_members</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chunk</span><span class="p">.</span><span class="n">cursor</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chunk</span><span class="p">.</span><span class="n">members</span>


<span class="k">def</span> <span class="nf">list_members</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="s">"""
    :type client: dropbox.DropboxTeam
    :rtype: list[dropbox.team.TeamMemberInfo]
    """</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">team_members_list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">chunk</span><span class="p">.</span><span class="n">has_more</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chunk</span><span class="p">.</span><span class="n">members</span> <span class="o">+</span> <span class="n">list_more_members</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chunk</span><span class="p">.</span><span class="n">cursor</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chunk</span><span class="p">.</span><span class="n">members</span>


<span class="k">def</span> <span class="nf">show_properties_templates</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="s">"""
    :type client: dropbox.DropboxTeam
    """</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">team_properties_template_list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">.</span><span class="n">template_ids</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">team_properties_template_get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">"Template Id: %s"</span> <span class="o">%</span> <span class="n">t</span>
        <span class="k">print</span> <span class="s">"Template Name: %s"</span> <span class="o">%</span> <span class="n">template</span><span class="p">.</span><span class="n">name</span>
        <span class="k">print</span> <span class="s">"Description: %s"</span> <span class="o">%</span> <span class="n">template</span><span class="p">.</span><span class="n">description</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">template</span><span class="p">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">"Field[%s] Description[%s]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">.</span><span class="n">description</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_properties_template_id_by_name</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="s">"""
    :type client: dropbox.DropboxTeam
    :type name: str
    :rtype: str | None
    """</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">team_properties_template_list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">.</span><span class="n">template_ids</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">team_properties_template_get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">template</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">t</span>

    <span class="k">return</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">audit_file</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">template_id</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
    <span class="s">"""
    :type client: dropbox.Dropbox
    :type template_id: str
    :type file: dropbox.files.FileMetadata
    """</span>
    <span class="k">print</span> <span class="s">"Auditing file: %s"</span> <span class="o">%</span> <span class="nb">file</span><span class="p">.</span><span class="n">path_display</span>

    <span class="n">meta</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">files_alpha_get_metadata</span><span class="p">(</span><span class="nb">file</span><span class="p">.</span><span class="n">path_lower</span><span class="p">,</span> <span class="n">include_property_templates</span><span class="o">=</span><span class="p">[</span><span class="n">template_id</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">dropbox</span><span class="p">.</span><span class="n">files</span><span class="p">.</span><span class="n">FileMetadata</span><span class="p">)</span> <span class="ow">and</span> <span class="n">meta</span><span class="p">.</span><span class="n">property_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">.</span><span class="n">property_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">template_id</span> <span class="o">==</span> <span class="n">template_id</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">fields</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">"File[%s] Security Policy: %s = %s"</span> <span class="o">%</span> <span class="p">(</span><span class="nb">file</span><span class="p">.</span><span class="n">path_display</span><span class="p">,</span> <span class="n">field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Mark as Confidential for every '.pdf'
</span>    <span class="k">if</span> <span class="nb">file</span><span class="p">.</span><span class="n">path_lower</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.pdf'</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"Updating security policy: %s : template_id=%s"</span> <span class="o">%</span> <span class="p">(</span><span class="nb">file</span><span class="p">.</span><span class="n">path_display</span><span class="p">,</span> <span class="n">template_id</span><span class="p">)</span>
        <span class="n">level_field</span> <span class="o">=</span> <span class="n">PropertyField</span><span class="p">(</span><span class="s">'Level'</span><span class="p">,</span> <span class="s">'Confidential'</span><span class="p">)</span>
        <span class="n">prop_group</span> <span class="o">=</span> <span class="n">PropertyGroup</span><span class="p">(</span><span class="n">template_id</span><span class="p">,</span> <span class="p">[</span><span class="n">level_field</span><span class="p">])</span>
        <span class="n">client</span><span class="p">.</span><span class="n">files_properties_overwrite</span><span class="p">(</span><span class="nb">file</span><span class="p">.</span><span class="n">path_lower</span><span class="p">,</span> <span class="p">[</span><span class="n">prop_group</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">audit_member</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">template_id</span><span class="p">,</span> <span class="n">member</span><span class="p">):</span>
    <span class="s">"""
    :type client: dropbox.Dropbox
    :type template_id: str
    :type member: dropbox.team.TeamMemberInfo
    """</span>
    <span class="k">print</span> <span class="s">"Auditing files of member: %s"</span> <span class="o">%</span> <span class="n">member</span><span class="p">.</span><span class="n">profile</span><span class="p">.</span><span class="n">email</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">list_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dropbox</span><span class="p">.</span><span class="n">files</span><span class="p">.</span><span class="n">FileMetadata</span><span class="p">):</span>
            <span class="n">audit_file</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">template_id</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">client_team</span> <span class="o">=</span> <span class="n">dropbox</span><span class="p">.</span><span class="n">DropboxTeam</span><span class="p">(</span><span class="n">DROPBOX_TEAM_FILE</span><span class="p">)</span>

    <span class="c1"># List existing properties template
</span>    <span class="n">show_properties_templates</span><span class="p">(</span><span class="n">client_team</span><span class="p">)</span>

    <span class="c1"># Lookup template named 'Security Policy'
</span>    <span class="n">tmpl_name</span> <span class="o">=</span> <span class="s">'Security Policy'</span>
    <span class="n">tmpl_desc</span> <span class="o">=</span> <span class="s">'These properties describe how confidential this file is.'</span>
    <span class="n">tmpl_field_level_name</span> <span class="o">=</span> <span class="s">'Level'</span>
    <span class="n">tmpl_field_level_desc</span> <span class="o">=</span> <span class="s">'Level can be Confidential, Public or Internal.'</span>

    <span class="n">security_policy_template_id</span> <span class="o">=</span> <span class="n">find_properties_template_id_by_name</span><span class="p">(</span><span class="n">client_team</span><span class="p">,</span> <span class="n">tmpl_name</span><span class="p">)</span>

    <span class="c1"># Add template if not exist
</span>    <span class="k">if</span> <span class="n">security_policy_template_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">PropertyFieldTemplate</span><span class="p">(</span><span class="n">tmpl_field_level_name</span><span class="p">,</span> <span class="n">tmpl_field_level_desc</span><span class="p">,</span> <span class="n">PropertyType</span><span class="p">.</span><span class="n">string</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">security_policy_template_id</span> <span class="o">=</span> <span class="n">client_team</span><span class="p">.</span><span class="n">team_properties_template_add</span><span class="p">(</span><span class="n">tmpl_name</span><span class="p">,</span> <span class="n">tmpl_desc</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">security_policy_template_id</span>

    <span class="c1"># Audit member files
</span>    <span class="n">members</span> <span class="o">=</span> <span class="n">list_members</span><span class="p">(</span><span class="n">client_team</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
        <span class="c1"># Create client as user
</span>        <span class="n">c</span> <span class="o">=</span> <span class="n">client_team</span><span class="p">.</span><span class="n">as_user</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">profile</span><span class="p">.</span><span class="n">team_member_id</span><span class="p">)</span>
        <span class="n">audit_member</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">security_policy_template_id</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
</code></pre></div></div> </div> <div class="post"> <h1 class="post-title"> <a href="/2017/02/01/from-aerobatic-to-github-pages/"> Aerobaticから再びGithub Pages + CloudFlareへ </a> </h1> <span class="post-date"> 1st February 2017</span> <span class="post-tags"> #<a href="/tags/aerobatic">aerobatic</a> #<a href="/tags/cloudflare">cloudflare</a> #<a href="/tags/githubpages">githubpages</a> #<a href="/tags/jekyll">jekyll</a> </span> <p><a href="/2017/01/15/from-github-pages-to-aerobatic/">つい2週間ほど前にこのブログのホスティングサービスをAerobatic引っ越しをしたところ</a>ですが、またGithub Pages + CloudFlareに切り戻すことにしました。<a href="https://www.aerobatic.com/blog/announcing-aerobatic-transition/">サービス体系が大幅に見直されAerobaticの無償プランにカスタムドメインのサービスが含まれなくなってしまった</a>ためです。また、ツール群もBitbucketのアドインという形式から、別途CLIベースのものになりました。</p> <p>無償プランがなくなったから、あるいはCLIになったからというだけで移行するには忍びないですが、有償プランが一本化され$15/月だけになってしまったのは残念です。「$2〜3/月でカスタムドメイン1つ」程度であれば充分利用する気持ちになったのですが、このような小規模ブログには新料金プランはオーバースペックでした。</p> <p>このようなこともありまた元のGithub Pages + CloudFlareへ切り戻しをしました。幸いにしてJekyllで制作したブログのホスティング先切り替えは非常に簡単です。10分程度で終わってしまいました。</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2017/01/22/go-bandwidth-limit-for-multiple-io/"> Go: Bandwidth limit for multiple Reader and Writer </a> </h1> <span class="post-date"> 22nd January 2017</span> <span class="post-tags"> #<a href="/tags/bandwidth">bandwidth</a> #<a href="/tags/concurrency">concurrency</a> #<a href="/tags/go">go</a> </span> <p>Bandwidth limit is really important for stabilizing systems. Core business logic stops if low priority job consume entire bandwidth of the system. When writing bandwidth limit for <code class="language-plaintext highlighter-rouge">Reader</code> or <code class="language-plaintext highlighter-rouge">Writer</code> in Go, I found <a href="https://github.com/mxk/go-flowrate">go-flowrate</a>. This library enables easy way to limit bandwidth like the code below.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data.dat"</span><span class="p">)</span>

    <span class="c">// Create wrapper with 100 bytes per second</span>
    <span class="n">f2</span> <span class="o">:=</span> <span class="n">flowrate</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>

    <span class="c">// Biz logic</span>
    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre></div></div> <p>APIs are pretty simple and reliable. But <code class="language-plaintext highlighter-rouge">go-flowrate</code> can limit bandwidth only for single <code class="language-plaintext highlighter-rouge">Reader</code> or <code class="language-plaintext highlighter-rouge">Writer</code>. In my case, I was working on file uploader for Dropbox which has concurrent upload feature. This code require limiting bandwidth for multiple I/O. So I decided create new small library for bandwidth limit.</p> <h1 id="bwlimit"><code class="language-plaintext highlighter-rouge">bwlimit</code></h1> <p><code class="language-plaintext highlighter-rouge">bwlimit</code> is the name of my library. You can see or clone from github <a href="https://github.com/watermint/bwlimit">bwlimit</a>. Here is code example of <code class="language-plaintext highlighter-rouge">bwlimit</code>.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// Limit 100 bytes per second</span>
    <span class="n">bwlimit</span> <span class="o">:=</span> <span class="n">NewBwlimit</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="no">false</span><span class="p">)</span>

    <span class="c">// Prepare multiple readers</span>
    <span class="n">f1</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data1.dat"</span><span class="p">)</span>
    <span class="n">f2</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data2.dat"</span><span class="p">)</span>

    <span class="c">// Create wrapper</span>
    <span class="n">fr1</span> <span class="o">:=</span> <span class="n">bwlimit</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
    <span class="n">fr2</span> <span class="o">:=</span> <span class="n">bwlimit</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>

    <span class="c">// Biz logic</span>
    <span class="c">// ...</span>

    <span class="c">// Wait for all Reader to be closed or reach EOF</span>
    <span class="n">bwlimit</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div> <p>1) Prepare bandwidth limiting object (<code class="language-plaintext highlighter-rouge">bwlimit</code> in above code) first. Second argument is the flag for block(true) or unblock(false) for <code class="language-plaintext highlighter-rouge">Read</code> or <code class="language-plaintext highlighter-rouge">Write</code> operation. 2) Then, create wrapper for each <code class="language-plaintext highlighter-rouge">Reader</code> or <code class="language-plaintext highlighter-rouge">Writer</code>.</p> <h1 id="concept">Concept</h1> <p>The concept of <code class="language-plaintext highlighter-rouge">bwlimit</code> comes from Toyota’s Production System (TPS). In TPS, <a href="https://en.wikipedia.org/wiki/Takt_time">Takt time</a> is the core concept for leveling production. Define time unit of ship defined quantity of products.</p> <p>For example; 1) Takt time is 100ms, 2) bandwidth limit is 1,000 bytes per second. 100 bytes is maximum transferrable data size per takt time. If <code class="language-plaintext highlighter-rouge">bwlimit</code> object has two <code class="language-plaintext highlighter-rouge">Readers</code>, that mean 50 bytes per <code class="language-plaintext highlighter-rouge">Reader</code> per takt time.</p> <h1 id="flow-control">Flow control</h1> <p><code class="language-plaintext highlighter-rouge">bwlimit</code> does not carry bandwidth window to next takt time. If the Reader have 50 bytes window per takt time, and the Reader read nothing. Then, window size of next takt time will be 50 bytes. This is because if <code class="language-plaintext highlighter-rouge">bwlimit</code> carry unused window to next takt time. <code class="language-plaintext highlighter-rouge">bwlimit</code> may allow burst IO for certain takt time. That sometime cause buffer overflow of routers. To prevent incident caused by burst IO.</p> </div> <div class="post"> <h1 class="post-title"> <a href="/2017/01/15/from-github-pages-to-aerobatic/"> Github Pages + CloudFlareからAerobaticへ </a> </h1> <span class="post-date"> 15th January 2017</span> <span class="post-tags"> #<a href="/tags/aerobatic">aerobatic</a> #<a href="/tags/githubpages">githubpages</a> #<a href="/tags/jekyll">jekyll</a> </span> <p>つい先月、Tumblrから<a href="/2016/12/12/tumblr-to-jekyll/">Jekyll + Github Pages</a>に移行したところですが、今度はJekyll + <a href="https://www.aerobatic.com/">Aerobatic</a>に移行しました。</p> <p>これでこのブログのサーバお引っ越しは、次のように4回目になりました。</p> <ol> <li>WordPress + さくらインターネット (2005〜2013)</li> <li>Tumblr (2013〜2016)</li> <li>Jekyll + Github Pages + CloudFlare (2016〜2017)</li> <li>Jekyll + Aerobatic (2017〜)</li> </ol> <p>WordPressからTumblrに移行したり、TumblrからJekyllに移行するのはコンテンツの調整などでさまざま面倒な点があります。たとえば、既存コンテンツに対するURLを引き継ぎたいといった要望に対して対応するのはコンテンツ個別に調整と動作確認が必要でした。</p> <p>今回、コンテンツはそのままJekyllで運用するのでインフラ部分の移行のみです。</p> <h2 id="github-pagesから移行した理由">Github Pagesから移行した理由</h2> <p>基本的な使い方としてはGithub Pagesで充分満足が行くものでした。ただ、気になる点としては下記2点がありました。</p> <ul> <li>HTTPSに対応できない</li> <li>Minifierが使えない</li> </ul> <p>Github Pagesでカスタムドメインとして登録した場合、現状ではHTTPSでコンテンツを提供することができません。ブログコンテンツの内容として、HTTPS通信の必要性はさほどありません。ただ、Appleによる<a href="https://developer.apple.com/news/?id=12212016b">App Transport Securityなどでは2016年末までという期限こそ延長された</a>もののデフォルトでHTTPSを提供するようにとした方針に変更はありません。こういった状況を考えれば、HTTPSでのコンテンツ提供準備は早くできているに越したことはありません。</p> <p>次にMinifierです。<a href="https://github.com/digitalsparky/jekyll-minifier">jekyll-minifier</a>を使おうとしましたがGithub Pagesではうまく動作しませんでした。</p> <h2 id="github-pages--cloudflare">Github Pages + CloudFlare</h2> <p>次にGithub Pagesだけではうまく2つの課題に対応できなかったので、CloudFlareを組み合わせることにしました。CloudFlareを経由して通信を行えば２つの課題は解消できます。もともと、watermint.orgドメインのDNS管理はCloudFlareで行っていたのでCloudFlareを経由するかどうかのオプションを変えるだけですみました。</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Client] ---&lt;HTTP/HTTPS&gt;--- [CloudFlare] ---&lt;HTTP&gt;--- [Github Pages]
</code></pre></div></div> <p>CloudFlareを経由すると、HTTPSで接続要求があった場合CloudFlare側でHTTPSで処理してくれます。元のコンテンツであるGithub PagesとCloudFlare間は従来通りHTTPでの通信となります。CloudFlareから証明書も無償で発行してもらえます。</p> <p>CloudFlareではCDNとしてコンテンツキャッシュをするだけでなく、Minifyのような処理も追加オプションとして用意されています。これも使い方は単純にオプションを有効化すればよいだけで、自動的にHTMLやCSSなどのコンテンツを最適化してくれます。</p> <h2 id="aerobaticへの移行">Aerobaticへの移行</h2> <p>上記のように課題は解決されたので移行の必要性は高くありませんでしたが、機能面でGithub Pagesよりも多彩であることと、Aerobaticサーバ側から直接HTTPS通信をサポートすることができるのでこちらに移行することにしました。AerobaticでもCloudFlareと同様に証明書は無償で発行してもらえます。</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Client] ---&lt;HTTP/HTTPS&gt;--- [Aerobatic]
</code></pre></div></div> <p>AerobaticはGithubとGithub Pagesの関係と同様に、BitbucketとAerobaticというようにソースコードレポジトリと対にしてコンテンツを管理します。Aerobaticでは複数のブランチに対してサービスの設定が可能で、ステージング用のブランチとステージング用サブドメインを設定するといった運用ができます。</p> <p>コンテンツは公開順ごとにバージョンが振られていきロールバックなどもgit操作なしで簡単に行えます。</p> <p>他には、Githubでプライベートレポジトリは有償ですが、Bitbucketであればプライベートレポジトリも無償で利用できます。Jekyllのサイトデータであれば、公開してあっても特に困りませんが、あまりレポジトリ内のファイルが散らかっていると恥ずかしいので、、といった理由でプライベートにできたほうがうれしいですね。</p> <p><img src="/images/2017-01-15-website-versions.png" alt="Websiteバージョン"/></p> <p>実はTumblrからJekyllに移行する際の本命がこちらのAerobaticだったのですが後述の問題があったので取り急ぎGithub Pagesに移行することにしていました。</p> <h2 id="aerobaticでドメイン設定ができない">Aerobaticでドメイン設定ができない</h2> <p>AerobaticではCDNにAWSのCloudFrontを使っています。証明書はCloudFront側で発行されるものを使うのですが、この処理でエラーとなってしまい、ホスティングの設定ができませんでした。</p> <p>検索してもなかなか同様の報告が見当たらず解決の糸口がなかったのですが、今回とりあえずAerobaticのサポート宛てに問い合わせをしてみたところ、翌日には解決となりました。</p> <p>Aerobaticでカスタムドメインの設定をする際、まずCloudFront側からドメイン所有者であることを確認するためのメールを受け取り、承認処理を行います。この操作のあと、Aerobatic上でverify処理を進めれば次はDNSの設定。となるはずなのですがAerobatic上のverify処理で「CNAME already registered with CloudFront」というエラーがでて一向に進みません。</p> <p>このことをサポートに問い合わせたところ、すぐにエラーを解消してもらえたのですが、おそらく、ドメインwatermint.orgでCloudFrontを使ったことはなかったので承認処理手順の際に何かの拍子で2回処理が実行されてしまったのかもしれません。</p> <h2 id="jekyll-minifier--aerobatic">jekyll-minifier + Aerobatic</h2> <p>jekyll-minifierとAerobaticの組み合わせは先月試したときにはうまく動作したのですが、移行したタイミングでは動作しなくなってしまっていました。</p> <p>jekyll-minifierのリリース履歴を見ると2週間前に課題を解決するために、<a href="https://github.com/digitalsparky/jekyll-minifier/releases/tag/v0.1.0">0.1.0</a>がリリースされておりこの影響によるものでした。jekyll-minifierの参照については <code class="language-plaintext highlighter-rouge">_config.yml</code> に下記のように依存を書いておいただけだったのでバージョン指定はしていませんでした。</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">gems</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="s">jekyll-paginate</span>
 <span class="pi">-</span> <span class="s">jekyll-minifier</span>
</code></pre></div></div> <p>このように依存するライブラリのバージョンアップなどで急に動かなくなってしまっても不都合なので、<code class="language-plaintext highlighter-rouge">Gemfile</code>と<code class="language-plaintext highlighter-rouge">Gemfile.lock</code>でバージョンを固定しておくことにしました。Aerobaticの<a href="https://www.aerobatic.com/docs/automated-builds">Automated Builds</a>で説明がある通り、(1) <code class="language-plaintext highlighter-rouge">_plugins</code>にある<code class="language-plaintext highlighter-rouge">*.rb</code>ファイル、(2) <code class="language-plaintext highlighter-rouge">Gemfile</code>あるいは<code class="language-plaintext highlighter-rouge">Gemfile.lock</code>があれば<code class="language-plaintext highlighter-rouge">bundler</code>によるインストール、(3) <code class="language-plaintext highlighter-rouge">_config.yml</code>の<code class="language-plaintext highlighter-rouge">gems</code>配列。といった順でライブラリが参照されます。</p> <h2 id="aerobaticでの運用">Aerobaticでの運用</h2> <p>Aerobaticでは無償プランにて2つのドメインに対してHTTPSを含むコンテンツをホスティングすることができます。一方で無償版の制約としては1日のデプロイ回数が5回までに制限されていることです。</p> <p>一日に何度も記事を公開するようなブログであれば有償プランを選択する必要があります。また、上述のminifierのような処理を入れようとするタイミングではいろいろ試行錯誤するので5回という制約はかなり作業に影響します。Aerobaticは際立って高価なサービスではないので有償版にアップグレードしてもよいのですが、複数のドメインでサービスを提供したり、大量のコンテンツを持っているということもないので現状は見送って1日5回という制約の中で運用することにしています。</p> </div> </div> <div class="pagination"> <a class="pagination-item older" href="/page9">Older</a> <a class="pagination-item newer" href="/page7">Newer</a> </div> </div> <div class="container copyright"> &copy; 2007, 2013-2022 Takayuki Okazaki </div> </div> <label for="sidebar-checkbox" class="sidebar-toggle"></label> <script>!function(e){var r=e.querySelector(".sidebar-toggle"),t=e.querySelector("#sidebar"),n=e.querySelector("#sidebar-checkbox");e.addEventListener("click",function(e){var c=e.target;n.checked&&!t.contains(c)&&c!==n&&c!==r&&(n.checked=!1)},!1)}(document);</script> </body> </html>