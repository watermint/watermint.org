<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Go Programming Trial and Error - Developing a command line tool for Dropbox &middot; watermint.org </title> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/watermint-logo.png"> <link rel="shortcut icon" href="/public/watermint-logo.png"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <style>*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:serif;font-size:14px;line-height:1.8}@media(min-width:38em){html{font-size:20px}}body{color:#515151;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a strong{color:inherit}a:hover,a:focus{text-decoration:underline}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:bold;line-height:1.25;color:#313131;text-rendering:optimizeLegibility}h1{font-size:1.5rem;margin-top:1.6rem;margin-bottom:1.6rem}h2{margin-top:1.6rem;font-size:1.3rem}h3{margin-top:1.6rem;font-size:1.2rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}strong{color:#303030}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:bold}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:bold;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}code,pre{font-family:Menlo,Monaco,"Courier New",monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}.gist .gist-file{font-family:Menlo,Monaco,"Courier New",monospace!important}.gist .markdown-body{padding:15px}.gist pre{padding:0;background-color:transparent}.gist .gist-file .gist-data{font-size:.8rem!important;line-height:1.4}.gist code{padding:0;color:inherit;background-color:transparent;border-radius:0}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media(min-width:30em){blockquote{padding-right:5rem;padding-left:1.25rem}}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;border:1px solid #e5e5e5;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #e5e5e5}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#f9f9f9}.lead{font-size:1.25rem;font-weight:300}.message{margin-bottom:1rem;padding:1rem;color:#717171;background-color:#f9f9f9}.container{max-width:38rem;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.post-tags{display:block;margin-top:-.5rem;margin-bottom:1rem;text-align:right}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:"PT Sans",Helvetica,Arial,sans-serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}html,body{overflow-x:hidden;line-height:1.9em}html{font-family:serif}h1,h2,h3,h4,h5,h6{font-weight:400;color:#313131}.wrap{position:relative;width:100%}.container{max-width:28rem}@media(min-width:38em){.container{max-width:32rem}}@media(min-width:56em){.container{max-width:38rem}}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem;border-bottom:1px solid #eee}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}@media(max-width:48em){.masthead-title{text-align:center}.masthead-title small{display:none}}.sidebar{position:fixed;top:0;bottom:0;left:-14rem;width:14rem;visibility:hidden;overflow-y:auto;font-family:serif;font-size:.875rem;line-height:1.4em;color:rgba(255,255,255,.6);background-color:#202020;-webkit-transition:all .3s ease-in-out;transition:all .3s ease-in-out}
@media(min-width:30em){.sidebar{font-size:.75rem}}.sidebar a{font-weight:normal;color:#fff}.sidebar-item{padding:1rem}.sidebar-item p:last-child{margin-bottom:0}.sidebar-nav{border-bottom:1px solid rgba(255,255,255,.1)}.sidebar-nav-item{display:block;padding:.5rem 1rem;border-top:1px solid rgba(255,255,255,.1)}.sidebar-nav-item.active,a.sidebar-nav-item:hover,a.sidebar-nav-item:focus{text-decoration:none;background-color:rgba(255,255,255,.1);border-color:transparent}@media(min-width:48em){.sidebar-item{padding:1.5rem}.sidebar-nav-item{padding-left:1.5rem;padding-right:1.5rem}}.sidebar-checkbox{position:absolute;opacity:0;-webkit-user-select:none;-moz-user-select:none;user-select:none}.sidebar-toggle{position:absolute;top:.8rem;left:1rem;display:block;padding:.25rem .75rem;color:#555;border-radius:.25rem;cursor:pointer}.sidebar-toggle:before{display:inline-block;width:1rem;height:.75rem;content:"";background-image:-webkit-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-moz-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-ms-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%)}.sidebar-toggle:active,#sidebar-checkbox:focus ~ .sidebar-toggle,#sidebar-checkbox:checked ~ .sidebar-toggle{color:#fff}.sidebar-toggle:active:before,#sidebar-checkbox:focus ~ .sidebar-toggle:before,#sidebar-checkbox:checked ~ .sidebar-toggle:before{background-image:-webkit-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-moz-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-ms-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%)}@media(min-width:30.1em){.sidebar-toggle{position:fixed}}@media print{.sidebar-toggle{display:none}}.wrap,.sidebar,.sidebar-toggle{-webkit-backface-visibility:hidden;-ms-backface-visibility:hidden;backface-visibility:hidden}.wrap,.sidebar-toggle{-webkit-transition:-webkit-transform .3s ease-in-out;transition:transform .3s ease-in-out}#sidebar-checkbox:checked+.sidebar{z-index:10;visibility:visible}#sidebar-checkbox:checked ~ .sidebar,#sidebar-checkbox:checked ~ .wrap,#sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(14rem);-ms-transform:translateX(14rem);transform:translateX(14rem)}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}.layout-reverse .sidebar{left:auto;right:-14rem}.layout-reverse .sidebar-toggle{left:auto;right:1rem}.layout-reverse #sidebar-checkbox:checked ~ .sidebar,.layout-reverse #sidebar-checkbox:checked ~ .wrap,.layout-reverse #sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(-14rem);-ms-transform:translateX(-14rem);transform:translateX(-14rem)}.theme-base-08 .sidebar,.theme-base-08 .sidebar-toggle:active,.theme-base-08 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#ac4142}.theme-base-08 .container a,.theme-base-08 .sidebar-toggle,.theme-base-08 .related-posts li a:hover{color:#ac4142}.theme-base-09 .sidebar,.theme-base-09 .sidebar-toggle:active,.theme-base-09 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#d28445}.theme-base-09 .container a,.theme-base-09 .sidebar-toggle,.theme-base-09 .related-posts li a:hover{color:#d28445}.theme-base-0a .sidebar,.theme-base-0a .sidebar-toggle:active,.theme-base-0a #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#f4bf75}
.theme-base-0a .container a,.theme-base-0a .sidebar-toggle,.theme-base-0a .related-posts li a:hover{color:#f4bf75}.theme-base-0b .sidebar,.theme-base-0b .sidebar-toggle:active,.theme-base-0b #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#90a959}.theme-base-0b .container a,.theme-base-0b .sidebar-toggle,.theme-base-0b .related-posts li a:hover{color:#90a959}.theme-base-0c .sidebar,.theme-base-0c .sidebar-toggle:active,.theme-base-0c #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#75b5aa}.theme-base-0c .container a,.theme-base-0c .sidebar-toggle,.theme-base-0c .related-posts li a:hover{color:#75b5aa}.theme-base-0d .sidebar,.theme-base-0d .sidebar-toggle:active,.theme-base-0d #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#6a9fb5}.theme-base-0d .container a,.theme-base-0d .sidebar-toggle,.theme-base-0d .related-posts li a:hover{color:#6a9fb5}.theme-base-0e .sidebar,.theme-base-0e .sidebar-toggle:active,.theme-base-0e #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#aa759f}.theme-base-0e .container a,.theme-base-0e .sidebar-toggle,.theme-base-0e .related-posts li a:hover{color:#aa759f}.theme-base-0f .sidebar,.theme-base-0f .sidebar-toggle:active,.theme-base-0f #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#8f5536}.theme-base-0f .container a,.theme-base-0f .sidebar-toggle,.theme-base-0f .related-posts li a:hover{color:#8f5536}.sidebar-overlay #sidebar-checkbox:checked ~ .wrap{-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0)}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar-toggle{box-shadow:0 0 0 .25rem #fff}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:.25rem 0 .5rem rgba(0,0,0,.1)}.layout-reverse.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:-.25rem 0 .5rem rgba(0,0,0,.1)}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight,.highlight .w{color:#586e75}.highlight .err{color:#002b36;background-color:#dc322f}.highlight .c,.highlight .cd,.highlight .cm,.highlight .c1,.highlight .cs{color:#657b83}.highlight .cp{color:#b58900}.highlight .nt{color:#b58900}.highlight .o,.highlight .ow{color:#93a1a1}.highlight .p,.highlight .pi{color:#93a1a1}.highlight .gi{color:#859900}.highlight .gd{color:#dc322f}.highlight .gh{color:#268bd2;background-color:#002b36;font-weight:bold}.highlight .k,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .kv{color:#6c71c4}.highlight .kc{color:#cb4b16}.highlight .kt{color:#cb4b16}.highlight .kd{color:#cb4b16}.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .sh,.highlight .sx,.highlight .s1{color:#859900}.highlight .sr{color:#2aa198}.highlight .si{color:#d33682}.highlight .se{color:#d33682}.highlight .nn{color:#b58900}.highlight .nc{color:#b58900}.highlight .no{color:#b58900}.highlight .na{color:#268bd2}.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .il,.highlight .mo,.highlight .mb,.highlight .mx{color:#859900}.highlight .ss{color:#859900}.copyright{font-size:.8em;font-style:italic;color:#555}</style> </head> <body class="theme-base-09"> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"> <div class="sidebar" id="sidebar"> <div class="sidebar-item"> <p>Travel, camera, photo, and technical things. I work at Dropbox. Thoughts are my own.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Archive</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> <a class="sidebar-nav-item" href="/atom.xml">Feed</a> <a class="sidebar-nav-item" href="https://github.com/watermint">Github</a> </nav> <div class="sidebar-item"> <p> &copy; 2005-2023 Takayuki Okazaki </p> </div> </div> <div class="wrap"> <div class="masthead"> <div class="container"> <h3 class="masthead-title"> <a href="/" title="Home">watermint.org</a> <small>- Takayuki Okazaki's note</small> </h3> </div> </div> <div class="container content"> <div class="post"> <h1 class="post-title">Go Programming Trial and Error - Developing a command line tool for Dropbox</h1> <span class="post-date"> 23rd July 2020</span> <span class="post-tags"> #<a href="/tags/cli">cli</a> #<a href="/tags/dropbox">dropbox</a> #<a href="/tags/golang">golang</a> #<a href="/tags/toolbox">toolbox</a> #<a href="/tags/waterminttoolbox">waterminttoolbox</a> </span> <p>I started building my first Go program in early 2016. I introduced it <a href="/2017/12/16/toolbox/">once on the blog in late 2017</a>. I’d like to introduce the differences from the time I introduced it, and also what I’ve tried and achieved with the Go language after about 4 years of practice, as a reminder. In this article, I’ll show you how I designed and implemented the language in the first part of this article.</p> <h1 id="watermint-toolbox">watermint toolbox</h1> <p><img src="/images/2020-07-22-toolbox-demo.gif" alt="watermint toolbox"/></p> <p>The project I spend the most time on in creating the Go program is a project called <a href="https://github.com/watermint/toolbox/">watermint toolbox</a>. This is a tool that allows you to manage files, permissions, etc. in Dropbox and Dropbox Business from the command line. For example, if you want to list the group members on your team, you can run the following</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>watermint toolbox 71.4.504
==========================

© 2016-2020 Takayuki Okazaki
Licensed under open source licenses. Use the `license` command for more detail.

Testing network connection...
Done

Scanning: Developer Inc のメンバー全員
Scanning: Okinawa
Scanning: Osaka
Scanning: Tokyo
group_name         group_management_type  access_type  email                    status   surname  given_name
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxx@xxxxxxxxx.xxx    active   杉戸       宏幸
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxxx@xxxxxxxxx.xxx   active   藤沢       由里子
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxxx@xxxxxxxxx.xxx   active   江川       紗和
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxx@xxxxxxxxx.xxx    active   正木       博史
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxxxx@xxxxxxxxx.xxx  invited           
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxx@xxxxxxxxx.xxx    active   Dropbox  Debugger
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxx@xxxxxxxxx.xxx    active   里咲       広瀬
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxx@xxxxxxxxx.xxx    active   関本       重信
The report generated: /Users/xxxxxxxx/.toolbox/jobs/20200723-101557.001/report/group_member.csv
The report generated: /Users/xxxxxxxx/.toolbox/jobs/20200723-101557.001/report/group_member.json
The report generated: /Users/xxxxxxxx/.toolbox/jobs/20200723-101557.001/report/group_member.xlsx
</code></pre></div></div> <p>(People’s names are pseudonyms, some output results have been replaced.)</p> <p>The result report is output to standard output and the details are saved to a file in CSV, xlsx or JSON format. You can select Markdown or JSON as the output format for the standard output, but if you select JSON, you can easily extract the group name and email address from the above mentioned output and convert them to CSV by using the jq command.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% tbx group member list -output json | jq -r '[.group.group_name, .member.profile.email] | @csv'
"xxxxxxxxx xxx のメンバー全員","xxx+xxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxxxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxx@xxxxxxxxx.xxx"
</code></pre></div></div> <p>(Some of the output results have been replaced.)</p> <p>It also implements more than 100 other commands such as file upload, list of shared links, add and remove members, and more. Please refer to the <a href="https://github.com/watermint/toolbox/blob/master/README.md">README</a> for more details on what you can do.</p> <h1 id="requirements-and-constraints">Requirements and constraints</h1> <p>The purpose of this tool development is to improve operational efficiency and solve issues in using Dropbox Business and Dropbox.</p> <p>Dropbox has released a script that solves a common issue in the repository called <a href="https://github.com/dropbox/DropboxBusinessScripts">DropboxBusinessScripts</a>. On the other hand, this project is about being as easy to implement as possible to solve our goals, and in particular, not requiring additional libraries or configuration to use the tool, which was the main reason for choosing Go.</p> <p>Since this program runs on a PC, its usage and messages should be easy to understand, and if a problem occurs, you should be able to find out the situation from a set of log files without having to ask for detailed information.</p> <p>This project was a personal development project, there is mainly time resource constraints. There were times when I could develop a certain amount of code at a time, and other times when I didn’t write any code for several months. When I don’t write anything for a few months, the structure of the code disappears from my mind, so I had to suffer a lot of duplication and redoing.</p> <p>The main requirements and constraints that I note from the above requirements and constraints are as follows. The reasons for each will be discussed below.</p> <ul> <li>distribution in a single binary (both executable and licensing point of view)</li> <li>Log every process to increase traceability</li> <li>Prioritize development productivity over CPU time</li> </ul> <p>More recently, I have been paying attention to the following points as additional requirements</p> <ul> <li>Internationalization (Japanese and English)</li> <li>To save time, documents are basically auto-generated</li> <li>Do not overwhelm the disk with log files and intermediate files.</li> <li>Memory consumption should generally be kept to under a few hundred MB.</li> <li>Improved durability and optimized execution speed</li> </ul> <p>I will recall how this project has been walked through with the above requirements and constraints in mind.</p> <h1 id="selecting-sdks-for-apis">Selecting SDKs for APIs</h1> <p>At the time of writing, <a href="https://watermint.github.io/toolbox/">watermint toolbox</a> has GitHub and Gmail related commands as well as Dropbox and Dropbox Business. These APIs are available as SDKs, so using these SDKs is more productive from the point of view of development productivity. I used to use SDKs in early stage of development, but I don’t use any SDKs including official and unofficial ones at this moment except OAuth2 implementation.</p> <p>The SDK has both useful aspects and constraints. In particular, the constraints include the following</p> <ul> <li>In many cases, the log output cannot be changed in granularity or output method due to proprietary implementation.</li> <li>Error handling is blacked out</li> <li>There is a time lag between API updates and SDK updates.</li> </ul> <p>Here’s a little more about each.</p> <h2 id="log">Log</h2> <p>This is not limited to the SDK, and it’s not limited to the Go language, but it’s quite difficult to unify the control to suppress the output or to get the trace log for debugging because each library logs to its own heart’s content. If you use the standard log library, you can switch the log output destination, but in the worst case, you can’t control the output by using <code class="language-plaintext highlighter-rouge">fmt.Printf</code>. So you can send a pull request, give up, or create your own library. This time, I made the REST API framework from SDK for the reasons mentioned later, so I decided to make it by myself.</p> <p>For log processing I used <a href="https://github.com/cihub/seelog">seelog</a> in the beginning, but now I use <a href="https://github.com/uber-go/zap">zap</a> wrapped in my own library. I think the main reason was that we wanted to change the JSON to a JSON that was easy to process in.</p> <p>Instead of using zap as it is, I wrapped it in my own library for additional processing such as log rotation, compression, etc., and also for insurance in case I have to switch to a different log library at another time. As you know, <a href="https://github.com/watermint/toolbox/commit/3f845e75a8e83b299469454b3d83695ccd1b0b72">it’s quite a hassle to switch log libraries</a>.</p> <h2 id="error-handling-is-black-boxed">Error handling is black boxed</h2> <p>In exception handling in languages with relatively strong types such as Java, classes are defined for each exception (e.g. <code class="language-plaintext highlighter-rouge">AuthenticationException</code> for authentication errors, <code class="language-plaintext highlighter-rouge">IOException</code> for network I/O problems, etc.) and the code that receives the exceptions handles them. You can determine and change the behavior.</p> <p>You can define each error type in Go as well, but in some libraries, the entire process is rounded up into a string. This is probably more a cultural part of the library implementation than a language specification; some libraries throw everything as an <code class="language-plaintext highlighter-rouge">Exception</code> or <code class="language-plaintext highlighter-rouge">RuntimeException</code> in Java as well. However, as I have a long experience with Java, I feel that Go is more likely to suffer from this kind of problem.</p> <p>For example, a case that still bothers me a bit is the <a href="https://github.com/golang/oauth2">golang/oauth2</a> Pull Request, <a href="https://github.com/golang/oauth2/pull/380">errors: return all tokens fetch related errors as claimed in structured</a>, where the errors are rounded to a string. Then it’s bit difficult to determine is the error retriable or not. Since this Pull Request seems to be neglected for more than a year, it’s quite difficult to decide whether to give up on Google’s implementation or to accept this as a specification and use it with a fixed version.</p> <p>Other than this, I also experienced a black box error handling that made it look like a server error, even though it was a parameter error, and I wasted a lot of time trying to figure out what was going on. The accumulation of this wastage was a major driving force behind the plan to de-SDK.</p> <p>Since the current <a href="https://github.com/watermint/toolbox/">watermint toolbox</a> is implemented using my own REST API framework instead of using the SDK, all API requests and responses, except for those around OAuth2, are individually logged in JSON format, not to mention the trace log output during processing. For this reason, the reproducibility is high and it is possible to quickly determine whether the error is a parameter problem or a network problem.</p> <p>Related commands have been added to improve productivity, for example, the API request and response of the last command executed can be output in JSON format. jq command makes it easy to extract the request with response code 409. Note that the token string is automatically replaced with <secret> for safety reasons.</secret></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% tbx job log last -kind capture -quiet | jq
{
  "time": "2020-07-23T11:34:58.820+0900",
  "msg": "",
  "req": {
    "method": "POST",
    "url": "https://api.dropboxapi.com/2/team/get_info",
    "headers": {
      "Authorization": "Bearer &lt;secret&gt;",
      "User-Agent": "watermint-toolbox/`dev`"
    },
    "content_length": 0
  },
  "res": {
    "code": 200,
    "proto": "HTTP/2.0",
    "body": "{\"name\": \"xxxxxxxxx xxx\", \"team_id\": \"dbtid:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\", \"num_licensed_users\": 10, \"num_provisioned_users\": 8, \"policies\": {\"sharing\": {\"shared_folder_member_policy\": {\".tag\": \"anyone\"}, \"shared_folder_join_policy\": {\".tag\": \"from_anyone\"}, \"shared_link_create_policy\": {\".tag\": \"default_team_only\"}}, \"emm_state\": {\".tag\": \"disabled\"}, \"office_addin\": {\".tag\": \"disabled\"}}}",
    "headers": {
      "Cache-Control": "no-cache",
      "Content-Type": "application/json",
      "Date": "Thu, 23 Jul 2020 02:34:58 GMT",
      "Pragma": "no-cache",
      "Server": "nginx",
      "Vary": "Accept-Encoding",
      "X-Content-Type-Options": "nosniff",
      "X-Dropbox-Request-Id": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
      "X-Envoy-Upstream-Service-Time": "77",
      "X-Frame-Options": "SAMEORIGIN",
      "X-Server-Response-Time": "71"
    },
    "content_length": 400
  },
  "latency": 384840087
}
</code></pre></div></div> <p>(Some of the output results have been replaced.)</p> <p>There is also a command that can be used to process this output and display the execution options with the <code class="language-plaintext highlighter-rouge">curl</code> command. (Note: The latest release, 71.4.504 at the time of this writing, has a bug that prevents it from working. Please wait for release 72 or later.)</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% tbx job log last -kind capture -quiet | tbx dev util curl

watermint toolbox `dev`
=======================

© 2016-2020 Takayuki Okazaki
オープンソースライセンスのもと配布されています. 詳細は`license`コマンドでご覧ください.

curl -D - -X POST https://api.dropboxapi.com/2/team/get_info \
     --header "Authorization: Bearer &lt;secret&gt;" \
     --header "User-Agent: watermint-toolbox/`dev`" \
     --data ""

HTTP/2 200
cache-control: no-cache
content-type: application/json
date: Thu, 23 Jul 2020 02:34:58 GMT
pragma: no-cache
server: nginx
vary: Accept-Encoding
x-content-type-options: nosniff
x-dropbox-request-id: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
x-envoy-upstream-service-time: 77
x-frame-options: SAMEORIGIN
x-server-response-time: 71

{"name": "xxxxxxxxx Inc", "team_id": "dbtid:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx", "num_licensed_users": 10, "num_provisioned_users": 8, "policies": {"sharing": {"shared_folder_member_policy": {".tag": "anyone"}, "shared_folder_join_policy": {".tag": "from_anyone"}, "shared_link_create_policy": {".tag": "default_team_only"}}, "emm_state": {".tag": "disabled"}, "office_addin": {".tag": "disabled"}}}
</code></pre></div></div> <p>(Some of the output results have been replaced.)</p> <p>The API logs are currently also used for automated testing. I can replay the old API logs for various business logic to ensure that the business logic has not been affected by refactoring of the framework. I also have a command to anonymize log information for the preparation of data for testing, to improve efficiency.</p> <h1 id="there-is-a-time-lag-between-api-updates-and-sdk-updates">There is a time lag between API updates and SDK updates.</h1> <p>When new APIs are added or parameters are added, it takes a certain amount of time for the SDK to keep up with those changes; in the case of the Dropbox API and the official SDK, the time lag is relatively short since the SDK is generated using the API’s DSL, called <a href="https://github.com/dropbox/stone">stone</a>.</p> <p><a href="https://github.com/dropbox/dropbox-sdk-go-unofficial">SDK for Go</a> is positioned as unofficial, at the time of writing there are eight months’ worth of differences between the latest API and the one in use.</p> <p>Whether or not to allow for this difference depends on your requirements, but in the <a href="https://watermint.github.io/toolbox/">watermint toolbox</a>, I decided not to use the SDK because we wanted to try out the latest APIs easily.</p> <p>One of the big advantages of using the SDK is that you don’t have to do the data structure definition yourself. As I’ve felt in the past when I was building tools to call REST APIs in Java and Scala, without using the SDK, most of the code was for defining data structures and mapping them to our own domain model. While the implementation work is monotonous and not very fun, I try to avoid this mapping work as much as possible because if I get it wrong, I get stuck in it. Again, in reinventing the REST API framework, I tried to keep the data structure definition to a minimum.</p> <p>The following structure is designed to handle shared link data in the Dropbox API, but we decided to define only the minimum number of fields necessary to handle it in this tool.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Metadata</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Raw</span>        <span class="n">json</span><span class="o">.</span><span class="n">RawMessage</span>
	<span class="n">Id</span>         <span class="kt">string</span> <span class="s">`path:"id" json:"id"`</span>
	<span class="n">Tag</span>        <span class="kt">string</span> <span class="s">`path:"\\.tag" json:"tag"`</span>
	<span class="n">Url</span>        <span class="kt">string</span> <span class="s">`path:"url" json:"url"`</span>
	<span class="n">Name</span>       <span class="kt">string</span> <span class="s">`path:"name" json:"name"`</span>
	<span class="n">Expires</span>    <span class="kt">string</span> <span class="s">`path:"expires" json:"expires"`</span>
	<span class="n">PathLower</span>  <span class="kt">string</span> <span class="s">`path:"path_lower" json:"path_lower"`</span>
	<span class="n">Visibility</span> <span class="kt">string</span> <span class="s">`path:"link_permissions.resolved_visibility.\\.tag" json:"visibility"`</span>
<span class="p">}</span>
</code></pre></div></div> <p>The first defined raw is the raw data returned by the API, and the following fields, such as Id and Tag, are automatically retrieved from path information in JSON, such as <code class="language-plaintext highlighter-rouge">path:"id"</code> and <code class="language-plaintext highlighter-rouge">path:"\\.tag"</code>.</p> <p>Fields are defined in this way for items of high interest to users, such as shared link names, URLs, expiration dates, etc., that you want to output as reports, and other information is handled as JSON data only. Reports are output in three formats: CSV, xlsx, and JSON, but only these defined fields are output to CSV/xlsx. If you need information not included here, you can use the <code class="language-plaintext highlighter-rouge">jq</code> command to extract it from the JSON output.</p> <p>In order to easily retrieve only the information necessary for business purposes, it is sufficient to refer to CSV and xlsx format reports, and the data necessary for automation, such as id information, can be retrieved from the JSON format. By using these loose data structure definitions, the program can be used with almost no impact when fields are added to the API.</p> <h1 id="addressing-requirements-and-constraints">Addressing requirements and constraints</h1> <p>We will now look back again at how we have addressed the requirements and constraints mentioned above.</p> <h2 id="single-binary-distribution">Single binary distribution</h2> <p>Being able to distribute a tool as a single binary is a very important theme for such a tool. If it is a tool that runs on my own PC or server, I can relax the library and OS requirements to some extent, but it is very important to support a wide range of OSs because it is a tool that runs on various users’ environments. The mechanism of single binary distribution is not limited to the Go language, but I think that the library group and the richness of the IDE have the advantage of being a certain pioneer in this field.</p> <p>Although the <a href="https://github.com/watermint/toolbox/">watermint toolbox</a> is licensed under the MIT license, it is linked with libraries under various other licenses. When selecting libraries, we mainly select the compatible BSD and Apache v2 licenses, and take care not to mix GPL licenses.</p> <h2 id="log-every-process-to-increase-traceability">Log every process to increase traceability</h2> <p>Problems that occur in a user’s environment are often difficult to reproduce in my own environment, partly because of differences in the PC environment, and partly because of differences in the configuration, environment and size of the Dropbox or Dropbox Business where the API is used. For this reason, the logs are all output in the trace level. The log size is quite inflated, but I allow for the log size because priority to the time. Also, as described later, I’m currently using compression and log rotation to prevent the logs from overwhelming the disk.</p> <p>Also, to make it easier to analyze the logs, the current version outputs all logs in JSON format (more precisely, <a href="http://jsonlines.org/">JSON Lines</a> format), to make it easier to extract errors and memory usage statistics by combining commands such as grep and <code class="language-plaintext highlighter-rouge">jq</code>.</p> <p>For example, by logging the last command executed and processing the results with <code class="language-plaintext highlighter-rouge">jq</code>, you can get time by time heap usage statistics, as shown below. Such statistics can be useful in identifying the cause of the problem, since detailed data, such as memory profilers, are difficult to obtain in the user environment.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% tbx job log last -kind toolbox -quiet | jq -r 'select(.caller == "es_memory/stats.go:33") | [.time, .HeapAlloc] | @csv'
"2020-07-23T12:34:08.549+0900",104991184
"2020-07-23T12:34:13.548+0900",105058744
"2020-07-23T12:34:18.550+0900",111987752
</code></pre></div></div> <h2 id="prioritize-development-productivity-over-cpu-time">Prioritize development productivity over CPU time</h2> <p>The <a href="https://github.com/watermint/toolbox/">watermint toolbox</a> is a program that mainly makes API calls, processes the results and outputs them. The execution time ratio is relatively high in API processing wait time, and the ratio of CPU time is not high and can be almost negligible. Therefore, the programming style has changed in the last four years to be in line with it.</p> <p>The biggest change is that I’ve been using Scala for a while now, and I’ve been trying to make my implementation functional and immutable. I’ve already failed to some extent in this endeavor, but I’ll talk about that later, but let’s start with the details.</p> <p>I don’t remember where I read it, but I think it said that the idea of Go is that we should not hide the complexity of the process in functions and so on. For example, when I need to sum the fields of some structure, my experience is that I usually think of cutting them out as functions to make them easier to reuse and test. Well, it’s not that hard to do.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">File</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Name</span> <span class="kt">string</span>
  <span class="n">Size</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TotalSize</span><span class="p">(</span><span class="n">files</span> <span class="p">[]</span><span class="n">File</span><span class="p">)</span> <span class="p">(</span><span class="n">total</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">file</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">files</span> <span class="p">{</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">file</span><span class="o">.</span><span class="n">Size</span>
  <span class="p">}</span>
  <span class="k">return</span>
<span class="p">}</span>
</code></pre></div></div> <p>This works and there is no problem at all, but the above claim is that when you call TotalSize(), that does not tell whether it’s O(N) or O(N2) processing, but the caller can’t understand how much processing order is hidden behind it, so you should inline this kind of simple processing I think the argument was something like this. I think it was a superstition in the early days of my introduction to Go. It may be a superstition that I made a mistake at the beginning of my introduction to Go.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">File</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Name</span> <span class="kt">string</span>
  <span class="n">Size</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">MyBizLogic</span><span class="p">()</span> <span class="p">{</span>
  <span class="c">// ...</span>
  
  <span class="k">var</span> <span class="n">folder1Total</span> <span class="kt">int</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">file</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">folder1Files</span> <span class="p">{</span>
    <span class="n">folder1Total</span> <span class="o">+=</span> <span class="n">file</span><span class="o">.</span><span class="n">Size</span>
  <span class="p">}</span>
  
  <span class="c">// ...</span>
  
  <span class="k">var</span> <span class="n">folder2Total</span> <span class="kt">int</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">file</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">folder2Files</span> <span class="p">{</span>
    <span class="n">folder2Total</span> <span class="o">+=</span> <span class="n">file</span><span class="o">.</span><span class="n">Size</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Naturally, the code would be less readable, and productivity was significantly reduced due to mistyping and lack of test coverage. If you really wanted to care about processing order, it would be much more effective to name your functions with Hungarian naming, like <code class="language-plaintext highlighter-rouge">ONLOGNTotal()</code> or <code class="language-plaintext highlighter-rouge">ON2Total()</code>. I was completely superstitious.</p> <p>Now that I understand myself that this is a superstition (it took me a couple of years to do so…), it’s only natural that you’d want to do the same array and hash operations that you’ve always done in Scala or Ruby. It’s natural to want to do the same kind of array and hash operations that you normally do in Scala or Ruby.</p> <p>I looked at some existing libraries and decided to use <a href="https://github.com/thoas/go-funk">go-funk</a> as a reference. <code class="language-plaintext highlighter-rouge">go-funk</code> makes full use of reflection to improve readability and productivity. As you can see in the <a href="https://github.com/thoas/go-funk#performance">Performance</a> section of the project introduction, they don’t prepare functions for each type like <code class="language-plaintext highlighter-rouge">ContainsInt()</code> does.</p> <p>I thought about using <code class="language-plaintext highlighter-rouge">go-funk</code>, but I decided to make my own to practice the Go language. The result is a library that looks like <a href="https://github.com/watermint/toolbox/tree/71.4.504/essentials/collections">this</a>. For example, you can define arrays <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code>, and then extract the common elements.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">:=</span> <span class="n">es_array</span><span class="o">.</span><span class="n">NewByInterface</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
<span class="n">b</span> <span class="o">:=</span> <span class="n">es_array</span><span class="o">.</span><span class="n">NewByInterface</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">)</span>
<span class="n">c</span> <span class="o">:=</span> <span class="n">a</span><span class="o">.</span><span class="n">Intersection</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="c">// -&gt; [2, 3]</span>
</code></pre></div></div> <p>I thought I could make a library that is somewhat immutable and functional, but as I mentioned above “This attempt has already failed to some extent”, I ran into a wall in the language specification. The problem is the type information.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">folder1Files</span><span class="p">,</span> <span class="n">folder2Files</span> <span class="p">[]</span><span class="n">File</span>

<span class="c">// ... Getting folder1Files and folder2Files</span>

<span class="c">// Convert from array to array interface for use in the library</span>
<span class="n">folder1List</span> <span class="o">:=</span> <span class="n">es_array</span><span class="o">.</span><span class="n">NewByInterface</span><span class="p">(</span><span class="n">folder1Files</span><span class="o">...</span><span class="p">)</span>
<span class="n">folder2List</span> <span class="o">:=</span> <span class="n">es_array</span><span class="o">.</span><span class="n">NewByInterface</span><span class="p">(</span><span class="n">folder2Files</span><span class="o">...</span><span class="p">)</span>

<span class="c">// Extract the files common to folder1 and folder2</span>
<span class="n">commonFiles</span> <span class="o">:=</span> <span class="n">folder1List</span><span class="o">.</span><span class="n">Intersection</span><span class="p">(</span><span class="n">folder2List</span><span class="p">)</span>
</code></pre></div></div> <p>Now, this works to a certain extent, but the problem is that each time we deal with the resulting elements, we need to cast them.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">commonFiles</span><span class="o">.</span><span class="n">Each</span><span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="n">v</span> <span class="n">es_value</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">f</span> <span class="o">:=</span> <span class="n">v</span><span class="o">.</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>
  <span class="c">// Processing the element</span>
<span class="p">})</span>
</code></pre></div></div> <p>Well, I’d say it’s not a problem, but while using the library makes it more efficient to some extent, it also increases the chance of a type exception at runtime, which is easy to solve in languages with strong types or type variables like Java and Scala, but difficult to solve in languages with weak types like Go. I guess.</p> <p><code class="language-plaintext highlighter-rouge">sort.Strings()</code> in the standard library, passing an array for each type will reduce type-related errors. On the other hand, this will only work if the number of elements in the array remains the same, and it won’t work if you want to extract common elements from the two arrays or join the two arrays as described above.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">menu</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">" Soba"</span><span class="p">,</span> <span class="s">"Udon"</span><span class="p">,</span> <span class="s">"Ramen"</span> <span class="p">}</span>
<span class="n">sort</span><span class="o">.</span><span class="n">Strings</span><span class="p">(</span><span class="n">menu</span><span class="p">)</span> <span class="c">// The array size doesn't change before and after processing</span>
</code></pre></div></div> <p>For now, I’m thinking about using this library in my entire project while covering the problems with unit tests, but if I come up with another good idea, I’d love to incorporate it into my work.</p> <h2 id="internationalization">Internationalization</h2> <p>The <a href="https://github.com/watermint/toolbox/">watermint toolbox</a> has been used in many countries, including Japanese users. Initially, the toolbox was only available in English, but since last year, we have been able to provide a Japanese language version.</p> <p><img src="/images/2020-07-22-omegat.png" alt="OmegaT"/></p> <p>The translation memory software is <a href="https://omegat.org/">OmegaT</a>, with a plugin for the JSON data format.</p> <p>There are a lot of libraries for internationalization, but I created them myself without thinking too much about it; I stored the message keys and translation text in JSON and switched the messages for display according to the language.</p> <p>Now that I think about it, it may have been good to use <a href="https://github.com/nicksnyder/go-i18n/">go-i18n</a>. go-i18n seems to use CLDR, and it seems to be able to handle differences of each language such as plural forms more finely. It may be worth trying to switch libraries at some point. Fortunately, I don’t think the switching cost is not so high because I don’t have deep implementation about internationalization.</p> <h2 id="to-save-time-documents-are-basically-auto-generated">To save time, documents are basically auto-generated</h2> <p>The most troublesome part of a personal project is the creation of the documentation. It takes a lot of time to create documents at the beginning, but it also takes some time to maintain them when the specifications change.</p> <p>For this reason, the <a href="https://github.com/watermint/toolbox/">watermint toolbox</a> automatically generates as much documentation as possible, including manuals. Although some explanations are missing, the ability to update the documentation in a comprehensive manner is a great advantage. It is not difficult to prepare manuals in the same format for multiple languages, as long as you have translated text.</p> <p>However, automatic generation required several steps to be taken. Treating command specifications as programmatic data, extracting messages from the source code, detecting and reporting missing messages, <a href="https://github.com/watermint/toolbox/blob/71.4.504/doc/generated/changes.md">generating update diffs for release notes</a>, incorporating checks into the release process, and so on, I now have the ability to generate some readable manuals automatically.</p> <p>The fact that command specifications can now be handled as data has been a nice side effect. Command specifications are stored in JSON format for each release, and this JSON makes it easier to extract, for example, a list of commands that take a CSV file as an argument.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% gzcat doc/generated/spec.json.gz | jq -r '.[] | select(.feeds | length &gt; 0) | .path'
file dispatch local
file import batch url
group batch delete
member clear externalid
member delete
member detach
member invite
member quota update
member replication
member update email
member update externalid
member update profile
team activity batch user
team device unlink
team filerequest clone
teamfolder batch archive
teamfolder batch permdelete
teamfolder batch replication
</code></pre></div></div> <h2 id="dont-overwhelm-the-disk-with-log-files-and-intermediate-files">Don’t overwhelm the disk with log files and intermediate files.</h2> <p>In order to improve the efficiency of the debugging process, I spent a relatively large amount of time on the log output part. On the other hand, operations on large folders and teams took longer to execute and the log sizes were not negligible. Sometimes exceeding 100 GB. For this reason, recent releases incorporate a mechanism to gzip the logs and divide them into smaller chunks, deleting the old logs when they exceed a certain size.</p> <p>Also, if it deletes the logs in order from the oldest, important data such as startup parameters may be lost, so I had to devise a way to output those data to a different log.</p> <p>Implementing the log compression and rotation process itself was not too difficult, but I spent a lot of time trying to improve stability on Windows. This is due to deadlocks in a multi-threaded environment. There were several issues, including deadlocking of mutexes and waiting for I/O processing that still deadlocked. The frequency of reoccurrence was about once every hour to a few hours, so fixing and confirming the fix was quite a challenge.</p> <p>I don’t think the code is durable enough for all conditions, but I believe the probable deadlock is mostly resolved. In addition, the deadlock was generally reproduced in the following code when connecting to the debugger.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">LogWriter</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span>
  <span class="n">m</span> <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span><span class="n">LogWriter</span><span class="p">)</span> <span class="n">Write</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">z</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
  <span class="k">defer</span> <span class="n">z</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
  
  <span class="k">return</span> <span class="n">z</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>Indeed, it’s possible that <code class="language-plaintext highlighter-rouge">Write()</code> itself could be deadlocked if it’s locked from the OS in some way. I haven’t researched the spec in detail, but that’s probably because I/O locking is more strict on Windows.</p> <p>What you can see from the black box test is that when you select any text on a console, such as PowerShell, the scrolling locks and the standard output stops. On macOS and Linux, such a lock does not occur. I would like to investigate this issue in more detail if a similar issue occurs again.</p> <h2 id="memory-consumption-should-be-generally-kept-to-a-few-hundred-mb">Memory consumption should be generally kept to a few hundred MB.</h2> <p>If you use an external library, the memory consumption may be higher than expected. We have a solution for some of the libraries that use a lot of memory. I’ll introduce some concrete examples.</p> <p>In addition to CSV and JSON, the <a href="https://github.com/watermint/toolbox/">watermint toolbox</a> also provides the xlsx file format, which is used by Excel and others.</p> <p>The CSV is enough for most cases, but if you try to read CSV with Japanese characters (UTF-8 encoding, no BOM) in Excel, Excel will not recognize the encoding correctly and the characters will be broken. You can add a BOM to the CSV side, but it will not be easy to use in programs that expect no-BOM. For this reason, I also support xlsx format output to avoid garbled characters in casual use.</p> <p>Now the xlsx format is one of the <a href="https://en.wikipedia.org/wiki/Office_Open_XML">Office Open XML</a>, now standardized as ISO/IEC 29500. xlsx files are a collection of zipped files, and the files that contain the main data are made in the XML format.</p> <p>Representing the spreadsheet in XML means that the entire spreadsheet needs to be expanded in memory once as a DOM or other XML tree. As the size of the spreadsheet grows, it uses proportionally more memory. Therefore, if you try to output the report in XML format, it will eat up the memory space proportionally according to the number of rows in the report. In some cases, this can cause an out of memory error and stop the process. As a countermeasure, the xlsx report is divided into separate files when the number of lines exceeds a certain number.</p> <p><img src="/images/2020-07-22-memory-consumption.png" alt="Trends in memory usage"/></p> <p>In addition to this, I also tuned the KVS, <a href="https://github.com/dgraph-io/badger">Badger</a>. It use memory for caching, based on the number of data items. Again, the method of obtaining memory statistics from the log files was useful for long-term measurements with different parameters. The figure above shows the memory consumption trend for the two parameter settings.</p> <h2 id="improved-durability-and-optimized-execution-speed">Improved durability and optimized execution speed</h2> <p>Durability and execution speed are areas where there is still room for growth. In terms of fault tolerance, I have already implemented automatic retries when calling APIs, but I believe that there is room for improvement in error handling for the framework as a whole.</p> <p>The <a href="https://github.com/watermint/toolbox/">watermint toolbox</a> consists of commands, which are the core of the business logic, and the framework part that supports it. In most cases, the business logic part of the toolbox does not process errors returned by the API, and therefore, when an error occurs, it is returned to the upper framework.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span><span class="n">List</span><span class="p">)</span> <span class="n">Exec</span><span class="p">(</span><span class="n">c</span> <span class="n">app_control</span><span class="o">.</span><span class="n">Control</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="n">entries</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">sv_files</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">Peer</span><span class="o">.</span><span class="n">Context</span><span class="p">())</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">err</span> <span class="c">// return an error to the upper framework</span>
  <span class="p">}</span>
  <span class="c">// ... Subsequent processing</span>
  
  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div> <p>Network IO errors are handled by the REST API framework, and this is not a problem. But when retrieving a file list from a folder, is it necessary for the business logic that a different process is performed if the file does not exist, or is it an authentication error. I don’t know if this is an error or not, and I think it’s a bad idea to write the logic in various places.</p> <p>Eventually I may settle again on the current form, but I may create a mechanism to explicitly separate what is handled by the framework from what is handled by the business logic, as there are attempts to implement <a href="https://github.com/mattn/go-try">try types</a>, or to return on errors or to use <code class="language-plaintext highlighter-rouge">panic()</code>.</p> <p>There is still a lot of room for improvement in optimizing the execution speed. The current commands are programmed to be executed in multi-threads if they can be distributed to some extent, such as file uploads, folder permissions, etc. I don’t have to worry too much about it because the Go language has an environment for parallel processing such as goroutine and channels. I like the fact that it can be implemented.</p> <p>On the other hand, if the execution time is longer than a few days, the overhead to reach the restart point becomes large, the intermediate file becomes bloated, and the progress is difficult to see. Therefore, it is time to consider introducing a processing framework that uses persistent asynchronous queues.</p> <h1 id="summary">Summary</h1> <p>I have incorporated some of the development processes myself, such as the release process, as part of the tools, and our development efficiency is much better than it was four years ago. On the other hand, the Go language and the ecosystem surrounding it has allowed me to add unexpectedly advanced features to our specifications with ease. In the early days of development, Java, Scala, and Ruby were more experienced, so it was a bit of a struggle, but finally I’m starting to get the feeling that I can do most of the implementation in Go.</p> <p>When I come up with an interesting implementation or a good library, I’d like to introduce it again.</p> <span class="post-tags"> #<a href="/tags/cli">cli</a> #<a href="/tags/dropbox">dropbox</a> #<a href="/tags/golang">golang</a> #<a href="/tags/toolbox">toolbox</a> #<a href="/tags/waterminttoolbox">waterminttoolbox</a> </span> </div> </div> <div class="container copyright"> &copy; 2007, 2013-2023 Takayuki Okazaki </div> </div> <label for="sidebar-checkbox" class="sidebar-toggle"></label> <script>!function(e){var r=e.querySelector(".sidebar-toggle"),t=e.querySelector("#sidebar"),n=e.querySelector("#sidebar-checkbox");e.addEventListener("click",function(e){var c=e.target;n.checked&&!t.contains(c)&&c!==n&&c!==r&&(n.checked=!1)},!1)}(document);</script> </body> </html>