<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Goプログラミング試行錯誤 - Dropbox向けコマンドラインツールの開発 &middot; watermint.org </title> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/watermint-logo.png"> <link rel="shortcut icon" href="/public/watermint-logo.png"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <style>*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:serif;font-size:14px;line-height:1.8}@media(min-width:38em){html{font-size:20px}}body{color:#515151;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a strong{color:inherit}a:hover,a:focus{text-decoration:underline}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:bold;line-height:1.25;color:#313131;text-rendering:optimizeLegibility}h1{font-size:1.5rem;margin-top:1.6rem;margin-bottom:1.6rem}h2{margin-top:1.6rem;font-size:1.3rem}h3{margin-top:1.6rem;font-size:1.2rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}strong{color:#303030}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:bold}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:bold;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}code,pre{font-family:Menlo,Monaco,"Courier New",monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}.gist .gist-file{font-family:Menlo,Monaco,"Courier New",monospace!important}.gist .markdown-body{padding:15px}.gist pre{padding:0;background-color:transparent}.gist .gist-file .gist-data{font-size:.8rem!important;line-height:1.4}.gist code{padding:0;color:inherit;background-color:transparent;border-radius:0}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media(min-width:30em){blockquote{padding-right:5rem;padding-left:1.25rem}}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;border:1px solid #e5e5e5;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #e5e5e5}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#f9f9f9}.lead{font-size:1.25rem;font-weight:300}.message{margin-bottom:1rem;padding:1rem;color:#717171;background-color:#f9f9f9}.container{max-width:38rem;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.post-tags{display:block;margin-top:-.5rem;margin-bottom:1rem;text-align:right}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:"PT Sans",Helvetica,Arial,sans-serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}html,body{overflow-x:hidden;line-height:1.9em}html{font-family:serif}h1,h2,h3,h4,h5,h6{font-weight:400;color:#313131}.wrap{position:relative;width:100%}.container{max-width:28rem}@media(min-width:38em){.container{max-width:32rem}}@media(min-width:56em){.container{max-width:38rem}}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem;border-bottom:1px solid #eee}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}@media(max-width:48em){.masthead-title{text-align:center}.masthead-title small{display:none}}.sidebar{position:fixed;top:0;bottom:0;left:-14rem;width:14rem;visibility:hidden;overflow-y:auto;font-family:serif;font-size:.875rem;line-height:1.4em;color:rgba(255,255,255,.6);background-color:#202020;-webkit-transition:all .3s ease-in-out;transition:all .3s ease-in-out}
@media(min-width:30em){.sidebar{font-size:.75rem}}.sidebar a{font-weight:normal;color:#fff}.sidebar-item{padding:1rem}.sidebar-item p:last-child{margin-bottom:0}.sidebar-nav{border-bottom:1px solid rgba(255,255,255,.1)}.sidebar-nav-item{display:block;padding:.5rem 1rem;border-top:1px solid rgba(255,255,255,.1)}.sidebar-nav-item.active,a.sidebar-nav-item:hover,a.sidebar-nav-item:focus{text-decoration:none;background-color:rgba(255,255,255,.1);border-color:transparent}@media(min-width:48em){.sidebar-item{padding:1.5rem}.sidebar-nav-item{padding-left:1.5rem;padding-right:1.5rem}}.sidebar-checkbox{position:absolute;opacity:0;-webkit-user-select:none;-moz-user-select:none;user-select:none}.sidebar-toggle{position:absolute;top:.8rem;left:1rem;display:block;padding:.25rem .75rem;color:#555;border-radius:.25rem;cursor:pointer}.sidebar-toggle:before{display:inline-block;width:1rem;height:.75rem;content:"";background-image:-webkit-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-moz-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:-ms-linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%);background-image:linear-gradient(to bottom,#555,#555 20%,#fff 20%,#fff 40%,#555 40%,#555 60%,#fff 60%,#fff 80%,#555 80%,#555 100%)}.sidebar-toggle:active,#sidebar-checkbox:focus ~ .sidebar-toggle,#sidebar-checkbox:checked ~ .sidebar-toggle{color:#fff}.sidebar-toggle:active:before,#sidebar-checkbox:focus ~ .sidebar-toggle:before,#sidebar-checkbox:checked ~ .sidebar-toggle:before{background-image:-webkit-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-moz-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:-ms-linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%);background-image:linear-gradient(to bottom,#fff 0%,#fff 20%,#d28445 20%,#d28445 40%,#fff 40%,#fff 60%,#d28445 60%,#d28445 80%,#fff 80%,#fff 100%)}@media(min-width:30.1em){.sidebar-toggle{position:fixed}}@media print{.sidebar-toggle{display:none}}.wrap,.sidebar,.sidebar-toggle{-webkit-backface-visibility:hidden;-ms-backface-visibility:hidden;backface-visibility:hidden}.wrap,.sidebar-toggle{-webkit-transition:-webkit-transform .3s ease-in-out;transition:transform .3s ease-in-out}#sidebar-checkbox:checked+.sidebar{z-index:10;visibility:visible}#sidebar-checkbox:checked ~ .sidebar,#sidebar-checkbox:checked ~ .wrap,#sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(14rem);-ms-transform:translateX(14rem);transform:translateX(14rem)}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}.layout-reverse .sidebar{left:auto;right:-14rem}.layout-reverse .sidebar-toggle{left:auto;right:1rem}.layout-reverse #sidebar-checkbox:checked ~ .sidebar,.layout-reverse #sidebar-checkbox:checked ~ .wrap,.layout-reverse #sidebar-checkbox:checked ~ .sidebar-toggle{-webkit-transform:translateX(-14rem);-ms-transform:translateX(-14rem);transform:translateX(-14rem)}.theme-base-08 .sidebar,.theme-base-08 .sidebar-toggle:active,.theme-base-08 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#ac4142}.theme-base-08 .container a,.theme-base-08 .sidebar-toggle,.theme-base-08 .related-posts li a:hover{color:#ac4142}.theme-base-09 .sidebar,.theme-base-09 .sidebar-toggle:active,.theme-base-09 #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#d28445}.theme-base-09 .container a,.theme-base-09 .sidebar-toggle,.theme-base-09 .related-posts li a:hover{color:#d28445}.theme-base-0a .sidebar,.theme-base-0a .sidebar-toggle:active,.theme-base-0a #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#f4bf75}
.theme-base-0a .container a,.theme-base-0a .sidebar-toggle,.theme-base-0a .related-posts li a:hover{color:#f4bf75}.theme-base-0b .sidebar,.theme-base-0b .sidebar-toggle:active,.theme-base-0b #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#90a959}.theme-base-0b .container a,.theme-base-0b .sidebar-toggle,.theme-base-0b .related-posts li a:hover{color:#90a959}.theme-base-0c .sidebar,.theme-base-0c .sidebar-toggle:active,.theme-base-0c #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#75b5aa}.theme-base-0c .container a,.theme-base-0c .sidebar-toggle,.theme-base-0c .related-posts li a:hover{color:#75b5aa}.theme-base-0d .sidebar,.theme-base-0d .sidebar-toggle:active,.theme-base-0d #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#6a9fb5}.theme-base-0d .container a,.theme-base-0d .sidebar-toggle,.theme-base-0d .related-posts li a:hover{color:#6a9fb5}.theme-base-0e .sidebar,.theme-base-0e .sidebar-toggle:active,.theme-base-0e #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#aa759f}.theme-base-0e .container a,.theme-base-0e .sidebar-toggle,.theme-base-0e .related-posts li a:hover{color:#aa759f}.theme-base-0f .sidebar,.theme-base-0f .sidebar-toggle:active,.theme-base-0f #sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#8f5536}.theme-base-0f .container a,.theme-base-0f .sidebar-toggle,.theme-base-0f .related-posts li a:hover{color:#8f5536}.sidebar-overlay #sidebar-checkbox:checked ~ .wrap{-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0)}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar-toggle{box-shadow:0 0 0 .25rem #fff}.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:.25rem 0 .5rem rgba(0,0,0,.1)}.layout-reverse.sidebar-overlay #sidebar-checkbox:checked ~ .sidebar{box-shadow:-.25rem 0 .5rem rgba(0,0,0,.1)}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight,.highlight .w{color:#586e75}.highlight .err{color:#002b36;background-color:#dc322f}.highlight .c,.highlight .cd,.highlight .cm,.highlight .c1,.highlight .cs{color:#657b83}.highlight .cp{color:#b58900}.highlight .nt{color:#b58900}.highlight .o,.highlight .ow{color:#93a1a1}.highlight .p,.highlight .pi{color:#93a1a1}.highlight .gi{color:#859900}.highlight .gd{color:#dc322f}.highlight .gh{color:#268bd2;background-color:#002b36;font-weight:bold}.highlight .k,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .kv{color:#6c71c4}.highlight .kc{color:#cb4b16}.highlight .kt{color:#cb4b16}.highlight .kd{color:#cb4b16}.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .sh,.highlight .sx,.highlight .s1{color:#859900}.highlight .sr{color:#2aa198}.highlight .si{color:#d33682}.highlight .se{color:#d33682}.highlight .nn{color:#b58900}.highlight .nc{color:#b58900}.highlight .no{color:#b58900}.highlight .na{color:#268bd2}.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .il,.highlight .mo,.highlight .mb,.highlight .mx{color:#859900}.highlight .ss{color:#859900}.copyright{font-size:.8em;font-style:italic;color:#555}</style> </head> <body class="theme-base-09"> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"> <div class="sidebar" id="sidebar"> <div class="sidebar-item"> <p>Travel, camera, photo, and technical things. I work at Dropbox. Thoughts are my own.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/archive/">Archive</a> <a class="sidebar-nav-item" href="/tags/">Tags</a> <a class="sidebar-nav-item" href="/atom.xml">Feed</a> <a class="sidebar-nav-item" href="https://github.com/watermint">Github</a> <a class="sidebar-nav-item" href="https://www.instagram.com/watermint/">Instagram</a> </nav> <div class="sidebar-item"> <p> &copy; 2005-2020 Takayuki Okazaki </p> </div> </div> <div class="wrap"> <div class="masthead"> <div class="container"> <h3 class="masthead-title"> <a href="/" title="Home">watermint.org</a> <small>- Takayuki Okazaki's note</small> </h3> </div> </div> <div class="container content"> <div class="post"> <h1 class="post-title">Goプログラミング試行錯誤 - Dropbox向けコマンドラインツールの開発</h1> <span class="post-date"> 22nd July 2020</span> <span class="post-tags"> #<a href="/tags/cli">cli</a> #<a href="/tags/dropbox">dropbox</a> #<a href="/tags/golang">golang</a> #<a href="/tags/toolbox">toolbox</a> #<a href="/tags/watermint toolbox">watermint toolbox</a> </span> <p>初めてのGoプログラムを作り始めたのが2016年初旬。<a href="/2017/12/16/toolbox/">ブログでも2017年末に一度紹介しています</a>。紹介した頃からの差分と、4年ほど実践してみたところでのGoという言語について試したこと、実現してきたことを備忘録がてら紹介します。紹介の前段としてどのような前提・要件をもとに設計・実装したか紹介していきます。</p> <h1 id="watermint-toolbox">watermint toolbox</h1> <p><img src="/images/2020-07-22-toolbox-demo.gif" alt="watermint toolbox"/></p> <p>Goプログラムを作る中で最も時間をかけているのが<a href="https://github.com/watermint/toolbox/">watermint toolbox</a>というプロジェクトです。これは、コマンドラインからDropboxやDropbox Businessのファイルや権限などを管理するためのツールです。たとえば、チーム内のグループメンバーを一覧したい場合には次のように実行します。</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./tbx group member list
watermint toolbox 71.4.504
==========================

© 2016-2020 Takayuki Okazaki
オープンソースライセンスのもと配布されています. 詳細は`license`コマンドでご覧ください.

情報を取得中: Tokyo
情報を取得中: xxxxxxxxx Inc のメンバー全員
情報を取得中: Okinawa
情報を取得中: Osaka
group_name         group_management_type  access_type  email                    status   surname  given_name
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxx@xxxxxxxxx.xxx    active   杉戸       宏幸
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxxx@xxxxxxxxx.xxx   active   藤沢       由里子
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxxx@xxxxxxxxx.xxx   active   江川       紗和
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxx@xxxxxxxxx.xxx    active   正木       博史
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxxxx@xxxxxxxxx.xxx  invited           
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxx@xxxxxxxxx.xxx    active   Dropbox  Debugger
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxx@xxxxxxxxx.xxx    active   里咲       広瀬
xxxxxxxxx Inc のメンバー全員  system_managed         member       xxx.xxx@xxxxxxxxx.xxx    active   関本       重信
レポートが作成されました: /Users/xxxxxxxx/.toolbox/jobs/20200723-101557.001/report/group_member.csv
レポートが作成されました: /Users/xxxxxxxx/.toolbox/jobs/20200723-101557.001/report/group_member.json
レポートが作成されました: /Users/xxxxxxxx/.toolbox/jobs/20200723-101557.001/report/group_member.xlsx
</code></pre></div></div> <p>(人名は仮名です、一部出力結果は置換しています)</p> <p>結果レポートは標準出力に出力されるほか、詳細はCSV、xlsx、JSON形式でファイルに保存されます。標準出力への出力形式はMarkdownやJSONも選択できます。JSONを選択すれば<a href="https://stedolan.github.io/jq/">jq</a>コマンドなどと組み合わせて、前掲の出力からグループ名とメールアドレスだけを抽出してCSVに変換するといった操作も簡単です。</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% tbx group member list -output json | jq -r '[.group.group_name, .member.profile.email] | @csv'
"xxxxxxxxx xxx のメンバー全員","xxx+xxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxxxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxx@xxxxxxxxx.xxx"
"xxxxxxxxx xxx のメンバー全員","xxx+xxx@xxxxxxxxx.xxx"
</code></pre></div></div> <p>(一部出力結果は置換しています)</p> <p>このほかにもファイルのアップロードや共有リンクの一覧、メンバーの追加・削除など100以上のコマンドを実装しています。どんなことができるか詳細は<a href="https://github.com/watermint/toolbox/blob/master/README_ja.md">README</a>をご参照ください。</p> <h1 id="要件や制約">要件や制約</h1> <p>このツール開発ではDropbox BusinessやDropboxを利用する上での実運用での効率化や課題解決を目的としています。</p> <p>Dropboxからは<a href="https://github.com/dropbox/DropboxBusinessScripts">DropboxBusinessScripts</a>というレポジトリでよく利用される課題を解消するスクリプトが公開されています。一方このプロジェクトでは、目的を解決するためになるべく簡単に実施できること、特にこのツールを使うにあたって追加のライブラリや環境設定を必要としないことをプロジェクトの意義としています。Goを選択した理由もまさにこの要件が最大の要因でした。</p> <p>このプログラムはPC上で動作させますので、使い方やメッセージがわかりやすく、また不具合が発生した時には事細かに状況を聞かなくともログファイル一式から状況がわかるような仕組みも必要です。</p> <p>このプロジェクトは個人的な開発で、主に時間的リソースの制約があります。ある程度まとめて開発できる時期もあれば、数ヶ月なにもコードを書かない時期もありました。数ヶ月何も書かないとコードの構成もさっぱりと頭から消えてしまうので、たくさんの重複実装とやり直し作業に苦しめられました。</p> <p>以上の要件や制約から注意している主な要件・制約は次の通りになります。それぞれ理由は後述していきます。</p> <ul> <li>シングルバイナリで配布できること (動作上もライセンス上も)</li> <li>あらゆる処理をログに取得してトレーサビリティーを高める</li> <li>CPU時間よりも開発生産性を優先する</li> </ul> <p>最近ではさらに追加要件として次のようなポイントにも気を配っています。</p> <ul> <li>国際化対応 (日本語と英語)</li> <li>時短のためにドキュメントは基本的に自動生成</li> <li>ログファイルや中間ファイルでディスクを圧迫しすぎないこと</li> <li>メモリの消費を概ね数百MB程度に抑えること</li> <li>耐障害性の向上と、実行速度の最適化</li> </ul> <p>以上の要件・制約を前提としてどのようにこのプロジェクトが歩んできたかを思い出していきます。</p> <h1 id="apiとsdkの選定">APIとSDKの選定</h1> <p><a href="https://watermint.github.io/toolbox/">watermint toolbox</a>では執筆時点でDropbox・Dropbox Business以外にもGitHubとGmail関連コマンドが実装されています。これらのAPIについてはそれぞれSDKが提供されていますのでこれを使うのが開発生産性の観点では有利です。開発初期にはSDKを使って開発をしていましたが、現時点ではOAuth2実装を除き公式・非公式含むSDKを利用していません。</p> <p>SDKは便利な側面と、制約事項を併せ持っています。とくに制約事項には次のようなものがあります。</p> <ul> <li>ログ出力が独自実装で粒度や出力方法を変更できない場合が多い</li> <li>エラー処理がブラックボックス化されている</li> <li>APIの更新とSDKの更新では時差がある</li> </ul> <p>それぞれ少し詳しく紹介します。</p> <h2 id="ログ出力が独自実装で粒度や出力方法を変更できない場合が多い">ログ出力が独自実装で粒度や出力方法を変更できない場合が多い</h2> <p>これはSDKだけに限りませんし、Go言語だけに限った話ではありませんが各ライブラリが思い思いにログ出力するため出力抑制あるいはデバッグのためのトレースログ取得といった制御の統一はかなり難しいところがあります。標準ログライブラリを使っていれば出力先を切り替えるなどできますが、酷い場合には<code class="highlighter-rouge">fmt.Printf</code>でログ出力しているなど制御が効かないケースもあります。このため地道にPull requestを送るか、諦めるか、あるいは自分でライブラリを作るかどれかの選択肢になります。今回は後述の理由などからSDKから自身でREST APIフレームワークを作りましたので、自身で作ることにしました。</p> <p>ログ処理については最初の頃<a href="https://github.com/cihub/seelog">seelog</a>を使っていましたが、いまでは<a href="https://github.com/uber-go/zap">zap</a>をさらに自身のライブラリでラップしたものを使っています。seelogからの乗り換え理由はあまり記憶が定かではありませんが、seelogでは設定のためにXMLが必要であったり、出力形式をjqで処理しやすいJSONに変更したかったのが大きな理由だったと思います。</p> <p>zapをそのまま使うのではなく、わざわざさらに自身のライブラリでラップしたのはログローテーション、圧縮など追加処理のためと、またもし別の機会に違うログライブラリに乗り換えるケースが生じた場合への保険のためです。ご承知の通り<a href="https://github.com/watermint/toolbox/commit/3f845e75a8e83b299469454b3d83695ccd1b0b72">ログライブラリの入れ替え</a>はかなり面倒ですから。。</p> <h2 id="エラー処理がブラックボックス化されている">エラー処理がブラックボックス化されている</h2> <p>Javaのように比較的強い型をもつ言語の例外処理では認証エラーならたとえばAuthenticationException、ネットワークI/O処理の問題であればIOExceptionといったように例外ごとにクラスが定義されそれぞれ例外を受け取ったコードが処理を判定し、振る舞いを変更できます。</p> <p>Goでも同様にエラー種別ごとに定義はできますが、ライブラリによっては全ての処理を文字列として丸め込んでしまうケースがあります。これは言語仕様というよりはライブラリ実装上の文化的な部分が大きいでしょう。Javaでも同じようになんでもExceptionやRuntimeExceptionとしてスローするようなライブラリもあります。ただ、この辺の当たり外れというと失礼ですが苦しめられるケースはJava経験がそれなりに長い身としてはGoのほうが多いように感じます。</p> <p>たとえば、今も少し悩んでいるケースとしては<a href="https://github.com/golang/oauth2">golang/oauth2</a>のPull Request、<a href="https://github.com/golang/oauth2/pull/380">errors: return all token fetch related errors as structured</a>で主張されている通り、エラーが文字列に丸められ、エラーがリトライ可能なものかどうか呼び出し側で判断できないというものがあります。1年以上このPull Requestも放置されているようなので、ここでGoogleの実装に見切りをつけるか、ある意味これを仕様として受け止めバージョンを固定した上で利用するかはかなり悩ましい部分です。</p> <p>これ以外にも、エラー処理がブラックボックス化されていることによって、パラメータの間違いなのにサーバエラーのように見えてしまって原因究明にかなりの時間を浪費した経験もあります。この浪費の蓄積は脱SDKを計画する大きな原動力となりました。</p> <p>現在の<a href="https://github.com/watermint/toolbox/">watermint toolbox</a>ではSDKを使わず独自のREST APIフレームワークを使って実装しているので、処理中のトレースログ出力はもちろんのこと、OAuth2周りをのぞくすべてのAPIリクエスト・レスポンスを個別にJSON形式のログに残しています。このため、再現性も高くエラーがパラメータの問題なのか、ネットワークの問題なのかすぐに判定できるようになりました。</p> <p>これに関連するコマンドも生産性向上のために追加してありたとえば、次のように最後に実行したコマンドのAPIリクエスト・レスポンスをJSON形式で出力できます。jqコマンドを使えばレスポンスコード409のリクエストだけ抽出するといった操作も簡単です。なお、トークン文字列は安全のために自動的に <code class="highlighter-rouge">&lt;secret&gt;</code> と置換されます。</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% tbx job log last -kind capture -quiet | jq
{
  "time": "2020-07-23T11:34:58.820+0900",
  "msg": "",
  "req": {
    "method": "POST",
    "url": "https://api.dropboxapi.com/2/team/get_info",
    "headers": {
      "Authorization": "Bearer &lt;secret&gt;",
      "User-Agent": "watermint-toolbox/`dev`"
    },
    "content_length": 0
  },
  "res": {
    "code": 200,
    "proto": "HTTP/2.0",
    "body": "{\"name\": \"xxxxxxxxx xxx\", \"team_id\": \"dbtid:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\", \"num_licensed_users\": 10, \"num_provisioned_users\": 8, \"policies\": {\"sharing\": {\"shared_folder_member_policy\": {\".tag\": \"anyone\"}, \"shared_folder_join_policy\": {\".tag\": \"from_anyone\"}, \"shared_link_create_policy\": {\".tag\": \"default_team_only\"}}, \"emm_state\": {\".tag\": \"disabled\"}, \"office_addin\": {\".tag\": \"disabled\"}}}",
    "headers": {
      "Cache-Control": "no-cache",
      "Content-Type": "application/json",
      "Date": "Thu, 23 Jul 2020 02:34:58 GMT",
      "Pragma": "no-cache",
      "Server": "nginx",
      "Vary": "Accept-Encoding",
      "X-Content-Type-Options": "nosniff",
      "X-Dropbox-Request-Id": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
      "X-Envoy-Upstream-Service-Time": "77",
      "X-Frame-Options": "SAMEORIGIN",
      "X-Server-Response-Time": "71"
    },
    "content_length": 400
  },
  "latency": 384840087
}
</code></pre></div></div> <p>(一部出力結果は置換しています)</p> <p>また、この出力を加工して <code class="highlighter-rouge">curl</code> コマンドで実行オプションを表示するコマンドもあります。(注: 執筆時点の最新リリース71.4.504にはバグがありうまく動作しません。リリース72以降をお待ちください)</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% tbx job log last -kind capture -quiet | tbx dev util curl

watermint toolbox `dev`
=======================

© 2016-2020 Takayuki Okazaki
オープンソースライセンスのもと配布されています. 詳細は`license`コマンドでご覧ください.

curl -D - -X POST https://api.dropboxapi.com/2/team/get_info \
     --header "Authorization: Bearer &lt;secret&gt;" \
     --header "User-Agent: watermint-toolbox/`dev`" \
     --data ""

HTTP/2 200
cache-control: no-cache
content-type: application/json
date: Thu, 23 Jul 2020 02:34:58 GMT
pragma: no-cache
server: nginx
vary: Accept-Encoding
x-content-type-options: nosniff
x-dropbox-request-id: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
x-envoy-upstream-service-time: 77
x-frame-options: SAMEORIGIN
x-server-response-time: 71

{"name": "xxxxxxxxx Inc", "team_id": "dbtid:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx", "num_licensed_users": 10, "num_provisioned_users": 8, "policies": {"sharing": {"shared_folder_member_policy": {".tag": "anyone"}, "shared_folder_join_policy": {".tag": "from_anyone"}, "shared_link_create_policy": {".tag": "default_team_only"}}, "emm_state": {".tag": "disabled"}, "office_addin": {".tag": "disabled"}}}
</code></pre></div></div> <p>(一部出力結果は置換しています)</p> <p>このAPIログは現在ほかに自動テストのためにも利用しています。各種ビジネスロジックに対して過去のAPIログをリプレイテストすることによりフレームワークのリファクタリングなどによりビジネスロジックが影響を受けていないことを確認できます。また、テスト用のデータ準備のためにログ情報を匿名化するためのコマンドも準備して効率化を図っています。</p> <h2 id="apiの更新とsdkの更新では時差がある">APIの更新とSDKの更新では時差がある</h2> <p>新しいAPIが追加されたり、パラメータが追加された場合にSDK側がそれらの変更に追従するには一定の時間がかかります。Dropbox APIと公式SDKの場合、<a href="https://github.com/dropbox/stone">stone</a>というAPI定義のDSLを使ってSDKを生成しているのでタイムラグは比較的短いですが<a href="https://github.com/dropbox/dropbox-sdk-go-unofficial">Go向けのSDK</a>は非公式という位置付けのためか執筆時点で最新APIと8ヶ月分の差分があります。</p> <p>この差分を許容するかどうかは要件次第ですが、<a href="https://watermint.github.io/toolbox/">watermint toolbox</a>では最新APIを気軽に試してみたいという気持ちが強くありSDKを使わない方向へと流れを決めていきました。</p> <p>SDKを使う大きなメリットの一つとしてデータ構造定義を自分で行わなくて良い点があります。以前JavaやScalaを使ってREST APIを呼び出すツールを作っていたときからも感じていましたが、SDKを使わない場合、ほとんどのコードはデータ構造定義と自前のドメインモデルとのマッピングのためのものでした。実装作業も単調であまり楽しくない割に、間違えるととことんはまるのでこのマッピングのための作業はなるべく避けたいと考えています。今回、またREST APIフレームワークを再発明するにあたっては、データ構造定義は最低限で済むように心がけました。</p> <p>次の構造体はDropbox APIの共有リンクデータを取り扱うためのものですが、このツールでは必要最小限のフィールドのみを定義して対応することにしました。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Metadata</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Raw</span>        <span class="n">json</span><span class="o">.</span><span class="n">RawMessage</span>
	<span class="n">Id</span>         <span class="kt">string</span> <span class="s">`path:"id" json:"id"`</span>
	<span class="n">Tag</span>        <span class="kt">string</span> <span class="s">`path:"\\.tag" json:"tag"`</span>
	<span class="n">Url</span>        <span class="kt">string</span> <span class="s">`path:"url" json:"url"`</span>
	<span class="n">Name</span>       <span class="kt">string</span> <span class="s">`path:"name" json:"name"`</span>
	<span class="n">Expires</span>    <span class="kt">string</span> <span class="s">`path:"expires" json:"expires"`</span>
	<span class="n">PathLower</span>  <span class="kt">string</span> <span class="s">`path:"path_lower" json:"path_lower"`</span>
	<span class="n">Visibility</span> <span class="kt">string</span> <span class="s">`path:"link_permissions.resolved_visibility.\\.tag" json:"visibility"`</span>
<span class="p">}</span>
</code></pre></div></div> <p>一番最初に定義されている<code class="highlighter-rouge">Raw</code>はAPIから返された生データで、続く<code class="highlighter-rouge">Id</code>や<code class="highlighter-rouge">Tag</code>などのフィールドは <code class="highlighter-rouge">path:"id"</code> や <code class="highlighter-rouge">path:"\\.tag"</code> といったJSON上のパスを示す付加情報から自動取得するようになっています。</p> <p>共有リンクの名前、URL、有効期限などレポートとして出力したい、ユーザーの関心が高い項目はこのようにフィールドを定義し、それ以外の情報はJSONデータのみとして取り扱っています。レポートはCSV、xlsx、JSON形式の3種類で出力されますが、CSV・xlsxにはこの定義されたフィールドのみが出力されます。ここに含まれない情報が必要な場合にはJSON出力から<code class="highlighter-rouge">jq</code>コマンドなどで取り出すという流れになります。</p> <p>ビジネス上必要な情報のみを気軽に取り出すためにはCSV・xlsx形式レポートを参照すればよく、Id情報など自動化のためにプログラム上必要なデータはJSON形式から取り出せるという使い分けです。このようなゆるいデータ構造定義を使うことにより、API使用上フィールドが追加された場合でも影響をほとんど受けることなくプログラムを使えるようになりました。</p> <h1 id="要件や制約事項への対応">要件や制約事項への対応</h1> <p>それではまた前掲の要件や制約事項についてどのような対応をしたか振り返っていきます。</p> <h2 id="シングルバイナリで配布できること">シングルバイナリで配布できること</h2> <p>シングルバイナリで配布できることはこのようなツールにとってとても大きなテーマです。自社内のPCやサーバーで実行するツールであればある程度ライブラリ・OS要件を緩和しても良いのですが、様々なユーザーの環境で動作するツールのため対応OSの幅はとても重要です。シングルバイナリで配布する仕組みはGo言語に限ったものではありませんが、ライブラリ群やIDEの充実度はこの分野のあるいみパイオニアならではの強みがあると考えています。</p> <p>またコンパイル済みバイナリとして提供するにあたってはライセンス形態にも気を配る必要があります。<a href="https://github.com/watermint/toolbox/">watermint toolbox</a>本体はMITライセンスですが、ほかにも様々なライセンスのライブラリをリンクしています。ライブラリを選定するにあたっては相性の良いBSD、Apache v2ライセンスを中心に選定し、GPLは混在しないように気を付けています。</p> <h2 id="あらゆる処理をログに取得してトレーサビリティーを高める">あらゆる処理をログに取得してトレーサビリティーを高める</h2> <p>ユーザーの環境で発生する問題は多くの場合、手元の環境で再現が難しいものです。PC環境の違いもありますし、APIを使う先のDropboxやDropbox Businessの設定・環境・規模が違うケースがあるためです。このため、ログはトレースレベルでのログを全て出力しています。ログサイズはかなり膨れ上がりますが、デバッグのための時間的制約がより優先度が高いためログサイズについては許容しています。また、後述の通りログでディスクを圧迫しないよう現在は圧縮・ログローテーションを実施しています。</p> <p>またログを解析しやすいよう現バージョンではすべてJSON形式(正確には<a href="http://jsonlines.org/">JSON Lines</a>形式)でログ出力しています。grepやjqといったコマンドを組み合わせることでエラーやメモリ利用統計などを抽出しやすくするためです。</p> <p>たとえば、次のように最後に実行したコマンドのログを取得し、その結果をjqで加工すれば時刻ごとのヒープの利用統計を取得できます。ユーザー環境ではメモリプロファイラなど詳細なデータ取得が難しいため、このような統計取得は原因の特定に役立ちます。</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% tbx job log last -kind toolbox -quiet | jq -r 'select(.caller == "es_memory/stats.go:33") | [.time, .HeapAlloc] | @csv'
"2020-07-23T12:34:08.549+0900",104991184
"2020-07-23T12:34:13.548+0900",105058744
"2020-07-23T12:34:18.550+0900",111987752
</code></pre></div></div> <h2 id="cpu時間よりも開発生産性を優先する">CPU時間よりも開発生産性を優先する</h2> <p><a href="https://github.com/watermint/toolbox/">watermint toolbox</a>は主にAPI呼び出しし、その結果を加工して出力するだけのプログラムです。実行時間は相対的にAPI処理待ち時間が多く、CPU時間の比率は高くなくほとんど無視できます。このため、プログラミングスタイルもそれに準じた格好にこの4年で変化してきました。</p> <p>一番おおきな変化はScalaを一時期使っていたこともあり関数型・イミュータブルな実装を少しずつ目指そうとしているところです。この試みはすでにある程度失敗しているのですが、失敗談は後述するとしてまず細かな考え方の変遷から。</p> <p>どこで読んだのかは失念しましたが、Goの考え方として関数などに処理の複雑性を隠さないようにすべきと書かれていたと思います。たとえば、何かの構造体のフィールドの合計を取る処理が必要なとき、今までの経験では普通にそれらを再利用・テストしやすいよう関数として切り出すことを考えます。まあ、そんなに難しいことではありません。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">File</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Name</span> <span class="kt">string</span>
  <span class="n">Size</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TotalSize</span><span class="p">(</span><span class="n">files</span> <span class="p">[]</span><span class="n">File</span><span class="p">)</span> <span class="p">(</span><span class="n">total</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">file</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">files</span> <span class="p">{</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">file</span><span class="o">.</span><span class="n">Size</span>
  <span class="p">}</span>
  <span class="k">return</span>
<span class="p">}</span>
</code></pre></div></div> <p>これはこれで動作しますし全く問題ないのですが、前掲の主張では<code class="highlighter-rouge">TotalSize()</code>を呼び出す際O(N)の処理なのか、O(N^2)の処理なのかわからないがどのぐらいの処理オーダーが背後に隠れているか呼び出し側では区別できないからこういった簡単な処理はインライン化すべきである。といったような主張だったとおもいます。もはやGo入門初期に間違えてみた迷信だったのかもしれません。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">File</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Name</span> <span class="kt">string</span>
  <span class="n">Size</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">MyBizLogic</span><span class="p">()</span> <span class="p">{</span>
  <span class="c">// ...</span>
  
  <span class="k">var</span> <span class="n">folder1Total</span> <span class="kt">int</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">file</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">folder1Files</span> <span class="p">{</span>
    <span class="n">folder1Total</span> <span class="o">+=</span> <span class="n">file</span><span class="o">.</span><span class="n">Size</span>
  <span class="p">}</span>
  
  <span class="c">// ...</span>
  
  <span class="k">var</span> <span class="n">folder2Total</span> <span class="kt">int</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">file</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">folder2Files</span> <span class="p">{</span>
    <span class="n">folder2Total</span> <span class="o">+=</span> <span class="n">file</span><span class="o">.</span><span class="n">Size</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>当然ながらコードの可読性が下がりますし、ミスタイプやテストカバレッジ不足で生産性は著しく低下しました。もし本当に処理オーダーを気にしたいのであれば、関数名にハンガリアンネーミングで<code class="highlighter-rouge">ONLOGNTotal()</code>とか<code class="highlighter-rouge">ON2Total()</code>のように命名した方がよほど効果的でしょう。完全に迷信でした。</p> <p>さて、この考え方が迷信であることが自分の中で確定したところで(確定するまでに2年ぐらいかかりました…)、ScalaやRubyなどいつもやっているような配列、ハッシュ操作を同じようにやりたいという欲求にかられるのは自然なことです。配列Aと配列Bに共通する要素だけ抽出したり、前掲の合計値のような処理もプログラムの性質上それなりに多く扱いますのでこういった処理の効率化は大きな改善につながります。</p> <p>いくつか既存ライブラリを調べましたが<a href="https://github.com/thoas/go-funk">go-funk</a>というプロジェクトが興味深く参考にしていくことにしました。go-funkではリフレクションをフル活用して可読性・生産性向上を目在しています。プロジェクト紹介の<a href="https://github.com/thoas/go-funk#performance">Performance</a>にもある通り、<code class="highlighter-rouge">ContainsInt()</code>のように型ごとに関数を用意したりはしないという方向性からもその目標がよくわかります。</p> <p>go-funkを使おうかと思いましたが、Go言語の練習のためということで自作することにしました。出来上がったのは<a href="https://github.com/watermint/toolbox/tree/71.4.504/essentials/collections">次のようなライブラリ</a>です。 たとえば配列を<code class="highlighter-rouge">a</code>、<code class="highlighter-rouge">b</code>と定義して、共通する要素を取り出すというシンプルな関数が実装が出来上がりました。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">:=</span> <span class="n">es_array</span><span class="o">.</span><span class="n">NewByInterface</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
<span class="n">b</span> <span class="o">:=</span> <span class="n">es_array</span><span class="o">.</span><span class="n">NewByInterface</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">)</span>
<span class="n">c</span> <span class="o">:=</span> <span class="n">a</span><span class="o">.</span><span class="n">Intersection</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="c">// -&gt; [2, 3]</span>
</code></pre></div></div> <p>これである程度イミュータブルかつ関数型的にかけるライブラリが作れるかと思ったのですが、前述の「この試みはすでにある程度失敗」との通り言語仕様上の壁にぶつかりました。問題は型情報です。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">folder1Files</span><span class="p">,</span> <span class="n">folder2Files</span> <span class="p">[]</span><span class="n">File</span>

<span class="c">// ... folder1Files, folder2Files の取得</span>

<span class="c">// 配列からライブラリで使う配列インタフェースに変換</span>
<span class="n">folder1List</span> <span class="o">:=</span> <span class="n">es_array</span><span class="o">.</span><span class="n">NewByInterface</span><span class="p">(</span><span class="n">folder1Files</span><span class="o">...</span><span class="p">)</span>
<span class="n">folder2List</span> <span class="o">:=</span> <span class="n">es_array</span><span class="o">.</span><span class="n">NewByInterface</span><span class="p">(</span><span class="n">folder2Files</span><span class="o">...</span><span class="p">)</span>

<span class="c">// folder1, folder2に共通するファイルを抽出</span>
<span class="n">commonFiles</span> <span class="o">:=</span> <span class="n">folder1List</span><span class="o">.</span><span class="n">Intersection</span><span class="p">(</span><span class="n">folder2List</span><span class="p">)</span>
</code></pre></div></div> <p>さてここまではある程度動作するのですが、問題はこの結果得られる要素それぞれを扱うときに毎回キャストが必要となるところです。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">commonFiles</span><span class="o">.</span><span class="n">Each</span><span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="n">v</span> <span class="n">es_value</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">f</span> <span class="o">:=</span> <span class="n">v</span><span class="o">.</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>
  <span class="c">// 要素に対する処理</span>
<span class="p">})</span>
</code></pre></div></div> <p>まあ問題ないと言えば問題ないのですが、ライブラリを使うことである程度効率化できる一方実行時の型例外が発生する可能性が増えてしまいました。JavaやScalaなど強い型あるいは型変数がある言語での解消は簡単ですが、Goのように弱い型の言語ではこの解決は難しいでしょう。</p> <p>標準ライブラリの<code class="highlighter-rouge">sort.Strings()</code>のように型ごとの配列を渡して処理する方式にすると型に関するエラーは減少します。一方で、これが通用するのは配列の要素数が変わらない時だけで前掲の2つの配列から共通要素を取り出したり、配列を結合したりするケースには使えません。</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>menu := []string{"そば", "うどん", "ラーメン"}
sort.Strings(menu) // 配列サイズは処理前後で変わらない
</code></pre></div></div> <p>今のところは単体テストで問題をカバーしつつこのライブラリを全面的に使っていく方向で考えていますが、またいいアイデアがあればぜひ取り込んでいきたいと思っています。</p> <h2 id="国際化対応-日本語と英語">国際化対応 (日本語と英語)</h2> <p><a href="https://github.com/watermint/toolbox/">watermint toolbox</a>は海外ユーザーにも多く使っていただいていますが、日本のユーザーにも使っていただいています。当初は英語のみ対応していましたが、昨年より日本語にも対応しました。</p> <p><img src="/images/2020-07-22-omegat.png" alt="OmegaT"/></p> <p>翻訳メモリソフトウエアは<a href="https://omegat.org/">OmegaT</a>を使っています。OmegaTにJSONデータ形式対応プラグインを導入して利用しています。</p> <p>国際化のためのライブラリもたくさんありますが、あまり深く考えずに自作しています。JSONにメッセージのキーと翻訳テキストを格納し、表示用メッセージを言語によって切り替えています。</p> <p>今思えば<a href="https://github.com/nicksnyder/go-i18n/">go-i18n</a>あたりを使っても良かったかもしれません。go-i18nではCLDRを使っているようで複数形など言語ごとの差分をより細かく吸収できるようです。いずれライブラリを切り替えるなど試してみる価値はありそうです。幸い、国際化については現状あまり深い実装をしていないため切り替えコストはさほど高くないと考えています。</p> <h2 id="時短のためにドキュメントは基本的に自動生成">時短のためにドキュメントは基本的に自動生成</h2> <p>個人プロジェクトとして比較的負担に感じる部分は一番面倒な部分はドキュメントの作成です。最初のドキュメント作成も手間がかかりますが仕様変更の際にドキュメント更新などメンテナンスもそれなりに時間がかかります。</p> <p>このため、<a href="https://github.com/watermint/toolbox/">watermint toolbox</a>ではマニュアル類などドキュメントは可能な限り自動生成しています。解説が不足が生じている部分はありますが、網羅的にドキュメントが更新できることは大きなメリットです。翻訳テキストさえ準備すれば同じ形式のマニュアルを複数言語に対して準備することも難しくありません。</p> <p>ただ一口に自動生成といってもいくつか段階を分けて対応が必要でした。コマンドの仕様をプログラム上のデータとして取り扱うこと、メッセージをソースコードから抽出すること、不足メッセージの検出とレポート、<a href="https://github.com/watermint/toolbox/blob/71.4.504/doc/generated_ja/changes.md">リリースノート向けの更新差分文章生成</a>、リリースプロセスへの検査の組み込みなどをへて現在はある程度読めるマニュアル類が自動生成できるようになりました。</p> <p>コマンド仕様がデータとして取り扱えるようになったことは嬉しい副作用もありました。コマンド仕様はリリースごとにJSON形式で格納しているのですが、このJSONを使ってたとえば、CSVファイルを引数にとるコマンドの一覧を抽出といった操作が簡単になりました。</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% gzcat doc/generated/spec.json.gz | jq -r '.[] | select(.feeds | length &gt; 0) | .path'
file dispatch local
file import batch url
group batch delete
member clear externalid
member delete
member detach
member invite
member quota update
member replication
member update email
member update externalid
member update profile
team activity batch user
team device unlink
team filerequest clone
teamfolder batch archive
teamfolder batch permdelete
teamfolder batch replication
</code></pre></div></div> <h2 id="ログファイルや中間ファイルでディスクを圧迫しすぎないこと">ログファイルや中間ファイルでディスクを圧迫しすぎないこと</h2> <p>デバッグ作業効率を向上させるため、ログ出力部分には比較的多くの時間を費やしました。一方で、大きなフォルダやチームに対する操作は実行時間も長くなりログサイズも無視できない大きさになりました。ときに100GBを超えることもあります。このため、最近のリリースではログをgzip圧縮の上分割して、一定容量を超えた場合に古いログは削除するような仕組みを取り入れています。</p> <p>また、古いログから順番に削除すると起動時のパラメータなど重要なデータが失われる場合があるのでそれらのデータは別のログに出力するなどの工夫も必要でした。</p> <p>ログの圧縮やローテーション処理の実装自体はさほど難易度がたかくありませんでしたが、Windows上での安定性を向上させることには多くの時間を費やしました。マルチスレッド環境下でのデッドロックが原因です。ミューテクスのデッドロックが発生したり、I/O処理待ちがやはりデッドロックするなどいくつかの問題がありました。再現頻度は1〜数時間に1度程度で修正と修正の確認はなかなかの難易度でした。</p> <p>今もすべての条件に対して耐久性があるとは考えていませんが、確率の高いデッドロックは概ね解消していると考えています。なおデバッガ接続中に再現したデッドロックが発生箇所は概ね次のようなコードでした。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">LogWriter</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span>
  <span class="n">m</span> <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span><span class="n">LogWriter</span><span class="p">)</span> <span class="n">Write</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">z</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
  <span class="k">defer</span> <span class="n">z</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
  
  <span class="k">return</span> <span class="n">z</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>確かに、<code class="highlighter-rouge">w</code>に対する<code class="highlighter-rouge">Write()</code>自体が何らかOSからロックされているとデッドロックされる可能性があります。詳しく仕様の調査はしていませんが、おそらくWindows上ではI/Oロックがより厳密であるためでしょう。</p> <p>ブラックボックステスト的にわかることは、PowerShellなどコンソール上で何かテキストを選択するとスクロールがロックされ標準出力が停止します。これに従い、プログラム側も標準出力を待っていますのでプログラムが一時停止したようになります。macOSやLinuxではこのようなロックは発生しません。また同様の課題が発生した際には詳しく調査してみたいと思っています。</p> <h2 id="メモリの消費を概ね数百mb程度に抑えること">メモリの消費を概ね数百MB程度に抑えること</h2> <p>外部ライブラリを使うとメモリ消費が予想よりも一気に膨れ上がるケースがあります。現状いくつか大きくメモリをつかうライブラリについては対処策を組み込んでいます。具体的な例をいくつか紹介していきます。</p> <p><a href="https://github.com/watermint/toolbox/">watermint toolbox</a>ではレポートファイル出力フォーマットにCSVやJSONの他にExcelなどが利用するxlsx形式ファイルがあります。</p> <p>xlsx形式は使わずCSVだけでも良いのですが、日本語が含まれるCSV (UTF-8エンコーディング、BOMなし)ではExcelで読み込もうとすると、ExcelはBOMがないためエンコーディングを正しく認識できず文字化けしてしまいます。CSV側にBOMをつけても良いのですが、BOMなしを期待するプログラムでは使い勝手が悪くなってしまいます。このため、カジュアルに使っても文字化けの問題を起こさないためにxlsx形式での出力もサポートするようになりました。</p> <p>さてxlsx形式は<a href="https://en.wikipedia.org/wiki/Office_Open_XML">Office Open XML</a>のうちの一つで今はISO/IEC 29500として標準化されています。xlsx形式のファイルはzip圧縮されたいくつかのファイルの集まりで、メインのデータが含まれるファイルはXML形式で作られています。</p> <p>スプレッドシートをXMLで表現するということは、スプレッドシート全体を一度DOMなどXMLツリーとしてメモリ上に展開する必要があるということです。スプレッドシートの容量が大きくなると比例してメモリを利用します。 このため、レポートとしてXML形式で出力しようとするとレポート行数に従い比例的に秋メモリ容量を食い潰していくことになります。場合によってはこれが原因でOut of memoryエラーとなり処理が停止してしまします。対策として、xlsx形式レポートは一定行数を超えた場合には別ファイルに分割して出力するようにしました。</p> <p><img src="/images/2020-07-22-memory-consumption.png" alt="メモリ利用状況のトレンド"/></p> <p>これ以外にもKVSとして利用している<a href="https://github.com/dgraph-io/badger">Badger</a>もキャッシュのためにデータ件数に応じてメモリを利用するため幾度となくチューニングを繰り返しました。ここでも役に立ったのは、ログファイルからメモリの統計を取得する方法で、パラメータを変えた長時間の測定にも役に立ちました。上図は2つのパラメータ設定でのメモリ消費トレンドを示したものです。</p> <h2 id="耐障害性の向上と実行速度の最適化">耐障害性の向上と、実行速度の最適化</h2> <p>耐障害性向上と実行速度についてはまだ伸び代のある分野です。耐障害性について、API呼び出し時の自動リトライなどはすでに実装済みですが、フレームワーク全体としてのエラー処理については改善の余地があると考えています。</p> <p>Go言語では複数の戻り値を使え、エラー処理のために最後の戻り値として<code class="highlighter-rouge">error</code>を返すデザインが標準的です。<a href="https://github.com/watermint/toolbox/">watermint toolbox</a>はビジネスロジックの中核であるコマンドと、それを支えるフレームワーク部分で構成されています。多くの場合、ビジネスロジック部分ではAPIから返されるエラーを処理しないためエラーが発生してもそのまま上位フレームワークへ返すよう実装しています。</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span><span class="n">List</span><span class="p">)</span> <span class="n">Exec</span><span class="p">(</span><span class="n">c</span> <span class="n">app_control</span><span class="o">.</span><span class="n">Control</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="n">entries</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">sv_files</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">Peer</span><span class="o">.</span><span class="n">Context</span><span class="p">())</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">err</span> <span class="c">// 上位フレームワークへエラーを返す</span>
  <span class="p">}</span>
  <span class="c">// ... 後続の処理</span>
  
  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div> <p>ネットワークIOエラーなどはREST APIフレームワーク側で吸収していますし、これはこれで問題ないのですが、フォルダからファイル一覧を取得する際、ファイルがなければ別の処理をするといったビジネスロジック上必要なエラーなのか、認証エラーなどフレームワーク側で対応するエラーなのかまた判定ロジックを各所で書かなければならない点がいかがなものかと考えています。</p> <p>最終的にまた現在の形に落ち着くかもしれませんが、フレームワークで吸収するものとビジネスロジック側で吸収するものを明示的に書き分けられるような仕組みを作るかもしれません。<a href="https://github.com/mattn/go-try">Try型のような実装の試み</a>もあるようですし、エラーで返す場合と<code class="highlighter-rouge">panic()</code>を使うなど方法があるかもしれません。</p> <p>実行速度の最適化についても改善の余地が大きく残っています。現在のコマンドはファイルのアップロードやフォルダの権限情報取得などある程度処理分散できるものについてはマルチスレッドで実行されるようプログラムしています。Go言語ではgoroutineやチャネルなど並列処理のための環境は整っているのであまり大きく悩まなくても実装できる点が気に入っています。</p> <p>一方で、実行時間が数日以上などある程度長くなる場合にはエラーで停止した際に、また再開ポイントまでたどり着くための処理でオーバーヘッドが大きくなったり、中間ファイルが肥大化したり、進捗がわかりづらいといった課題もあります。このため、そろそろ永続化可能な非同期キューなどを用いた処理フレームワークを導入するなど検討が必要でしょう。</p> <h1 id="まとめ">まとめ</h1> <p>リリースプロセスなどいくつか開発プロセス自体もツールの一部として取り込んだことにより、開発効率は4年前と比べれば格段に向上しています。一方で、Go言語やその取り巻くエコシステムのおかげで気軽に予想だにしなかった高機能な仕様を追加できるようになりました。開発当初はJavaやScala、Rubyのほうが経験値が高かったので苦労する部分もありましたがようやく大体の実装はGoでできるなという感覚が得られてきました。</p> <p>また面白い実装方法を思いついたり、いいライブラリに出会えた際には紹介していきたいと思います。</p> <span class="post-tags"> #<a href="/tags/cli">cli</a> #<a href="/tags/dropbox">dropbox</a> #<a href="/tags/golang">golang</a> #<a href="/tags/toolbox">toolbox</a> #<a href="/tags/watermint toolbox">watermint toolbox</a> </span> </div> </div> <div class="container copyright"> &copy; 2016-2020 Takayuki Okazaki </div> </div> <label for="sidebar-checkbox" class="sidebar-toggle"></label> <script>!function(e){var r=e.querySelector(".sidebar-toggle"),t=e.querySelector("#sidebar"),n=e.querySelector("#sidebar-checkbox");e.addEventListener("click",function(e){var c=e.target;n.checked&&!t.contains(c)&&c!==n&&c!==r&&(n.checked=!1)},!1)}(document);</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-769616-6","auto"),ga("send","pageview");</script> </body> </html>