<!DOCTYPE html> <html> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Disk image file (.dmg) from command line &middot; watermint.org </title> <link rel="stylesheet" href="/public/watermint.css"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/watermint-logo.png"> <link rel="shortcut icon" href="/public/watermint-logo.png"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> </head> <body class="theme-base-09"> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"> <div class="sidebar" id="sidebar"> <div class="sidebar-item"> <p>Travel, camera, photo, and technical things. I work at Dropbox. Thoughts are my own.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/atom.xml">Feed</a> <a class="sidebar-nav-item" href="https://github.com/watermint">Github</a> <a class="sidebar-nav-item" href="https://www.instagram.com/watermint/">Instagram</a> </nav> <div class="sidebar-item"> <p> &copy; 2005-2017 Takayuki Okazaki </p> </div> </div> <div class="wrap"> <div class="masthead"> <div class="container"> <h3 class="masthead-title"> <a href="/" title="Home">watermint.org</a> <small>- Takayuki Okazaki's note</small> </h3> </div> </div> <div class="container content"> <div class="post"> <h1 class="post-title">Disk image file (.dmg) from command line</h1> <span class="post-date"> 14th December 2016</span> <p>I prefer .dmg instaed of zip for archiving project data, etc. <code class="highlighter-rouge">.dmg</code> is handy for refering files, modify contents without extract files to somewhere.</p> <p><code class="highlighter-rouge">.dmg</code> can usable as like USB drive. Disk Utility tool can create/update <code class="highlighter-rouge">.dmg</code> from folder with various options. Options are like encryption, readonly, compression, etc.</p> <p>But if you have tens of folders to archive, it’s better to use command line tools.</p> <h2 id="create-encrypted-dmg-file">Create encrypted <code class="highlighter-rouge">.dmg</code> file</h2> <p><code class="highlighter-rouge">hdiutil</code> is command line version of Disk Utility app. This command can mount/unmount/create/update disk image files. Please see <code class="highlighter-rouge">man hdiutil</code> for more detail.</p> <p>Below script is part of my workflow of archiving project files. I’m using encrypted <code class="highlighter-rouge">.dmg</code> for archive. The script require prepare password file under <code class="highlighter-rouge">$HOME/.dmg-password</code>. Please create and store password for <code class="highlighter-rouge">.dmg</code> without LF.</p> <p>And update permission like <code class="highlighter-rouge">chmod 600 $HOME/.dmg-password</code> to prevent read from other users. This sequence using password and encryption. But it’s not strong enough, reason described below.</p> <div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-lt 2 <span class="o">]</span>; <span class="k">then
  </span><span class="nb">echo</span> <span class="nv">$0</span> SRC_DIR DEST_DIR
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">SRC</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">DST</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">PWD</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/.dmg-password"</span>

<span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$PWD</span> <span class="o">]</span>; <span class="k">then
  </span><span class="nb">echo </span>Disk Image password not found
  <span class="nb">exit </span>2
<span class="k">fi

for </span>t <span class="k">in</span> <span class="s2">"</span><span class="nv">$SRC</span><span class="s2">"</span>/<span class="k">*</span>; <span class="k">do
  if</span> <span class="o">[</span> -d <span class="s2">"</span><span class="nv">$t</span><span class="s2">"</span> <span class="o">]</span>; <span class="k">then
    </span><span class="nb">echo </span>Creating: <span class="nv">$t</span>
    <span class="nv">n</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$t</span><span class="k">)</span>
    cat <span class="nv">$PWD</span> |                <span class="se">\</span>
      hdiutil create          <span class="se">\</span>
        -srcfolder <span class="s2">"</span><span class="nv">$t</span><span class="s2">"</span>       <span class="se">\</span>
        -fs HFS+              <span class="se">\</span>
        -encryption AES-128   <span class="se">\</span>
        -format UDBZ          <span class="se">\</span>
        -stdinpass            <span class="se">\</span>
        <span class="s2">"</span><span class="nv">$DST</span><span class="s2">/</span><span class="nv">$n</span><span class="s2">.dmg"</span>
  <span class="k">fi
done</span>
</code></pre> </div> <h2 id="preset-password-for-dmg-in-key-chain">Preset password for <code class="highlighter-rouge">.dmg</code> in Key Chain</h2> <p>It’s kind of pain in neck entering password for opening <code class="highlighter-rouge">.dmg</code> everytime. If you open <code class="highlighter-rouge">.dmg</code> from Finder.app, the password dialog refuse copy &amp; paste operation.</p> <p><img src="/images/2016-12-13-dmg1.png" alt="Password dialog"/></p> <p>There is option “remember password in my keychain”. Concept is similar to this.</p> <p>The password for disk image is stored in keychain which identified by UUID of <code class="highlighter-rouge">.dmg</code>. The UUID is referable by command like below.</p> <div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>hdiutil isencrypted YOURDISKIMAGE.dmg
</code></pre> </div> <p>Now you can store password through <code class="highlighter-rouge">security</code> command.</p> <div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>security add-generic-password -a <span class="o">(</span>UUID above<span class="o">)</span> -D <span class="s2">"disk image password"</span> -s <span class="o">(</span>YOUR DISK IMAGE<span class="o">)</span>.dmg -w <span class="o">(</span>PASSWORD OF DISK IMAGE<span class="o">)</span>
</code></pre> </div> <p>Unfortunatelly, there are no option like <code class="highlighter-rouge">-stdinpass</code>. So the password must be passed through command line argument. This mean optential leak through <code class="highlighter-rouge">ps</code> command or shell history.</p> <p>By the way, I’m using below script for preset password to disk images.</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-lt 1 <span class="o">]</span>; <span class="k">then
  </span><span class="nb">echo</span> <span class="nv">$0</span> <span class="o">[</span>dmg file]...
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">PWD</span><span class="o">=</span><span class="nv">$HOME</span>/.dmg-password

<span class="k">for </span>FILE <span class="k">in</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>; <span class="k">do
  </span><span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>hdiutil isencrypted <span class="s2">"</span><span class="nv">$FILE</span><span class="s2">"</span> 2&gt;&amp;1 | grep uuid | awk <span class="s1">'{print $2}'</span><span class="k">)</span>
  <span class="nv">BASE</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$FILE</span><span class="k">)</span>

  <span class="nb">echo </span>File: <span class="nv">$BASE</span>
  <span class="nb">echo </span>UUID: <span class="nv">$UUID</span>

  security add-generic-password -a <span class="nv">$UUID</span> -D <span class="s2">"disk image password"</span> -s <span class="nv">$BASE</span> -w <span class="k">$(</span>cat <span class="nv">$PWD</span><span class="k">)</span>
<span class="k">done</span>
</code></pre> </div> <p>When opening <code class="highlighter-rouge">.dmg</code> from Finder, operating system ask authorisation of using password by <code class="highlighter-rouge">diskimages-helper</code>.</p> <p><img src="/images/2016-12-13-dmg2.png" alt="Confirmation dialog"/></p> <p>You can skip this dialog by <code class="highlighter-rouge">-A</code> option of <code class="highlighter-rouge">security</code> command, but this option authorise for all applications. It’s better not use this <code class="highlighter-rouge">-A</code> option for better security.</p> </div> <div class="related"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <a href="/2016/12/31/digital-filing/"> デジタルファイリング - データの整理整頓 <small>- 31st December 2016</small> </a> </li> <li> <a href="/2016/12/15/go-bandwidth-limit-for-multilpe-io/"> Go: 複数のReader/Writerに対する帯域幅制御 <small>- 15th December 2016</small> </a> </li> <li> <a href="/2016/12/13/dmg-and-cli/"> ディスクイメージファイル(.dmg)をコマンドラインから <small>- 13th December 2016</small> </a> </li> </ul> </div> </div> <div class="container copyright"> &copy; 2005-2017 Takayuki Okazaki </div> </div> <label for="sidebar-checkbox" class="sidebar-toggle"></label> <script>!function(e){var c=e.querySelector(".sidebar-toggle"),r=e.querySelector("#sidebar"),t=e.querySelector("#sidebar-checkbox");e.addEventListener("click",function(e){var n=e.target;t.checked&&!r.contains(n)&&n!==t&&n!==c&&(t.checked=!1)},!1)}(document);</script> <script>!function(e,t,a,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=t.createElement(a),o=t.getElementsByTagName(a)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-769616-6","auto"),ga("send","pageview");</script> </body> </html>