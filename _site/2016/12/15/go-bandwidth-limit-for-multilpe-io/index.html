<!DOCTYPE html> <html> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Go: 複数のReader/Writerに対する帯域幅制御 &middot; watermint.org </title> <link rel="stylesheet" href="/public/watermint.css"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/watermint-logo.png"> <link rel="shortcut icon" href="/public/watermint-logo.png"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> </head> <body class="theme-base-09"> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"> <div class="sidebar" id="sidebar"> <div class="sidebar-item"> <p>Travel, camera, photo, and technical things. I work at Dropbox. Thoughts are my own.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/atom.xml">Feed</a> <a class="sidebar-nav-item" href="https://github.com/watermint">Github</a> <a class="sidebar-nav-item" href="https://www.instagram.com/watermint/">Instagram</a> </nav> <div class="sidebar-item"> <p> &copy; 2005-2017 Takayuki Okazaki </p> </div> </div> <div class="wrap"> <div class="masthead"> <div class="container"> <h3 class="masthead-title"> <a href="/" title="Home">watermint.org</a> <small>- Takayuki Okazaki's note</small> </h3> </div> </div> <div class="container content"> <div class="post"> <h1 class="post-title">Go: 複数のReader/Writerに対する帯域幅制御</h1> <span class="post-date"> 15th December 2016</span> <p>ネットワークやディスクへの読み書き処理の際、帯域幅制御をしたい場合があります。低優先度の処理などによって主となるビジネスロジックが阻害されないよう制御するといった目的や、一つのサーバ資源で複数のサービスを提供するときに一つのサービスが資源を消費しすぎないようにしたいといった目的があります。</p> <p>Goでこのような処理を書きたいとき、ざっと調べてみたところ<a href="https://github.com/mxk/go-flowrate">go-flowrate</a>という実装が見つかりました。</p> <div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">f</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data.dat"</span><span class="p">)</span><span class="x">

    </span><span class="c">// 100バイト/秒の帯域幅制御付きのラッパーをつくる</span><span class="x">
    </span><span class="n">f2</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">flowrate</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="x"> </span><span class="m">100</span><span class="p">)</span><span class="x">

    </span><span class="c">// 実際の処理</span><span class="x">
    </span><span class="c">// ...</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre> </div> <p>使い方もシンプルできっちり制御できるのでこれでいいのですが、制御できるのが一つの<code class="highlighter-rouge">io.Reader</code>または<code class="highlighter-rouge">io.Writer</code>のみに対してのみ可能で、複数の<code class="highlighter-rouge">io.Reader</code>や<code class="highlighter-rouge">io.Writer</code>に対しては制御することができません。</p> <p>並列処理が必要なプログラムを書いているとちょっとこれではそのまま使えそうにありません。もう少しほかの選択肢を探してもよいのですが、ちょうどいいGoのプログラミング課題ということで新しく実装してみることにしました。</p> <h1 id="section">出来上がり</h1> <p>まずはでき上がったライブラリを紹介します。<a href="https://github.com/watermint/bwlimit">bwlimit</a>としてGithub上に公開してあります。利用例は次のようなイメージです。</p> <div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="c">// 100バイト/秒に制限</span><span class="x">
    </span><span class="n">bwlimit</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">NewBwlimit</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="x"> </span><span class="no">false</span><span class="p">)</span><span class="x">

    </span><span class="c">// 複数のReader</span><span class="x">
    </span><span class="n">f1</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data1.dat"</span><span class="p">)</span><span class="x">
    </span><span class="n">f2</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"data2.dat"</span><span class="p">)</span><span class="x">

    </span><span class="c">// ラッパーを作成</span><span class="x">
    </span><span class="n">fr1</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">bwlimit</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="x">
    </span><span class="n">fr2</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">bwlimit</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span><span class="x">

    </span><span class="c">// 実際の処理</span><span class="x">
    </span><span class="c">// ...</span><span class="x">

    </span><span class="c">// すべてのReaderがClose()されるかEOFになるまで待機</span><span class="x">
    </span><span class="n">bwlimit</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre> </div> <p>まずは帯域幅制御を制御するオブジェクト(上図では<code class="highlighter-rouge">bwlimit</code>)を作り、さらにそれぞれラッパーを作成します。<code class="highlighter-rouge">NewBwlimit</code>の第二引数は帯域幅制限しているときRead/Write処理を待たせるかどうかです。</p> <p>あとはラッパーを普通の<code class="highlighter-rouge">io.Reader</code>として扱うだけです。並列処理をしていて、すべてのReaderまたはWriterについて処理が完了したかどうか知りたくなったので待機する<code class="highlighter-rouge">Wait()</code>もつくりました。</p> <h1 id="section-1">仕組み</h1> <p>キューを作る方法などいくつか実装方法を検討しましたが最終的にはかなりシンプルな構造になりました。トヨタ生産方式の本を思い出してヒントを得ました。</p> <p><a href="https://ja.wikipedia.org/wiki/%E3%82%BF%E3%82%AF%E3%83%88%E3%82%BF%E3%82%A4%E3%83%A0">タクトタイム</a>という一定時間のリズムを刻んで、各拍子のタイミングで利用可能な帯域を現在有効なReader/Writerで分割して利用するアイデアです。</p> <p>たとえばタクトタイムを1秒間に10回に設定したとします。帯域幅設定を1000バイト/秒にした場合、タクトタイム1回あたりに利用可能な帯域幅は100バイトです。有効なReaderが2つであればこの100バイトをわけあって、50バイトずつの読み取りを許可する枠を設定します。実際に、Reader側が読み取るかどうかはわかりませんが、読み取り可能な上限を制御することでこのような流量制御を行っています。</p> <h1 id="section-2">流量制御と障害防止</h1> <p>あるタクトタイムのときに、読み取りが実際に発生せず50バイト分の枠がまるまるある状態で、次のタクトタイムになったとき読み取り可能枠を50 + 50バイト分にはしないようにしました。流量はこれによってすこし減ってしまいますが、意図しない障害を防ぐためです。</p> <p>読み取り可能枠が溜まりにたまって一気に転送が行われてしまうと、他のサービスへ影響がでることはもちろん、場合によってはルーターなどのバッファサイズを超えるなどして障害が発生することも考えられます。</p> <h1 id="section-3">利用例</h1> <p>また別の記事として各予定ですが、Dropboxへのファイルアップローダーをいま作っています。このファイルアップローダーで並列してファイルのアップロードをする際に、帯域幅制御をつけたかったのがこのライブラリ作成のモチベーションです。</p> </div> <div class="related"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <a href="/2016/12/31/digital-filing/"> デジタルファイリング - データの整理整頓 <small>- 31st December 2016</small> </a> </li> <li> <a href="/2016/12/14/dmg-and-cli-en/"> Disk image file (.dmg) from command line <small>- 14th December 2016</small> </a> </li> <li> <a href="/2016/12/13/dmg-and-cli/"> ディスクイメージファイル(.dmg)をコマンドラインから <small>- 13th December 2016</small> </a> </li> </ul> </div> </div> <div class="container copyright"> &copy; 2005-2017 Takayuki Okazaki </div> </div> <label for="sidebar-checkbox" class="sidebar-toggle"></label> <script>!function(e){var c=e.querySelector(".sidebar-toggle"),r=e.querySelector("#sidebar"),t=e.querySelector("#sidebar-checkbox");e.addEventListener("click",function(e){var n=e.target;t.checked&&!r.contains(n)&&n!==t&&n!==c&&(t.checked=!1)},!1)}(document);</script> <script>!function(e,t,a,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=t.createElement(a),o=t.getElementsByTagName(a)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-769616-6","auto"),ga("send","pageview");</script> </body> </html>