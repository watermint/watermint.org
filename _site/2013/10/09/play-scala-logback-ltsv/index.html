<!DOCTYPE html> <html> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Play 2.2/ScalaでLogbackの設定をLTSVにする &middot; watermint.org </title> <link rel="stylesheet" href="/public/watermint.css"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/watermint-logo.png"> <link rel="shortcut icon" href="/public/watermint-logo.png"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> </head> <body class="theme-base-09"> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"> <div class="sidebar" id="sidebar"> <div class="sidebar-item"> <p>Travel, camera, photo, and technical things. I work at Dropbox. Thoughts are my own.</p> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About</a> <a class="sidebar-nav-item" href="/atom.xml">Feed</a> <a class="sidebar-nav-item" href="https://github.com/watermint">Github</a> <a class="sidebar-nav-item" href="https://www.instagram.com/watermint/">Instagram</a> </nav> <div class="sidebar-item"> <p> &copy; 2005-2017 Takayuki Okazaki </p> </div> </div> <div class="wrap"> <div class="masthead"> <div class="container"> <h3 class="masthead-title"> <a href="/" title="Home">watermint.org</a> <small>- Takayuki Okazaki's note</small> </h3> </div> </div> <div class="container content"> <div class="post"> <h1 class="post-title">Play 2.2/ScalaでLogbackの設定をLTSVにする</h1> <span class="post-date"> 9th October 2013</span> <p>趣味のプログラムを<a href="http://www.playframework.com/documentation/2.2.x/Home">Play Framework 2.2</a>とScalaで書いています。趣味のプログラムなので、ログを監視したりするような事はまず無いのですが、あとからプログラムで読みやすいように<a href="http://ltsv.org/">LTSV (Labeled Tab-separated Values)</a>形式で出力する事にしてみました。</p> <p>ログの設定は、<code class="highlighter-rouge">conf/application-logger.xml</code>というファイルを作っておけば読み込んで適用してくれます。いろいろ試行錯誤した結果次のような設定で落ち着きました。</p> <div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;conversionRule</span> <span class="na">conversionWord=</span><span class="s">"coloredLevel"</span> <span class="na">converterClass=</span><span class="s">"play.api.Logger$ColoredLevel"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"FILE"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.RollingFileAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;file&gt;</span>${application.home}/logs/application.log<span class="nt">&lt;/file&gt;</span>
        <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;fileNamePattern&gt;</span>${application.home}/logs/application.%d{yyyy-MM-dd}.log<span class="nt">&lt;/fileNamePattern&gt;</span>
            <span class="nt">&lt;maxHistory&gt;</span>14<span class="nt">&lt;/maxHistory&gt;</span>
        <span class="nt">&lt;/rollingPolicy&gt;</span>
        <span class="nt">&lt;encoder&gt;</span>
            <span class="nt">&lt;charset&gt;</span>UTF-8<span class="nt">&lt;/charset&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>time:%date{ISO8601}<span class="ni">&amp;#x9;</span>level:%level<span class="ni">&amp;#x9;</span>logger:%logger<span class="ni">&amp;#x9;</span>thread:%thread<span class="ni">&amp;#x9;</span>msg:%replace(%replace(%message){'\n','\\n'}){'\t',' '}<span class="ni">&amp;#x9;</span>exception:%replace(%replace(%xException{5}){'\n','\\n'}){'\t',' '}%n%nopex<span class="nt">&lt;/pattern&gt;</span>
            <span class="nt">&lt;immediateFlush&gt;</span>true<span class="nt">&lt;/immediateFlush&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"STDOUT"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.ConsoleAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;encoder&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>%coloredLevel %logger{15} - %message%n%xException{5}<span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>
    <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"play"</span> <span class="na">level=</span><span class="s">"INFO"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"application"</span> <span class="na">level=</span><span class="s">"INFO"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">"ERROR"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"STDOUT"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"FILE"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/root&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre> </div> <p>STDOUTへの出力はデフォルトのままとしています。ファイル<code class="highlighter-rouge">${application.home}/logs/application.log</code>への書き込みのみLTSVとしています。</p> <p>最初からログローテーションまでは設定しなくても良いのですが、ちょっと作ってみた。というレベルのプログラムでも意外と長期間動かしっぱなしになってしまった。という事もあるので、あらかじめ設定しておく事にしています。</p> <p>ログに含める事ができる情報はLogbackのマニュアルによると<a href="http://logback.qos.ch/manual/layouts.html#conversionWord">Conversion Word</a>で定義されているものが使えるようです。呼び出しもとメソッド名や行番号もとれるようですが、動作速度が犠牲になるようなのでここでは有効にしませんでした。</p> <p>Play framework側のプロパティでapplication.home以外に使えるものはないのか情報を探してみましたが、ソースを見たところ(<a href="https://github.com/playframework/playframework/blob/2.2.x/framework/src/play/src/main/scala/play/api/Logger.scala#L171">Logger.scala</a>) application.home以外は特に定義されていませんでした。</p> </div> <div class="related"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <a href="/2016/12/31/digital-filing/"> デジタルファイリング - データの整理整頓 <small>- 31st December 2016</small> </a> </li> <li> <a href="/2016/12/15/go-bandwidth-limit-for-multilpe-io/"> Go: 複数のReader/Writerに対する帯域幅制御 <small>- 15th December 2016</small> </a> </li> <li> <a href="/2016/12/14/dmg-and-cli-en/"> Disk image file (.dmg) from command line <small>- 14th December 2016</small> </a> </li> </ul> </div> </div> <div class="container copyright"> &copy; 2005-2017 Takayuki Okazaki </div> </div> <label for="sidebar-checkbox" class="sidebar-toggle"></label> <script>!function(e){var c=e.querySelector(".sidebar-toggle"),r=e.querySelector("#sidebar"),t=e.querySelector("#sidebar-checkbox");e.addEventListener("click",function(e){var n=e.target;t.checked&&!r.contains(n)&&n!==t&&n!==c&&(t.checked=!1)},!1)}(document);</script> <script>!function(e,t,a,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=t.createElement(a),o=t.getElementsByTagName(a)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-769616-6","auto"),ga("send","pageview");</script> </body> </html>